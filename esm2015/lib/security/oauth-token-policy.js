/**
 * @fileOverview
 * Defines a base class for retrieving OAuth2 tokens.
 */
import * as dependencies from '@polpware/fe-dependencies';
import { safeParseInt } from '@polpware/fe-utilities';
import { PolicyBase } from './policy-base';
const _ = dependencies.underscore;
const $ = dependencies.jquery;
export function adaptToOAuthToken(data) {
    data = data || {};
    data.expiresIn = data.expiresIn || 0;
    data.createdOn = data.createdOn || 0;
    data.token = data.token || '';
    data.refreshToken = data.refreshToken || '';
    return data;
}
export class OAuthTokenPolicy extends PolicyBase {
    constructor(settings) {
        super(settings);
        this.clientId = settings.clientId;
        this.clientSecret = settings.clientSecret;
        this.scope = settings.scope;
        this.expiresIn = null;
        this.createdOn = null;
        this.refreshToken = '';
        this.response = null;
    }
    /**
     * Feeds the policy with some settings from outside,
     * usually from local storage
     */
    readFrom(settings) {
        this.expiresIn = settings.expiresIn;
        this.createdOn = settings.createdOn;
        this.token = settings.token;
        this.refreshToken = settings.refreshToken;
    }
    /**
     * Returns the data that are persistentable.
     */
    persistent() {
        return {
            expiresIn: this.expiresIn,
            createdOn: this.createdOn,
            token: this.token,
            refreshToken: this.refreshToken
        };
    }
    getParams() {
        return {
            client_id: this.clientId,
            client_secret: this.clientSecret,
            scope: this.scope,
            grant_type: this.grantType
        };
    }
    // TODO: Support progress loading
    getTokenInternal() {
        const params = this.getParams();
        return $.ajax({
            url: this.url,
            data: params,
            method: 'POST'
        }).then((resp) => {
            // Put down the response
            this.response = resp;
            this.createdOn = new Date().getTime();
            this.expiresIn = resp.expires_in;
            this.refreshToken = resp.refreshToken || '';
            resp.scope && (this.scope = resp.scope);
            return (resp.access_token);
        });
    }
    /**
     * Returns if the token is expired or not.
     */
    isExpired() {
        if (!this.token || this.token.length < 1) {
            return true;
        }
        if (!this.createdOn) {
            return true;
        }
        const expiresIn = safeParseInt(this.expiresIn);
        if (expiresIn <= 0) {
            return true;
        }
        const now = new Date();
        const diff = now.getTime() - this.createdOn;
        if (diff < expiresIn * 1000) {
            return false;
        }
        return true;
    }
    /**
     * Applys the token to the given options.
     */
    applyTo(options) {
        options.beforeSend = (xhr) => {
            xhr.setRequestHeader('Authorization', ('Bearer '.concat(this.token)));
        };
    }
    /**
     * Apply security policy to the given options.
     */
    applyToV2(options) {
        options.headers = options.headers || {};
        options.headers = {
            Authorization: 'Bearer '.concat(this.token)
        };
    }
    /**
     * App security policy the given options, used for our customized XHR.
     */
    applyToV3(options) {
        options.requestheaders = options.requestheaders || [];
        options.requestheaders.push({
            key: 'Authorization',
            value: 'Bearer '.concat(this.token)
        });
    }
    /**
     * Resets the token and its assoicated information.
     */
    reset() {
        super.reset();
        this.refreshToken = '';
        this.expiresIn = null;
        this.createdOn = null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGgtdG9rZW4tcG9saWN5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvbHB3YXJlL2ZlLWRhdGEvIiwic291cmNlcyI6WyJsaWIvc2VjdXJpdHkvb2F1dGgtdG9rZW4tcG9saWN5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVILE9BQU8sS0FBSyxZQUFZLE1BQU0sMkJBQTJCLENBQUM7QUFFMUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBTXRELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsTUFBTSxDQUFDLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztBQUNsQyxNQUFNLENBQUMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDO0FBRTlCLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxJQUFJO0lBQ2xDLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ2xCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO0lBQzlCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7SUFFNUMsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxVQUFVO0lBWTVDLFlBQVksUUFBc0M7UUFDOUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRWhCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQztRQUNsQyxJQUFJLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUM7UUFDMUMsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENB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SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTyxDQUFDLE9BQVk7UUFDaEIsT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3pCLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUUsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLE9BQVk7UUFDbEIsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUN4QyxPQUFPLENBQUMsT0FBTyxHQUFHO1lBQ2QsYUFBYSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUM5QyxDQUFDO0lBQ04sQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLE9BQVk7UUFDbEIsT0FBTyxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQztRQUN0RCxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQztZQUN4QixHQUFHLEVBQUUsZUFBZTtZQUNwQixLQUFLLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQ3RDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUs7UUFDRCxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUMxQixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlT3ZlcnZpZXdcbiAqIERlZmluZXMgYSBiYXNlIGNsYXNzIGZvciByZXRyaWV2aW5nIE9BdXRoMiB0b2tlbnMuXG4gKi9cblxuaW1wb3J0ICogYXMgZGVwZW5kZW5jaWVzIGZyb20gJ0Bwb2xwd2FyZS9mZS1kZXBlbmRlbmNpZXMnO1xuXG5pbXBvcnQgeyBzYWZlUGFyc2VJbnQgfSBmcm9tICdAcG9scHdhcmUvZmUtdXRpbGl0aWVzJztcbmltcG9ydCB7XG4gICAgSU9BdXRoVG9rZW5Qb2xpY3lDdG9yT3B0aW9ucyxcbiAgICBJT0F1dGhUb2tlbixcbiAgICBJT0F1dGhQYXJhbXNcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFBvbGljeUJhc2UgfSBmcm9tICcuL3BvbGljeS1iYXNlJztcblxuY29uc3QgXyA9IGRlcGVuZGVuY2llcy51bmRlcnNjb3JlO1xuY29uc3QgJCA9IGRlcGVuZGVuY2llcy5qcXVlcnk7XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGFwdFRvT0F1dGhUb2tlbihkYXRhKTogSU9BdXRoVG9rZW4ge1xuICAgIGRhdGEgPSBkYXRhIHx8IHt9O1xuICAgIGRhdGEuZXhwaXJlc0luID0gZGF0YS5leHBpcmVzSW4gfHwgMDtcbiAgICBkYXRhLmNyZWF0ZWRPbiA9IGRhdGEuY3JlYXRlZE9uIHx8IDA7XG4gICAgZGF0YS50b2tlbiA9IGRhdGEudG9rZW4gfHwgJyc7XG4gICAgZGF0YS5yZWZyZXNoVG9rZW4gPSBkYXRhLnJlZnJlc2hUb2tlbiB8fCAnJztcblxuICAgIHJldHVybiBkYXRhO1xufVxuXG5leHBvcnQgY2xhc3MgT0F1dGhUb2tlblBvbGljeSBleHRlbmRzIFBvbGljeUJhc2Uge1xuXG4gICAgcHJvdGVjdGVkIGNsaWVudElkOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIGNsaWVudFNlY3JldDogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBzY29wZTogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBleHBpcmVzSW46IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgY3JlYXRlZE9uOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIHJlZnJlc2hUb2tlbjogc3RyaW5nO1xuICAgIHB1YmxpYyBncmFudFR5cGU6ICdhdXRob3JpemF0aW9uX2NvZGUnIHwgJ3JlZnJlc2hfdG9rZW4nIHwgJ3Bhc3N3b3JkJyB8ICdjbGllbnRfY3JlZGVudGlhbHMnO1xuXG4gICAgcHVibGljIHJlc3BvbnNlOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3RvcihzZXR0aW5nczogSU9BdXRoVG9rZW5Qb2xpY3lDdG9yT3B0aW9ucykge1xuICAgICAgICBzdXBlcihzZXR0aW5ncyk7XG5cbiAgICAgICAgdGhpcy5jbGllbnRJZCA9IHNldHRpbmdzLmNsaWVudElkO1xuICAgICAgICB0aGlzLmNsaWVudFNlY3JldCA9IHNldHRpbmdzLmNsaWVudFNlY3JldDtcbiAgICAgICAgdGhpcy5zY29wZSA9IHNldHRpbmdzLnNjb3BlO1xuICAgICAgICB0aGlzLmV4cGlyZXNJbiA9IG51bGw7XG4gICAgICAgIHRoaXMuY3JlYXRlZE9uID0gbnVsbDtcbiAgICAgICAgdGhpcy5yZWZyZXNoVG9rZW4gPSAnJztcblxuICAgICAgICB0aGlzLnJlc3BvbnNlID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGZWVkcyB0aGUgcG9saWN5IHdpdGggc29tZSBzZXR0aW5ncyBmcm9tIG91dHNpZGUsXG4gICAgICogdXN1YWxseSBmcm9tIGxvY2FsIHN0b3JhZ2VcbiAgICAgKi9cbiAgICByZWFkRnJvbShzZXR0aW5nczogSU9BdXRoVG9rZW4pIHtcbiAgICAgICAgdGhpcy5leHBpcmVzSW4gPSBzZXR0aW5ncy5leHBpcmVzSW47XG4gICAgICAgIHRoaXMuY3JlYXRlZE9uID0gc2V0dGluZ3MuY3JlYXRlZE9uO1xuICAgICAgICB0aGlzLnRva2VuID0gc2V0dGluZ3MudG9rZW47XG4gICAgICAgIHRoaXMucmVmcmVzaFRva2VuID0gc2V0dGluZ3MucmVmcmVzaFRva2VuO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGRhdGEgdGhhdCBhcmUgcGVyc2lzdGVudGFibGUuXG4gICAgICovXG4gICAgcGVyc2lzdGVudCgpOiBJT0F1dGhUb2tlbiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBleHBpcmVzSW46IHRoaXMuZXhwaXJlc0luLFxuICAgICAgICAgICAgY3JlYXRlZE9uOiB0aGlzLmNyZWF0ZWRPbixcbiAgICAgICAgICAgIHRva2VuOiB0aGlzLnRva2VuLFxuICAgICAgICAgICAgcmVmcmVzaFRva2VuOiB0aGlzLnJlZnJlc2hUb2tlblxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGdldFBhcmFtcygpOiBhbnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxuICAgICAgICAgICAgY2xpZW50X3NlY3JldDogdGhpcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgICBzY29wZTogdGhpcy5zY29wZSxcbiAgICAgICAgICAgIGdyYW50X3R5cGU6IHRoaXMuZ3JhbnRUeXBlXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVE9ETzogU3VwcG9ydCBwcm9ncmVzcyBsb2FkaW5nXG4gICAgZ2V0VG9rZW5JbnRlcm5hbCgpOiBQcm9taXNlTGlrZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gdGhpcy5nZXRQYXJhbXMoKTtcbiAgICAgICAgcmV0dXJuICQuYWpheCh7XG4gICAgICAgICAgICB1cmw6IHRoaXMudXJsLFxuICAgICAgICAgICAgZGF0YTogcGFyYW1zLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCdcbiAgICAgICAgfSkudGhlbigocmVzcCkgPT4ge1xuXG4gICAgICAgICAgICAvLyBQdXQgZG93biB0aGUgcmVzcG9uc2VcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2UgPSByZXNwO1xuXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZWRPbiA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgdGhpcy5leHBpcmVzSW4gPSByZXNwLmV4cGlyZXNfaW47XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbiA9IHJlc3AucmVmcmVzaFRva2VuIHx8ICcnO1xuICAgICAgICAgICAgcmVzcC5zY29wZSAmJiAodGhpcy5zY29wZSA9IHJlc3Auc2NvcGUpO1xuICAgICAgICAgICAgcmV0dXJuIChyZXNwLmFjY2Vzc190b2tlbik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgaWYgdGhlIHRva2VuIGlzIGV4cGlyZWQgb3Igbm90LlxuICAgICAqL1xuICAgIGlzRXhwaXJlZCgpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aGlzLnRva2VuIHx8IHRoaXMudG9rZW4ubGVuZ3RoIDwgMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmNyZWF0ZWRPbikge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZXhwaXJlc0luID0gc2FmZVBhcnNlSW50KHRoaXMuZXhwaXJlc0luKTtcbiAgICAgICAgaWYgKGV4cGlyZXNJbiA8PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBjb25zdCBkaWZmID0gbm93LmdldFRpbWUoKSAtIHRoaXMuY3JlYXRlZE9uO1xuICAgICAgICBpZiAoZGlmZiA8IGV4cGlyZXNJbiAqIDEwMDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBcHBseXMgdGhlIHRva2VuIHRvIHRoZSBnaXZlbiBvcHRpb25zLlxuICAgICAqL1xuICAgIGFwcGx5VG8ob3B0aW9uczogYW55KTogdm9pZCB7XG4gICAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9ICh4aHIpID0+IHtcbiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdBdXRob3JpemF0aW9uJywgKCdCZWFyZXIgJy5jb25jYXQodGhpcy50b2tlbikpKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBcHBseSBzZWN1cml0eSBwb2xpY3kgdG8gdGhlIGdpdmVuIG9wdGlvbnMuXG4gICAgICovXG4gICAgYXBwbHlUb1YyKG9wdGlvbnM6IGFueSk6IHZvaWQge1xuICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnMgfHwge307XG4gICAgICAgIG9wdGlvbnMuaGVhZGVycyA9IHtcbiAgICAgICAgICAgIEF1dGhvcml6YXRpb246ICdCZWFyZXIgJy5jb25jYXQodGhpcy50b2tlbilcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBcHAgc2VjdXJpdHkgcG9saWN5IHRoZSBnaXZlbiBvcHRpb25zLCB1c2VkIGZvciBvdXIgY3VzdG9taXplZCBYSFIuXG4gICAgICovXG4gICAgYXBwbHlUb1YzKG9wdGlvbnM6IGFueSk6IHZvaWQge1xuICAgICAgICBvcHRpb25zLnJlcXVlc3RoZWFkZXJzID0gb3B0aW9ucy5yZXF1ZXN0aGVhZGVycyB8fCBbXTtcbiAgICAgICAgb3B0aW9ucy5yZXF1ZXN0aGVhZGVycy5wdXNoKHtcbiAgICAgICAgICAgIGtleTogJ0F1dGhvcml6YXRpb24nLFxuICAgICAgICAgICAgdmFsdWU6ICdCZWFyZXIgJy5jb25jYXQodGhpcy50b2tlbilcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVzZXRzIHRoZSB0b2tlbiBhbmQgaXRzIGFzc29pY2F0ZWQgaW5mb3JtYXRpb24uXG4gICAgICovXG4gICAgcmVzZXQoKSB7XG4gICAgICAgIHN1cGVyLnJlc2V0KCk7XG4gICAgICAgIHRoaXMucmVmcmVzaFRva2VuID0gJyc7XG4gICAgICAgIHRoaXMuZXhwaXJlc0luID0gbnVsbDtcbiAgICAgICAgdGhpcy5jcmVhdGVkT24gPSBudWxsO1xuICAgIH1cbn1cbiJdfQ==