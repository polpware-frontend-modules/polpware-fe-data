/**
 * @fileOverview
 * Defines a base class for retrieving OAuth2 tokens.
 */
import * as dependencies from '@polpware/fe-dependencies';
import { safeParseInt } from '@polpware/fe-utilities';
import { PolicyBase } from './policy-base';
const _ = dependencies.underscore;
const $ = dependencies.jquery;
export function adaptToOAuthToken(data) {
    data = data || {};
    data.expiresIn = data.expiresIn || 0;
    data.createdOn = data.createdOn || 0;
    data.token = data.token || '';
    data.refreshToken = data.refreshToken || '';
    return data;
}
export class OAuthTokenPolicy extends PolicyBase {
    constructor(settings) {
        super(settings);
        this.clientId = settings.clientId;
        this.clientSecret = settings.clientSecret;
        this.scope = settings.scope;
        this.expiresIn = null;
        this.createdOn = null;
        this.refreshToken = '';
        this.response = null;
    }
    /**
     * Feeds the policy with some settings from outside,
     * usually from local storage
     */
    readFrom(settings) {
        this.expiresIn = settings.expiresIn;
        this.createdOn = settings.createdOn;
        this.token = settings.token;
        this.refreshToken = settings.refreshToken;
    }
    /**
     * Returns the data that are persistentable.
     */
    persistent() {
        return {
            expiresIn: this.expiresIn,
            createdOn: this.createdOn,
            token: this.token,
            refreshToken: this.refreshToken
        };
    }
    getParams() {
        return {
            client_id: this.clientId,
            client_secret: this.clientSecret,
            scope: this.scope,
            grant_type: this.grantType
        };
    }
    // TODO: Support progress loading
    getTokenInternal() {
        const params = this.getParams();
        return $.ajax({
            url: this.url,
            data: params,
            method: 'POST'
        }).then((resp) => {
            // Put down the response
            this.response = resp;
            this.createdOn = new Date().getTime();
            this.expiresIn = resp.expires_in;
            this.refreshToken = resp.refreshToken || '';
            resp.scope && (this.scope = resp.scope);
            return (resp.access_token);
        });
    }
    /**
     * Returns if the token is expired or not.
     */
    isExpired() {
        if (!this.token || this.token.length < 1) {
            return true;
        }
        if (!this.createdOn) {
            return true;
        }
        const expiresIn = safeParseInt(this.expiresIn);
        if (expiresIn <= 0) {
            return true;
        }
        const now = new Date();
        const diff = now.getTime() - this.createdOn;
        if (diff < expiresIn * 1000) {
            return false;
        }
        return true;
    }
    /**
     * Applys the token to the given options.
     */
    applyTo(options) {
        options.beforeSend = (xhr) => {
            xhr.setRequestHeader('Authorization', ('Bearer '.concat(this.token)));
        };
    }
    /**
     * Apply security policy to the given options.
     */
    applyToV2(options) {
        options.headers = options.headers || {};
        options.headers = {
            Authorization: 'Bearer '.concat(this.token)
        };
    }
    /**
     * App security policy the given options, used for our customized XHR.
     */
    applyToV3(options) {
        options.requestheaders = options.requestheaders || [];
        options.requestheaders.push({
            key: 'Authorization',
            value: 'Bearer '.concat(this.token)
        });
    }
    /**
     * Resets the token and its assoicated information.
     */
    reset() {
        super.reset();
        this.refreshToken = '';
        this.expiresIn = null;
        this.createdOn = null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGgtdG9rZW4tcG9saWN5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcG9scHdhcmUvZmUtZGF0YS9zcmMvbGliL3NlY3VyaXR5L29hdXRoLXRva2VuLXBvbGljeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0dBR0c7QUFFSCxPQUFPLEtBQUssWUFBWSxNQUFNLDJCQUEyQixDQUFDO0FBRTFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQU10RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE1BQU0sQ0FBQyxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7QUFDbEMsTUFBTSxDQUFDLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztBQUU5QixNQUFNLFVBQVUsaUJBQWlCLENBQUMsSUFBSTtJQUNsQyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDO0lBQ3JDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUM5QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO0lBRTVDLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsVUFBVTtJQVk1QyxZQUFZLFFBQXNDO1FBQzlDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDbEMsSUFBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDO1FBQzFDLElB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QUNoQjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU8sQ0FBQyxPQUFZO1FBQ2hCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN6QixHQUFHLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFFLENBQUMsQ0FBQztJQUNOLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxPQUFZO1FBQ2xCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDeEMsT0FBTyxDQUFDLE9BQU8sR0FBRztZQUNkLGFBQWEsRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7U0FDOUMsQ0FBQztJQUNOLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxPQUFZO1FBQ2xCLE9BQU8sQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUM7UUFDdEQsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUM7WUFDeEIsR0FBRyxFQUFFLGVBQWU7WUFDcEIsS0FBSyxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0QsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZU92ZXJ2aWV3XG4gKiBEZWZpbmVzIGEgYmFzZSBjbGFzcyBmb3IgcmV0cmlldmluZyBPQXV0aDIgdG9rZW5zLlxuICovXG5cbmltcG9ydCAqIGFzIGRlcGVuZGVuY2llcyBmcm9tICdAcG9scHdhcmUvZmUtZGVwZW5kZW5jaWVzJztcblxuaW1wb3J0IHsgc2FmZVBhcnNlSW50IH0gZnJvbSAnQHBvbHB3YXJlL2ZlLXV0aWxpdGllcyc7XG5pbXBvcnQge1xuICAgIElPQXV0aFRva2VuUG9saWN5Q3Rvck9wdGlvbnMsXG4gICAgSU9BdXRoVG9rZW4sXG4gICAgSU9BdXRoUGFyYW1zXG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBQb2xpY3lCYXNlIH0gZnJvbSAnLi9wb2xpY3ktYmFzZSc7XG5cbmNvbnN0IF8gPSBkZXBlbmRlbmNpZXMudW5kZXJzY29yZTtcbmNvbnN0ICQgPSBkZXBlbmRlbmNpZXMuanF1ZXJ5O1xuXG5leHBvcnQgZnVuY3Rpb24gYWRhcHRUb09BdXRoVG9rZW4oZGF0YSk6IElPQXV0aFRva2VuIHtcbiAgICBkYXRhID0gZGF0YSB8fCB7fTtcbiAgICBkYXRhLmV4cGlyZXNJbiA9IGRhdGEuZXhwaXJlc0luIHx8IDA7XG4gICAgZGF0YS5jcmVhdGVkT24gPSBkYXRhLmNyZWF0ZWRPbiB8fCAwO1xuICAgIGRhdGEudG9rZW4gPSBkYXRhLnRva2VuIHx8ICcnO1xuICAgIGRhdGEucmVmcmVzaFRva2VuID0gZGF0YS5yZWZyZXNoVG9rZW4gfHwgJyc7XG5cbiAgICByZXR1cm4gZGF0YTtcbn1cblxuZXhwb3J0IGNsYXNzIE9BdXRoVG9rZW5Qb2xpY3kgZXh0ZW5kcyBQb2xpY3lCYXNlIHtcblxuICAgIHByb3RlY3RlZCBjbGllbnRJZDogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBjbGllbnRTZWNyZXQ6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgc2NvcGU6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgZXhwaXJlc0luOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIGNyZWF0ZWRPbjogbnVtYmVyO1xuICAgIHByb3RlY3RlZCByZWZyZXNoVG9rZW46IHN0cmluZztcbiAgICBwdWJsaWMgZ3JhbnRUeXBlOiAnYXV0aG9yaXphdGlvbl9jb2RlJyB8ICdyZWZyZXNoX3Rva2VuJyB8ICdwYXNzd29yZCcgfCAnY2xpZW50X2NyZWRlbnRpYWxzJztcblxuICAgIHB1YmxpYyByZXNwb25zZTogYW55O1xuXG4gICAgY29uc3RydWN0b3Ioc2V0dGluZ3M6IElPQXV0aFRva2VuUG9saWN5Q3Rvck9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIoc2V0dGluZ3MpO1xuXG4gICAgICAgIHRoaXMuY2xpZW50SWQgPSBzZXR0aW5ncy5jbGllbnRJZDtcbiAgICAgICAgdGhpcy5jbGllbnRTZWNyZXQgPSBzZXR0aW5ncy5jbGllbnRTZWNyZXQ7XG4gICAgICAgIHRoaXMuc2NvcGUgPSBzZXR0aW5ncy5zY29wZTtcbiAgICAgICAgdGhpcy5leHBpcmVzSW4gPSBudWxsO1xuICAgICAgICB0aGlzLmNyZWF0ZWRPbiA9IG51bGw7XG4gICAgICAgIHRoaXMucmVmcmVzaFRva2VuID0gJyc7XG5cbiAgICAgICAgdGhpcy5yZXNwb25zZSA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmVlZHMgdGhlIHBvbGljeSB3aXRoIHNvbWUgc2V0dGluZ3MgZnJvbSBvdXRzaWRlLFxuICAgICAqIHVzdWFsbHkgZnJvbSBsb2NhbCBzdG9yYWdlXG4gICAgICovXG4gICAgcmVhZEZyb20oc2V0dGluZ3M6IElPQXV0aFRva2VuKSB7XG4gICAgICAgIHRoaXMuZXhwaXJlc0luID0gc2V0dGluZ3MuZXhwaXJlc0luO1xuICAgICAgICB0aGlzLmNyZWF0ZWRPbiA9IHNldHRpbmdzLmNyZWF0ZWRPbjtcbiAgICAgICAgdGhpcy50b2tlbiA9IHNldHRpbmdzLnRva2VuO1xuICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbiA9IHNldHRpbmdzLnJlZnJlc2hUb2tlbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBkYXRhIHRoYXQgYXJlIHBlcnNpc3RlbnRhYmxlLlxuICAgICAqL1xuICAgIHBlcnNpc3RlbnQoKTogSU9BdXRoVG9rZW4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZXhwaXJlc0luOiB0aGlzLmV4cGlyZXNJbixcbiAgICAgICAgICAgIGNyZWF0ZWRPbjogdGhpcy5jcmVhdGVkT24sXG4gICAgICAgICAgICB0b2tlbjogdGhpcy50b2tlbixcbiAgICAgICAgICAgIHJlZnJlc2hUb2tlbjogdGhpcy5yZWZyZXNoVG9rZW5cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRQYXJhbXMoKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCxcbiAgICAgICAgICAgIGNsaWVudF9zZWNyZXQ6IHRoaXMuY2xpZW50U2VjcmV0LFxuICAgICAgICAgICAgc2NvcGU6IHRoaXMuc2NvcGUsXG4gICAgICAgICAgICBncmFudF90eXBlOiB0aGlzLmdyYW50VHlwZVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8vIFRPRE86IFN1cHBvcnQgcHJvZ3Jlc3MgbG9hZGluZ1xuICAgIGdldFRva2VuSW50ZXJuYWwoKTogUHJvbWlzZUxpa2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKCk7XG4gICAgICAgIHJldHVybiAkLmFqYXgoe1xuICAgICAgICAgICAgdXJsOiB0aGlzLnVybCxcbiAgICAgICAgICAgIGRhdGE6IHBhcmFtcyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnXG4gICAgICAgIH0pLnRoZW4oKHJlc3ApID0+IHtcblxuICAgICAgICAgICAgLy8gUHV0IGRvd24gdGhlIHJlc3BvbnNlXG4gICAgICAgICAgICB0aGlzLnJlc3BvbnNlID0gcmVzcDtcblxuICAgICAgICAgICAgdGhpcy5jcmVhdGVkT24gPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIHRoaXMuZXhwaXJlc0luID0gcmVzcC5leHBpcmVzX2luO1xuICAgICAgICAgICAgdGhpcy5yZWZyZXNoVG9rZW4gPSByZXNwLnJlZnJlc2hUb2tlbiB8fCAnJztcbiAgICAgICAgICAgIHJlc3Auc2NvcGUgJiYgKHRoaXMuc2NvcGUgPSByZXNwLnNjb3BlKTtcbiAgICAgICAgICAgIHJldHVybiAocmVzcC5hY2Nlc3NfdG9rZW4pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGlmIHRoZSB0b2tlbiBpcyBleHBpcmVkIG9yIG5vdC5cbiAgICAgKi9cbiAgICBpc0V4cGlyZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghdGhpcy50b2tlbiB8fCB0aGlzLnRva2VuLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5jcmVhdGVkT24pIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGV4cGlyZXNJbiA9IHNhZmVQYXJzZUludCh0aGlzLmV4cGlyZXNJbik7XG4gICAgICAgIGlmIChleHBpcmVzSW4gPD0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29uc3QgZGlmZiA9IG5vdy5nZXRUaW1lKCkgLSB0aGlzLmNyZWF0ZWRPbjtcbiAgICAgICAgaWYgKGRpZmYgPCBleHBpcmVzSW4gKiAxMDAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwbHlzIHRoZSB0b2tlbiB0byB0aGUgZ2l2ZW4gb3B0aW9ucy5cbiAgICAgKi9cbiAgICBhcHBseVRvKG9wdGlvbnM6IGFueSk6IHZvaWQge1xuICAgICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSAoeGhyKSA9PiB7XG4gICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQXV0aG9yaXphdGlvbicsICgnQmVhcmVyICcuY29uY2F0KHRoaXMudG9rZW4pKSk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwbHkgc2VjdXJpdHkgcG9saWN5IHRvIHRoZSBnaXZlbiBvcHRpb25zLlxuICAgICAqL1xuICAgIGFwcGx5VG9WMihvcHRpb25zOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgb3B0aW9ucy5oZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzIHx8IHt9O1xuICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSB7XG4gICAgICAgICAgICBBdXRob3JpemF0aW9uOiAnQmVhcmVyICcuY29uY2F0KHRoaXMudG9rZW4pXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwIHNlY3VyaXR5IHBvbGljeSB0aGUgZ2l2ZW4gb3B0aW9ucywgdXNlZCBmb3Igb3VyIGN1c3RvbWl6ZWQgWEhSLlxuICAgICAqL1xuICAgIGFwcGx5VG9WMyhvcHRpb25zOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgb3B0aW9ucy5yZXF1ZXN0aGVhZGVycyA9IG9wdGlvbnMucmVxdWVzdGhlYWRlcnMgfHwgW107XG4gICAgICAgIG9wdGlvbnMucmVxdWVzdGhlYWRlcnMucHVzaCh7XG4gICAgICAgICAgICBrZXk6ICdBdXRob3JpemF0aW9uJyxcbiAgICAgICAgICAgIHZhbHVlOiAnQmVhcmVyICcuY29uY2F0KHRoaXMudG9rZW4pXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc2V0cyB0aGUgdG9rZW4gYW5kIGl0cyBhc3NvaWNhdGVkIGluZm9ybWF0aW9uLlxuICAgICAqL1xuICAgIHJlc2V0KCkge1xuICAgICAgICBzdXBlci5yZXNldCgpO1xuICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbiA9ICcnO1xuICAgICAgICB0aGlzLmV4cGlyZXNJbiA9IG51bGw7XG4gICAgICAgIHRoaXMuY3JlYXRlZE9uID0gbnVsbDtcbiAgICB9XG59XG4iXX0=