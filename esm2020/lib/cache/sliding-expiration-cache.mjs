//
// Author:: Tom Tang <polpware@gmail.com>
// Copyright:: Copyright (c) 2017, Xiaolong Tang
//
// Permission is hereby granted, free of charge, to any person obtaining
// a copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to
// permit persons to whom the Software is furnished to do so, subject to
// the following conditions:
//
// The above copyright notice and this permission notice shall be
// included in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
// Except as contained in this notice, the name(s) of the above copyright
// holders shall not be used in advertising or otherwise to promote the
// sale, use or other dealings in this Software without prior written
// authorization.
import { __decorate } from "tslib";
import * as dependencies from '@polpware/fe-dependencies';
import { MemoryBackend } from './memory-backend';
import { observableDecorator } from '../decorators/observable.decorator';
const locache = dependencies.locache;
const meld = dependencies.meld;
const originalRemove = Object.getPrototypeOf(locache.locache).remove;
const currentTime = function () {
    return new Date().getTime();
};
let SlidingExpirationCache = class SlidingExpirationCache {
    constructor(_defaultSeconds, scheduleInterval, ngZone) {
        this._defaultSeconds = _defaultSeconds;
        const backend = new MemoryBackend();
        this._cache = locache.locache.createCache({ storage: backend });
        this._cache.remove = meld.around(originalRemove, (input) => {
            const key = input.args[0];
            const onExpireEvtName = this.onExpireEventName(key);
            const event = this.asObservable.fire(onExpireEvtName, {});
            // if the event is stopped, then stop doing it
            // more time is required ...
            if (event.isDefaultPrevented()) {
                this.resetExpireKey(key, this._defaultSeconds);
                return false;
            }
            // Otherwise, continue the original logic
            // Remove all listener
            this.asObservable.off(onExpireEvtName, null);
            input.proceed();
            // fire event
            const afterRemoveEvtName = this.afterRemoveEventName(key);
            this.asObservable.fire(afterRemoveEvtName, {});
            return true;
        });
        // interval
        if (scheduleInterval) {
            if (ngZone) {
                ngZone.runOutsideAngular(() => {
                    this._timeInterval = setInterval(() => {
                        this._cache.cleanup();
                    }, scheduleInterval * 1000);
                });
            }
            else {
                this._timeInterval = setInterval(() => {
                    this._cache.cleanup();
                }, scheduleInterval * 1000);
            }
        }
        else {
            this._timeInterval = null;
        }
    }
    onExpireEventName(key) {
        return 'onExpire:' + key;
    }
    afterRemoveEventName(key) {
        return 'afterRemove:' + key;
    }
    resetExpireKey(key, seconds) {
        const expirekey = this._cache.expirekey(key);
        const ms = seconds * 1000;
        this._cache.storage.set(expirekey, currentTime() + ms);
    }
    get asObservable() {
        const self = this;
        const observable = self;
        return observable;
    }
    // Given a key, a value and an optional number of seconds store the value
    // in the storage backend.
    set(key, value, seconds, afterRemoveCallback) {
        const expirekey = this._cache.expirekey(key);
        const valueKey = this._cache.key(key);
        if (seconds) {
            // The time stored is in milliseconds, but this function expects
            // seconds, so multiply by 1000.
            const ms = seconds * 1000;
            this._cache.storage.set(expirekey, currentTime() + ms);
        }
        else {
            // Remove the expire key, if no timeout is set
            this._cache.storage.remove(expirekey);
        }
        if (afterRemoveCallback) {
            this.asObservable.once(this.afterRemoveEventName(key), afterRemoveCallback);
        }
        return this._cache.storage.set(valueKey, value);
    }
    // Fetch a value from the cache. Either returns the value, or if it
    // doesn't exist (or has expired) return null.
    get(key, seconds) {
        // If the value has expired, before returning null remove the key
        // from the storage backend to free up the space.
        if (this._cache.hasExpired(key)) {
            if (this._cache.remove(key)) {
                return null;
            }
        }
        const valueKey = this._cache.key(key);
        const value = this._cache.storage.get(valueKey);
        // Slide the expire ke
        if (value) {
            this.resetExpireKey(key, seconds || this._defaultSeconds);
        }
        // If value isn't truthy, it must be an empty string or similar, so
        // just return that.
        return value;
    }
    invalidate(key) {
        let keys = this._cache.keys() || [];
        keys = keys.filter(a => a.indexOf(key) !== -1);
        this.resetInternal(keys);
    }
    rmOnExpireHandler(key, callback) {
        this.asObservable.off(this.onExpireEventName(key), callback);
    }
    addOnExpireHandler(key, callback) {
        this.asObservable.on(this.onExpireEventName(key), callback);
    }
    get count() {
        return this._cache.length();
    }
    reset() {
        const keys = this._cache.keys() || [];
        this.resetInternal(keys);
    }
    resetInternal(keys) {
        keys.forEach((k) => {
            this.asObservable.off(this.onExpireEventName(k), null);
            originalRemove.call(this._cache, k);
            this.asObservable.fire(this.afterRemoveEventName(k), {});
        });
    }
    // must destory, or leaking ...
    destroy() {
        this.reset();
        if (this._timeInterval) {
            clearInterval(this._timeInterval);
        }
    }
};
SlidingExpirationCache = __decorate([
    observableDecorator
], SlidingExpirationCache);
export { SlidingExpirationCache };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xpZGluZy1leHBpcmF0aW9uLWNhY2hlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcG9scHdhcmUvZmUtZGF0YS9zcmMvbGliL2NhY2hlL3NsaWRpbmctZXhwaXJhdGlvbi1jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxFQUFFO0FBQ0YseUNBQXlDO0FBQ3pDLGdEQUFnRDtBQUNoRCxFQUFFO0FBQ0Ysd0VBQXdFO0FBQ3hFLGtFQUFrRTtBQUNsRSxzRUFBc0U7QUFDdEUsc0VBQXNFO0FBQ3RFLHFFQUFxRTtBQUNyRSx3RUFBd0U7QUFDeEUsNEJBQTRCO0FBQzVCLEVBQUU7QUFDRixpRUFBaUU7QUFDakUsa0VBQWtFO0FBQ2xFLEVBQUU7QUFDRixrRUFBa0U7QUFDbEUscUVBQXFFO0FBQ3JFLHdEQUF3RDtBQUN4RCx5RUFBeUU7QUFDekUseUVBQXlFO0FBQ3pFLHdFQUF3RTtBQUN4RSxrRUFBa0U7QUFDbEUsRUFBRTtBQUNGLHlFQUF5RTtBQUN6RSx1RUFBdUU7QUFDdkUscUVBQXFFO0FBQ3JFLGlCQUFpQjs7QUFFakIsT0FBTyxLQUFLLFlBQVksTUFBTSwyQkFBMkIsQ0FBQztBQUUxRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFTekUsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQztBQUNyQyxNQUFNLElBQUksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO0FBRS9CLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUVyRSxNQUFNLFdBQVcsR0FBRztJQUNoQixPQUFPLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEMsQ0FBQyxDQUFDO0FBR0YsSUFB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QUM7SUFFRCxJQUFXLEtBQUs7UUFDWixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVELEtBQUs7UUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTyxhQUFhLENBQUMsSUFBYztRQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDZixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkQsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCwrQkFBK0I7SUFDL0IsT0FBTztRQUNILElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUViLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNwQixhQUFhLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ3JDO0lBQ0wsQ0FBQztDQUNKLENBQUE7QUFsS1ksc0JBQXNCO0lBRGxDLG1CQUFtQjtHQUNQLHNCQUFzQixDQWtLbEM7U0FsS1ksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiLy9cclxuLy8gQXV0aG9yOjogVG9tIFRhbmcgPHBvbHB3YXJlQGdtYWlsLmNvbT5cclxuLy8gQ29weXJpZ2h0OjogQ29weXJpZ2h0IChjKSAyMDE3LCBYaWFvbG9uZyBUYW5nXHJcbi8vXHJcbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZ1xyXG4vLyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGVcclxuLy8gXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nXHJcbi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCxcclxuLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvXHJcbi8vIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0b1xyXG4vLyB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XHJcbi8vXHJcbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlXHJcbi8vIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxyXG4vL1xyXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELFxyXG4vLyBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0ZcclxuLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkRcclxuLy8gTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRVxyXG4vLyBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OXHJcbi8vIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTlxyXG4vLyBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS5cclxuLy9cclxuLy8gRXhjZXB0IGFzIGNvbnRhaW5lZCBpbiB0aGlzIG5vdGljZSwgdGhlIG5hbWUocykgb2YgdGhlIGFib3ZlIGNvcHlyaWdodFxyXG4vLyBob2xkZXJzIHNoYWxsIG5vdCBiZSB1c2VkIGluIGFkdmVydGlzaW5nIG9yIG90aGVyd2lzZSB0byBwcm9tb3RlIHRoZVxyXG4vLyBzYWxlLCB1c2Ugb3Igb3RoZXIgZGVhbGluZ3MgaW4gdGhpcyBTb2Z0d2FyZSB3aXRob3V0IHByaW9yIHdyaXR0ZW5cclxuLy8gYXV0aG9yaXphdGlvbi5cclxuXHJcbmltcG9ydCAqIGFzIGRlcGVuZGVuY2llcyBmcm9tICdAcG9scHdhcmUvZmUtZGVwZW5kZW5jaWVzJztcclxuXHJcbmltcG9ydCB7IE1lbW9yeUJhY2tlbmQgfSBmcm9tICcuL21lbW9yeS1iYWNrZW5kJztcclxuaW1wb3J0IHsgb2JzZXJ2YWJsZURlY29yYXRvciB9IGZyb20gJy4uL2RlY29yYXRvcnMvb2JzZXJ2YWJsZS5kZWNvcmF0b3InO1xyXG5cclxuaW1wb3J0IHsgSUV2ZW50QXJncyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZXZlbnQtYXJncy5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBJT2JzZXJ2YWJsZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvb2JzZXJ2YWJsZS5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBJSm9pbnBvaW50IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9qb2ludC1wb2ludC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBJTmdab25lTGlrZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvbmctem9uZS1saWtlLmludGVyZmFjZSc7XHJcblxyXG5pbXBvcnQgeyBJU2xpZGluZ0V4cGlyZUNhY2hlIH0gZnJvbSAnLi9zbGlkaW5nLWV4cGlyZS1jYWNoZS5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgbG9jYWNoZSA9IGRlcGVuZGVuY2llcy5sb2NhY2hlO1xyXG5jb25zdCBtZWxkID0gZGVwZW5kZW5jaWVzLm1lbGQ7XHJcblxyXG5jb25zdCBvcmlnaW5hbFJlbW92ZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihsb2NhY2hlLmxvY2FjaGUpLnJlbW92ZTtcclxuXHJcbmNvbnN0IGN1cnJlbnRUaW1lID0gZnVuY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbn07XHJcblxyXG5Ab2JzZXJ2YWJsZURlY29yYXRvclxyXG5leHBvcnQgY2xhc3MgU2xpZGluZ0V4cGlyYXRpb25DYWNoZTxUPiBpbXBsZW1lbnRzIElTbGlkaW5nRXhwaXJlQ2FjaGU8VD4ge1xyXG5cclxuICAgIHByaXZhdGUgX2NhY2hlOiBhbnk7XHJcbiAgICBwcml2YXRlIF90aW1lSW50ZXJ2YWw6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9kZWZhdWx0U2Vjb25kczogbnVtYmVyLFxyXG4gICAgICAgIHNjaGVkdWxlSW50ZXJ2YWw/OiBudW1iZXIsIG5nWm9uZT86IElOZ1pvbmVMaWtlKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IGJhY2tlbmQgPSBuZXcgTWVtb3J5QmFja2VuZDxUPigpO1xyXG4gICAgICAgIHRoaXMuX2NhY2hlID0gbG9jYWNoZS5sb2NhY2hlLmNyZWF0ZUNhY2hlKHsgc3RvcmFnZTogYmFja2VuZCB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5fY2FjaGUucmVtb3ZlID0gbWVsZC5hcm91bmQob3JpZ2luYWxSZW1vdmUsIChpbnB1dDogSUpvaW5wb2ludCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gaW5wdXQuYXJnc1swXTtcclxuICAgICAgICAgICAgY29uc3Qgb25FeHBpcmVFdnROYW1lID0gdGhpcy5vbkV4cGlyZUV2ZW50TmFtZShrZXkpO1xyXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IHRoaXMuYXNPYnNlcnZhYmxlLmZpcmUob25FeHBpcmVFdnROYW1lLCB7fSk7XHJcblxyXG4gICAgICAgICAgICAvLyBpZiB0aGUgZXZlbnQgaXMgc3RvcHBlZCwgdGhlbiBzdG9wIGRvaW5nIGl0XHJcbiAgICAgICAgICAgIC8vIG1vcmUgdGltZSBpcyByZXF1aXJlZCAuLi5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0RXhwaXJlS2V5KGtleSwgdGhpcy5fZGVmYXVsdFNlY29uZHMpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBPdGhlcndpc2UsIGNvbnRpbnVlIHRoZSBvcmlnaW5hbCBsb2dpY1xyXG4gICAgICAgICAgICAvLyBSZW1vdmUgYWxsIGxpc3RlbmVyXHJcbiAgICAgICAgICAgIHRoaXMuYXNPYnNlcnZhYmxlLm9mZihvbkV4cGlyZUV2dE5hbWUsIG51bGwpO1xyXG4gICAgICAgICAgICBpbnB1dC5wcm9jZWVkKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBmaXJlIGV2ZW50XHJcbiAgICAgICAgICAgIGNvbnN0IGFmdGVyUmVtb3ZlRXZ0TmFtZSA9IHRoaXMuYWZ0ZXJSZW1vdmVFdmVudE5hbWUoa2V5KTtcclxuICAgICAgICAgICAgdGhpcy5hc09ic2VydmFibGUuZmlyZShhZnRlclJlbW92ZUV2dE5hbWUsIHt9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBpbnRlcnZhbFxyXG4gICAgICAgIGlmIChzY2hlZHVsZUludGVydmFsKSB7XHJcbiAgICAgICAgICAgIGlmIChuZ1pvbmUpIHtcclxuICAgICAgICAgICAgICAgIG5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGltZUludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jYWNoZS5jbGVhbnVwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgc2NoZWR1bGVJbnRlcnZhbCAqIDEwMDApO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl90aW1lSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FjaGUuY2xlYW51cCgpO1xyXG4gICAgICAgICAgICAgICAgfSwgc2NoZWR1bGVJbnRlcnZhbCAqIDEwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fdGltZUludGVydmFsID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkV4cGlyZUV2ZW50TmFtZShrZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuICdvbkV4cGlyZTonICsga2V5O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWZ0ZXJSZW1vdmVFdmVudE5hbWUoa2V5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiAnYWZ0ZXJSZW1vdmU6JyArIGtleTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0RXhwaXJlS2V5KGtleTogc3RyaW5nLCBzZWNvbmRzOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBleHBpcmVrZXkgPSB0aGlzLl9jYWNoZS5leHBpcmVrZXkoa2V5KTtcclxuICAgICAgICBjb25zdCBtcyA9IHNlY29uZHMgKiAxMDAwO1xyXG4gICAgICAgIHRoaXMuX2NhY2hlLnN0b3JhZ2Uuc2V0KGV4cGlyZWtleSwgY3VycmVudFRpbWUoKSArIG1zKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgYXNPYnNlcnZhYmxlKCk6IElPYnNlcnZhYmxlIHtcclxuICAgICAgICBjb25zdCBzZWxmOiBhbnkgPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IG9ic2VydmFibGU6IElPYnNlcnZhYmxlID0gc2VsZjtcclxuICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBHaXZlbiBhIGtleSwgYSB2YWx1ZSBhbmQgYW4gb3B0aW9uYWwgbnVtYmVyIG9mIHNlY29uZHMgc3RvcmUgdGhlIHZhbHVlXHJcbiAgICAvLyBpbiB0aGUgc3RvcmFnZSBiYWNrZW5kLlxyXG4gICAgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgc2Vjb25kczogbnVtYmVyLCBhZnRlclJlbW92ZUNhbGxiYWNrPzogKGV2dDogSUV2ZW50QXJnczx7fT4pID0+IElFdmVudEFyZ3M8e30+KSB7XHJcblxyXG4gICAgICAgIGNvbnN0IGV4cGlyZWtleSA9IHRoaXMuX2NhY2hlLmV4cGlyZWtleShrZXkpO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlS2V5ID0gdGhpcy5fY2FjaGUua2V5KGtleSk7XHJcblxyXG4gICAgICAgIGlmIChzZWNvbmRzKSB7XHJcbiAgICAgICAgICAgIC8vIFRoZSB0aW1lIHN0b3JlZCBpcyBpbiBtaWxsaXNlY29uZHMsIGJ1dCB0aGlzIGZ1bmN0aW9uIGV4cGVjdHNcclxuICAgICAgICAgICAgLy8gc2Vjb25kcywgc28gbXVsdGlwbHkgYnkgMTAwMC5cclxuICAgICAgICAgICAgY29uc3QgbXMgPSBzZWNvbmRzICogMTAwMDtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGUuc3RvcmFnZS5zZXQoZXhwaXJla2V5LCBjdXJyZW50VGltZSgpICsgbXMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgZXhwaXJlIGtleSwgaWYgbm8gdGltZW91dCBpcyBzZXRcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGUuc3RvcmFnZS5yZW1vdmUoZXhwaXJla2V5KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhZnRlclJlbW92ZUNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXNPYnNlcnZhYmxlLm9uY2UodGhpcy5hZnRlclJlbW92ZUV2ZW50TmFtZShrZXkpLCBhZnRlclJlbW92ZUNhbGxiYWNrKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl9jYWNoZS5zdG9yYWdlLnNldCh2YWx1ZUtleSwgdmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZldGNoIGEgdmFsdWUgZnJvbSB0aGUgY2FjaGUuIEVpdGhlciByZXR1cm5zIHRoZSB2YWx1ZSwgb3IgaWYgaXRcclxuICAgIC8vIGRvZXNuJ3QgZXhpc3QgKG9yIGhhcyBleHBpcmVkKSByZXR1cm4gbnVsbC5cclxuICAgIGdldChrZXk6IHN0cmluZywgc2Vjb25kcz86IG51bWJlcik6IFQgfCBudWxsIHtcclxuICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaGFzIGV4cGlyZWQsIGJlZm9yZSByZXR1cm5pbmcgbnVsbCByZW1vdmUgdGhlIGtleVxyXG4gICAgICAgIC8vIGZyb20gdGhlIHN0b3JhZ2UgYmFja2VuZCB0byBmcmVlIHVwIHRoZSBzcGFjZS5cclxuICAgICAgICBpZiAodGhpcy5fY2FjaGUuaGFzRXhwaXJlZChrZXkpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9jYWNoZS5yZW1vdmUoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHZhbHVlS2V5ID0gdGhpcy5fY2FjaGUua2V5KGtleSk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9jYWNoZS5zdG9yYWdlLmdldCh2YWx1ZUtleSk7XHJcblxyXG4gICAgICAgIC8vIFNsaWRlIHRoZSBleHBpcmUga2VcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5yZXNldEV4cGlyZUtleShrZXksIHNlY29uZHMgfHwgdGhpcy5fZGVmYXVsdFNlY29uZHMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSWYgdmFsdWUgaXNuJ3QgdHJ1dGh5LCBpdCBtdXN0IGJlIGFuIGVtcHR5IHN0cmluZyBvciBzaW1pbGFyLCBzb1xyXG4gICAgICAgIC8vIGp1c3QgcmV0dXJuIHRoYXQuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGludmFsaWRhdGUoa2V5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBsZXQga2V5czogc3RyaW5nW10gPSB0aGlzLl9jYWNoZS5rZXlzKCkgfHwgW107XHJcbiAgICAgICAga2V5cyA9IGtleXMuZmlsdGVyKGEgPT4gYS5pbmRleE9mKGtleSkgIT09IC0xKTtcclxuICAgICAgICB0aGlzLnJlc2V0SW50ZXJuYWwoa2V5cyk7XHJcbiAgICB9XHJcblxyXG4gICAgcm1PbkV4cGlyZUhhbmRsZXIoa2V5OiBzdHJpbmcsIGNhbGxiYWNrOiAoZXZ0OiBJRXZlbnRBcmdzPHt9PikgPT4gSUV2ZW50QXJnczx7fT4pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmFzT2JzZXJ2YWJsZS5vZmYodGhpcy5vbkV4cGlyZUV2ZW50TmFtZShrZXkpLCBjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkT25FeHBpcmVIYW5kbGVyKGtleTogc3RyaW5nLCBjYWxsYmFjazogKGV2dDogSUV2ZW50QXJnczx7fT4pID0+IElFdmVudEFyZ3M8e30+KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hc09ic2VydmFibGUub24odGhpcy5vbkV4cGlyZUV2ZW50TmFtZShrZXkpLCBjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCBjb3VudCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jYWNoZS5sZW5ndGgoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXNldCgpIHtcclxuICAgICAgICBjb25zdCBrZXlzID0gdGhpcy5fY2FjaGUua2V5cygpIHx8IFtdO1xyXG4gICAgICAgIHRoaXMucmVzZXRJbnRlcm5hbChrZXlzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0SW50ZXJuYWwoa2V5czogc3RyaW5nW10pIHtcclxuICAgICAgICBrZXlzLmZvckVhY2goKGspID0+IHtcclxuICAgICAgICAgICAgdGhpcy5hc09ic2VydmFibGUub2ZmKHRoaXMub25FeHBpcmVFdmVudE5hbWUoayksIG51bGwpO1xyXG4gICAgICAgICAgICBvcmlnaW5hbFJlbW92ZS5jYWxsKHRoaXMuX2NhY2hlLCBrKTtcclxuICAgICAgICAgICAgdGhpcy5hc09ic2VydmFibGUuZmlyZSh0aGlzLmFmdGVyUmVtb3ZlRXZlbnROYW1lKGspLCB7fSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbXVzdCBkZXN0b3J5LCBvciBsZWFraW5nIC4uLlxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLnJlc2V0KCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl90aW1lSW50ZXJ2YWwpIHtcclxuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl90aW1lSW50ZXJ2YWwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=