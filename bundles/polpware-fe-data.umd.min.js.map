{"version":3,"sources":["../../../../node_modules/tslib/tslib.es6.js","ng://@polpware/fe-data/lib/relational/table.ts","ng://@polpware/fe-data/lib/relational/dummy-records.ts","ng://@polpware/fe-data/lib/relational/database.ts","ng://@polpware/fe-data/lib/net/xhr-promise.ts","ng://@polpware/fe-data/lib/net/curl.ts","ng://@polpware/fe-data/lib/cache/memory-backend.ts","ng://@polpware/fe-data/lib/decorators/observable.decorator.ts","ng://@polpware/fe-data/lib/cache/sliding-expiration-cache.ts","ng://@polpware/fe-data/lib/security/interfaces.ts","ng://@polpware/fe-data/lib/security/policy-base.ts","ng://@polpware/fe-data/lib/security/oauth-token-policy.ts","ng://@polpware/fe-data/lib/security/open-id-policy.ts","ng://@polpware/fe-data/lib/security/null-policy.ts","ng://@polpware/fe-data/lib/security/user-credential.ts","ng://@polpware/fe-data/lib/security/antiforgerykey-policy.ts","ng://@polpware/fe-data/lib/security/oauth-token-ext-policy.ts","ng://@polpware/fe-data/lib/generic-store/reducers/collection.reducer.ts","ng://@polpware/fe-data/lib/generic-store/reducers/index.ts","ng://@polpware/fe-data/lib/generic-store/factory.ts","ng://@polpware/fe-data/lib/generic-store/collection-abstract.store.ts","ng://@polpware/fe-data/lib/generic-store/collection.store.ts","ng://@polpware/fe-data/lib/backend/aggregate-collection.ts","ng://@polpware/fe-data/lib/backend/event-hub.ts","ng://@polpware/fe-data/lib/backend/provider.ts","ng://@polpware/fe-data/lib/storage/localstorage-util.ts","ng://@polpware/fe-data/lib/storage/localstorage-table.ts","ng://@polpware/fe-data/lib/i18n/dict.ts","ng://@polpware/fe-data/lib/i18n/resource-loader.ts"],"names":["extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__extends","__","this","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__decorate","decorators","target","key","desc","c","r","getOwnPropertyDescriptor","Reflect","decorate","defineProperty","__metadata","metadataKey","metadataValue","metadata","__read","o","m","Symbol","iterator","e","ar","next","done","push","value","error","__spread","concat","backbone","dependencies.backbone","_","dependencies.underscore","cjs","dependencies.constraintjs","RelationalTable","options","dummyRecords","_this","_name","name","_cascade","_foreignRelation","_reverseForeignRelation","dataProviderCtor","_dataProvider","ctor","Collection","extend","dataProviderCtorOption","_addConstraint","constraint","_deleteConstraint","_onDeletedHandler","args","_i","onDeleted","onChange","dataProvider","hasAnyReference","item","get","id","revRelations","hasFound","revK","revTables","some","fromTable","fromTableDataProvider","filter","findWhere","removeReverseForeign","removedItems","revRelation","forEach","reverseTable","toBeRemoved","anyItems","where","pushArray","destroyFromTable","thatItem","removedItem","remove","set","trigger","getForeignModel","foreignKey","attributes","getDummyRecord","add","model","selfContext","modelId","addedItem","newAttr","addMany","models","map","addForeignRelation","foreignTable","Error","addReverseForeignRelation","reverseForeignKey","table","reverseTables","findIndex","elem","hasForeignRelation","hasReverseForeignRelation","destroy","offChange","reset","DummyRecords","_data","Model","RelationDatabase","_referenceCounter","_tableCollection","_dummyRecords","getReference","addTable","getTable","addForeignkey","foreignName","k","XHR","dependencies.XHR","defaultOptions","async","content_type","response_type","requestheaders","success_scope","error_scope","scope","tools","dependencies.Tools","$","dependencies.jquery","loadJsonUriP","url","ajax","cache","dataType","MemoryBackend","_store","keys","index","enabled","EventDispatcher","dependencies.EventDispatcher","getEventDispatcher","obj","_eventDispatcher","toggleEvent","state","isNative","toggleNativeEvent","observableDecorator","_super","class_1","fire","evt","bubble","removed","newEvt","parent","parent_1","isPropagationStopped","on","callback","prepend","off","once","hasEventListeners","has","locache","dependencies.locache","meld","dependencies.meld","originalRemove","getPrototypeOf","currentTime","Date","getTime","SlidingExpirationCache","_defaultSeconds","scheduleInterval","ngZone","backend","_cache","createCache","storage","around","input","onExpireEvtName","onExpireEventName","asObservable","isDefaultPrevented","resetExpireKey","proceed","afterRemoveEvtName","afterRemoveEventName","runOutsideAngular","_timeInterval","setInterval","cleanup","seconds","expirekey","ms","afterRemoveCallback","valueKey","hasExpired","invalidate","a","indexOf","resetInternal","rmOnExpireHandler","addOnExpireHandler","clearInterval","DummyOAuthTokenCtorParams","clientId","clientSecret","PolicyBase","settings","token","getTokenP","isEmpty","isExpired","getTokenInternal","then","lift","adaptToOAuthToken","data","expiresIn","createdOn","refreshToken","OAuthTokenPolicy","response","readFrom","persistent","getParams","client_id","client_secret","grant_type","grantType","params","method","resp","expires_in","safeParseInt","applyTo","beforeSend","xhr","setRequestHeader","applyToV2","headers","Authorization","applyToV3","OpenIDPolicy","_openId","openId","NullPolicy","UserCredential","authPolicy","_user","_security","security","setUser","isEquiva","isArray","checked","objectB","objectA","extendUser","newData","getUser","subscribe","handler","likeBehaviorSubject","unSubscribe","isUserKnown","username","isAuthenticated","AntiForgeryKeyPolicy","_antiForgeryKey","antiForgeryKey","_elementTag","elementTag","_expired","inputField","ret","doc","elm","DOMParser","parseFromString","find","eq","attr","liftWithGuard","isGoodToken","OAuthTokenExtPolicy","payload","_payload","reducer","action","type","x","items","y","newItems","buildInitialState","collection","buildReducerMap","fromCollection.reducer","factory","actionSubject","ngrxStore.ActionsSubject","scannerActionSubject","ngrxStore.ScannedActionsSubject","actionReducerFactory","ngrxStore.combineReducers","reducerManager","ngrxStore.ReducerManager","reducerIndex.buildReducerMap","stateObservable","ngrxStore.State","ngrxStore.Store","CollectionAbstractStore","getStore","dispatch","modify","CollectionStore","getState","select","Éµfac","when","dependencies.when","AggregateCollection","_providerGenerator","_workingProviders","hasNextPage","hasMore","getFirstPage","getNext","providers","totalPages","totalRecords","promises","getNextPage","settle","func","mountSyncBeforeAdvice","before","mountSyncAroundAdvice","mountAjaxBeforeAdvice","DataFlow","dependencies['dataflow']","dependencies['backbone']","endPointEnum","pagedCollection","syncMethodEnum","read","patch","update","delete","globalConfigurationMapping","mountedFeatureRemovers","GlobalProvider","ctorOptions","_dataflow","_myEndPointKeys","_host","webhost","_uniqueNamePrefix","replace","remover","methodKey","endPointKey","cfgOptions","deleteUrl","deleteContentType","contentType","updateUrl","updateContentType","createUrl","createContentType","patchUrl","patchContentType","policyDelegate","securityDelegate","extraParams","JSON","parse","urlEncode","jointpoint","cfg","syncDelegate","mountFeatures","addEndPoint","tag","cfgMapping","configurationMapping","dataflow","uniqueName","getEndPoint","ignoreCache","cachedValue","PageableCollection","getConfiguration","addWhenCallback","addDependency","src","dst","cleanupCache","cleanMountedFeatures","globalLocalStorage","window","localStorage","externalInterface.underscore","union","getEntity","ty","defaultValue","tmp","getItem","isType","ex","console","log","updateEntity","setItem","stringify","cleanEntity","LocalStorageTable","getP","localStorageUtil.getEntity","polpwareUtil.tyObject","polpwareUtil.lift","removeP","localStorageUtil.cleanEntity","updateP","localStorageUtil.updateEntity","_i18n","dependencies.I18n","I18n","getDictByCode","code","translate","text","defaultText","recycleOthers","recycleList","isString","getByNamespace","repo","identifiers","startLevel","restKey","slice","join","initRepo","ResourceLoader","_configuration","register","uri","liveSeconds","configuration","undoRegister","getPromise","fullyQualifiedNamespace","convertor","split","topIdentifier","entry","content","prefix","removeItem","tyArray","Id","upperBound","currentData","entity","ajaxParams","splice","Promise","resolve","reject","xhrSettings","success","output","send"],"mappings":"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","sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __createBinding(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (p !== \"default\" && !exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","/**\n * @fileOverview\n * Defines a table in a relational database.\n * This table is observable, i.e., any change on this table will be notified to its listeners.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\nimport { pushArray } from '@polpware/fe-utilities';\nimport {\n    IModelLike,\n    IBackboneCollectionLike,\n    IFullBackboneCollectionLike,\n    IFullModelLike\n} from '../interfaces/backbone.interface';\nimport { DummyRecords } from './dummy-records';\n\nconst backbone = dependencies.backbone;\nconst _ = dependencies.underscore;\nconst cjs = dependencies.constraintjs;\n\nexport interface IRelationalTableOptions {\n    name: string;\n    cascade?: boolean;\n    dataProviderCtor?: any;\n    dataProviderCtorOption?: any;\n}\n\nexport interface IRelationalTable {\n    name: string;\n    cascade: boolean;\n    dataProvider(): IFullBackboneCollectionLike;\n    get(id: any): IFullModelLike;\n    add(model: object): IFullModelLike;\n    addMany(models: any[]): IFullModelLike[];\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void;\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void;\n    hasForeignRelation(foreignKey: string): boolean;\n    hasReverseForeignRelation(reverseForeignKey: string): boolean;\n    destroy(): void;\n}\n\nexport class RelationalTable implements IRelationalTable {\n\n    private _name: string;\n    private _cascade: boolean;\n    private _addConstraint: any;\n    private _deleteConstraint: any;\n    private _foreignRelation: { [key: string]: IRelationalTable };\n    private _reverseForeignRelation: { [key: string]: IRelationalTable[] };\n\n    private _dataProvider: IFullBackboneCollectionLike;\n    private _onDeletedHandler: any;\n\n    constructor(options: IRelationalTableOptions,\n        public dummyRecords: DummyRecords) {\n\n        this._name = options.name;\n        this._cascade = false;\n\n        this._foreignRelation = {};\n        this._reverseForeignRelation = {};\n\n\n        if (options.dataProviderCtor) {\n            this._dataProvider = new options.dataProviderCtor();\n        } else {\n            const ctor = backbone.Collection.extend(options.dataProviderCtorOption || {});\n            this._dataProvider = new ctor();\n        }\n\n        this._addConstraint = cjs.constraint([]);\n        this._deleteConstraint = cjs.constraint([]);\n\n        // Todo: Figure out parameters\n        this._onDeletedHandler = (...args: any[]) => {\n            this.onDeleted();\n        };\n\n        // Set up constraint\n        this._deleteConstraint.onChange(this._onDeletedHandler);\n    }\n\n    public get name(): string {\n        return this._name;\n    }\n\n    public get cascade(): boolean {\n        return this._cascade;\n    }\n\n    public dataProvider(): IFullBackboneCollectionLike {\n        return this._dataProvider;\n    }\n\n    // TODO: Figure out ...\n    public onDeleted() {\n    }\n\n    /**\n     * Check if the given items are still in use.\n     */\n    private hasAnyReference(item: IModelLike): boolean {\n        // Check if this item is in this table or not\n        const itemInTable = this._dataProvider.get(item.id);\n        if (!itemInTable) {\n            return false;\n        }\n\n        const revRelations = this._reverseForeignRelation;\n        let hasFound = false;\n        for (const revK in revRelations) {\n            if (revRelations.hasOwnProperty(revK)) {\n                const revTables = revRelations[revK];\n                hasFound = _.some(revTables, (fromTable) => {\n                    const fromTableDataProvider = fromTable.dataProvider();\n                    const filter = {};\n                    filter[revK] = item.id;\n                    const anyUse = fromTableDataProvider.findWhere(filter);\n                    return !!anyUse;\n                });\n                if (hasFound) {\n                    break;\n                }\n            }\n        }\n\n        return hasFound;\n    }\n\n    /**\n     * Removing any items in other tables which depend on the deleted item.\n     */\n    private removeReverseForeign(removedItems: IModelLike[]): void {\n        const revRelation = this._reverseForeignRelation;\n        for (const revK in revRelation) {\n            if (revRelation.hasOwnProperty(revK)) {\n                const revTables = revRelation[revK];\n                revTables.forEach((reverseTable) => {\n                    const dataProvider = reverseTable.dataProvider();\n                    const toBeRemoved = [];\n                    removedItems.forEach((item) => {\n                        const filter = {};\n                        filter[revK] = item.id;\n                        const anyItems = dataProvider.where(filter);\n                        pushArray(toBeRemoved, anyItems);\n                    });\n                    toBeRemoved.forEach((item) => {\n                        item.destroyFromTable();\n                    });\n                });\n            }\n        }\n    }\n\n    /**\n     * Gets the model in the table by id.\n     */\n    get(id: any): IFullModelLike {\n        return this._dataProvider.get(id);\n    }\n\n    private destroyFromTable(thatItem: IModelLike): void {\n        const removedItem = this._dataProvider.remove(thatItem);\n        if (!removedItem) {\n            return;\n        }\n        // Notify of its collection\n        removedItem.set('invalidated', true);\n        removedItem.trigger('destroy', removedItem);\n\n        this.removeReverseForeign([removedItem]);\n    }\n\n    private getForeignModel(thatItem: IModelLike, foreignKey: string): IModelLike {\n        const value = thatItem.attributes[foreignKey];\n\n        // If we do not have this foreignKey, then return a dummy one\n        if (!value) {\n            return this.dummyRecords.getDummyRecord(foreignKey);\n        }\n\n        const table = this._foreignRelation[foreignKey];\n        return table.dataProvider().get(value);\n    }\n\n    /**\n     * Adds an item in the Table and recursively add foreign items.\n     */\n    add(model: object): IFullModelLike {\n\n        const selfContext = this;\n\n        const dataProvider = this._dataProvider;\n        const foreignRelation = this._foreignRelation;\n\n        // Check if the item to be added is already in this table.\n        const modelId = dataProvider.modelId(model);\n        let addedItem = dataProvider.get(modelId);\n\n        if (addedItem) {\n            const newAttr = _.extend({}, addedItem.attributes, model);\n            addedItem.set(newAttr);\n            return addedItem;\n        }\n\n        // Otherwise a new item\n        addedItem = dataProvider.add(model);\n\n        // Add convenient methods\n        addedItem.destroyFromTable = function() {\n            const thatItem = this;\n            selfContext.destroyFromTable(thatItem);\n        };\n\n        addedItem.getForeignModel = function(foreignKey: string): IModelLike {\n            const thatItem = this;\n            return selfContext.getForeignModel(thatItem, foreignKey);\n        };\n\n        addedItem.hasAnyReference = function(): boolean {\n            const thatItem = this;\n            return selfContext.hasAnyReference(thatItem);\n        };\n\n        return addedItem;\n    }\n\n    /**\n     * Add many items into a table.\n     */\n    addMany(models: any[]): IFullModelLike[] {\n        return models.map(model => {\n            return this.add(model);\n        });\n    }\n\n    /**\n     * Adds a foreign relation.\n     */\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void {\n        if (this._foreignRelation[foreignKey]) {\n            throw new Error('Foreign key exists: ' + foreignKey);\n        }\n        this._foreignRelation[foreignKey] = foreignTable;\n    }\n\n    /**\n     * Add a reverse foreign relation.\n     */\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void {\n        const reverseTables = this._reverseForeignRelation[reverseForeignKey];\n        if (reverseTables) {\n            const index = reverseTables.findIndex((elem) => {\n                return elem === table;\n            });\n\n            if (index !== -1) {\n                throw new Error('Reverse foreign table exists: ' + reverseForeignKey);\n            }\n\n            reverseTables.push(table);\n        } else {\n            this._reverseForeignRelation[reverseForeignKey] = [table];\n        }\n    }\n\n    /**\n     * Check if a given foreign relation is present.\n     */\n    hasForeignRelation(foreignKey: string): boolean {\n        return !!this._foreignRelation[foreignKey];\n    }\n\n    /**\n     * Checks if a given reverse foreign relation is present.\n     */\n    hasReverseForeignRelation(reverseForeignKey: string): boolean {\n        return !!this._reverseForeignRelation[reverseForeignKey];\n    }\n\n    /**\n     * Destroys table\n     */\n    destroy(): void {\n        // Remove constraint\n        this._deleteConstraint.offChange(this._onDeletedHandler);\n        this._dataProvider.reset();\n    }\n}\n\n","/**\n * @fileOverview\n * Defines a global dummy records for tables. Each table is configured with a dummy record.\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IModelLike } from '../interfaces/backbone.interface';\n\nconst backbone = dependencies.backbone;\n\nexport class DummyRecords {\n\n    private _data: { [key: string]: IModelLike };\n\n    constructor() {\n        this._data = {};\n    }\n\n    getDummyRecord(key: string) {\n        if (!this._data[key]) {\n            this._data[key] = new backbone.Model({});\n        }\n        return this._data[key];\n    }\n}\n","/**\n * @fileOverview\n * Defines a relational database which supports foreign keys and primary keys.\n * Also this database support cascading deletion and addition.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IRelationalTableOptions, IRelationalTable, RelationalTable } from './table';\nimport { DummyRecords } from './dummy-records';\n\nexport interface IRelationalDatabase {\n    getReference(): IRelationalDatabase;\n    addTable(options: IRelationalTableOptions): IRelationalTable;\n    getTable(name: string): IRelationalTable;\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void;\n    destroy(): void;\n}\n\nexport class RelationDatabase implements IRelationalDatabase {\n\n    private _tableCollection: { [key: string]: IRelationalTable };\n    private _referenceCounter: number;\n    private _dummyRecords: DummyRecords;\n\n    /**\n     * Represents a relational database.\n     */\n    constructor() {\n        this._referenceCounter = 1;\n        this._tableCollection = {};\n        this._dummyRecords = new DummyRecords();\n    }\n\n    /**\n     * Gets a reference of the file system database\n     */\n    getReference(): IRelationalDatabase {\n        this._referenceCounter++;\n        return this;\n    }\n\n    /**\n     * Defines a table in the database.\n     * @function addTable\n     * @param {Object} settings\n     */\n    addTable(options: IRelationalTableOptions): IRelationalTable {\n        return this._tableCollection[options.name] = new RelationalTable(options, this._dummyRecords);\n    }\n\n    /**\n     * Retrieves a table by name.\n     */\n    getTable(name: string): IRelationalTable {\n        return this._tableCollection[name];\n    }\n\n    /**\n     * Defines a foreign relation between two tables.\n     */\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void {\n        // Constraints\n        const table = this._tableCollection[name];\n        if (!table) {\n            throw new Error('Undefined table: ' + name);\n        }\n\n        const foreignTable = this._tableCollection[foreignName];\n        if (!foreignTable) {\n            throw new Error('Undefined foreign table: ' + foreignName);\n        }\n\n        table.addForeignRelation(foreignKey, foreignTable);\n        foreignTable.addReverseForeignRelation(foreignKey, table);\n    }\n\n    /**\n     * Destroys database\n     */\n    destroy(): void {\n        this._referenceCounter--;\n        if (this._referenceCounter === 0) {\n            for (const k in this._tableCollection) {\n                if (this._tableCollection.hasOwnProperty(k)) {\n                    const table = this._tableCollection[k];\n                    table.destroy();\n                }\n            }\n            this._tableCollection = {};\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a class for performing XHR in an exception way and in a promise way\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst XHR = dependencies.XHR;\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nconst _ = dependencies.underscore;\n\nexport interface IXHRCtorOption {\n    url: string;\n    async?: boolean;\n    type?: 'POST' | 'GET';\n    content_type: 'application/x-www-form-urlencoded' | 'application/json' | '';\n    response_type: 'json' | 'blob' | 'document' | 'text' | 'arraybuffer' | '';\n    requestheaders: any[];\n    scope?: any;\n    success_scope?: any;\n    error_scope?: any;\n    data?: any;\n}\n\nconst defaultOptions = {\n    async: true,\n    content_type: '',\n    response_type: 'json',\n    requestheaders: [],\n    success_scope: null,\n    error_scope: null,\n    scope: null\n};\n\nexport function sendPromise(options: IXHRCtorOption): PromiseLike<any> {\n    const settings = _.extend({}, defaultOptions, options);\n\n    const promise: PromiseLike<any> = new Promise((resolve, reject) => {\n        const xhrSettings = {\n            url: settings.url,\n            content_type: settings.content_type,\n            response_type: settings.response_type,\n            type: settings.type,\n            data: settings.data,\n            async: settings.async,\n            success: (output, xhr, input) => {\n                resolve({\n                    response: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            error: (output, xhr, input) => {\n                reject({\n                    error: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            success_scope: settings.success_scope,\n            error_scope: settings.error_scope,\n            scope: settings.scope,\n            requestheaders: settings.requestheaders\n        };\n        // Process sent-out data\n        if (settings.content_type === 'application/x-www-form-urlencoded') {\n            xhrSettings.data = urlEncode(xhrSettings.data);\n        } else if (settings.content_type === 'application/json') {\n            xhrSettings.data = JSON.stringify(xhrSettings.data);\n        }\n        XHR.send(xhrSettings);\n    });\n\n    return promise;\n}\n","/**\n * @fileOverview\n * Provides a bunch of utilties on network communication.\n * @name Curl.js\n * @module hypercom/util/Curl\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst tools = dependencies.Tools;\n\nconst $ = dependencies.jquery;\n\n/**\n * Load a local json file from the given url.\n * This method encapsulates the behavior of loading a local json\n * file, in order that changing its behavior in the future\n * will not impact other modules.\n * We currently leaverage the cache capability of a browser.\n * In the future, we may use memory cache.\n * Also this method returns a promise compatible project, and\n * therefore, please use \"then\" to go future.\n * @function loadJsonUriP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadJsonUriP(url) {\n    const deferred = $.ajax({\n        url: url, /* 'lang/options.json', */\n        cache: true,\n        dataType: 'json'\n    });\n    return deferred;\n}\n\n/**\n * Tests if a url is reachable.\n * @function pingP\n * @param {String} url The url to be tested.\n * @param {Object} [options]  A set of ajax parameters.\n * @returns {Promise}\n */\nexport function pingP(url, options) {\n    options = options || {};\n    const ajaxParams = tools.extend({ url: url }, options);\n    return $.ajax(ajaxParams);\n}\n\n/**\n * Reads a the response from a given url and\n * parses it into a jquery object.\n * @function loadHtmlP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadHtmlP(url) {\n    return $.ajax({\n        url: url,\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        const doc = new DOMParser().parseFromString(data, 'text/html');\n        return $(doc);\n    });\n}\n","import { ICacheBackend } from './cache-backend.interface';\r\n\r\n\r\nexport class MemoryBackend<T> implements ICacheBackend<T> {\r\n\r\n    private _store: { [key: string]: T | number };\r\n\r\n    constructor() {\r\n        this._store = {};\r\n    }\r\n\r\n    /**\r\n     * Sets a key-value pair\r\n     */\r\n    set(key: string, value: T | number): T | number {\r\n        this._store[key] = value;\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * Gets the value for a given key.\r\n     */\r\n    get(key: string): T | number | null {\r\n        return this._store[key] || null;\r\n    }\r\n\r\n    /**\r\n     * Removes the given key and its corresponding value.\r\n     */\r\n    remove(key: string): void {\r\n        delete this._store[key];\r\n    }\r\n\r\n    /**\r\n     * Returns the number of stored items.\r\n     */\r\n    length(key: string): number {\r\n        return Object.keys(this._store).length;\r\n    }\r\n\r\n    /**\r\n     * Retuns the ith key in the store table.\r\n     */\r\n    key(index: number): string {\r\n        const keys = Object.keys(this._store);\r\n\r\n        if (index >= 0 && index < keys.length) {\r\n            return keys[index];\r\n        }\r\n\r\n        return '';\r\n    }\r\n\r\n    /**\r\n     * Returns if this storage is enabled.\r\n     * This method is required by locachejs.\r\n     */\r\n    enabled(): boolean {\r\n        return true;\r\n    }\r\n}\r\n\r\n","//\r\n// Author:: Tom Tang <principleware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nconst EventDispatcher = dependencies.EventDispatcher;\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\n\r\nconst getEventDispatcher = function(obj) {\r\n    if (!obj._eventDispatcher) {\r\n        obj._eventDispatcher = new EventDispatcher({\r\n            scope: obj,\r\n            toggleEvent: function(name, state) {\r\n                if (EventDispatcher.isNative(name) && obj.toggleNativeEvent) {\r\n                    obj.toggleNativeEvent(name, state);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    return obj._eventDispatcher;\r\n};\r\n\r\nexport function observableDecorator<T extends { new(...args: any[]) }>(constructor: T) {\r\n    return class extends constructor {\r\n\r\n        public fire<U>(name: string, evt: IEventArgs<U>, bubble?: boolean): IEventArgs<U> {\r\n            const self = this;\r\n\r\n            // Prevent all events except the remove event after the instance has been removed\r\n            if (self.removed && name !== 'remove') {\r\n                return null;\r\n            }\r\n\r\n            const newEvt = getEventDispatcher(self).fire(name, evt, bubble);\r\n\r\n            // Bubble event up to parents\r\n            if (bubble !== false && self.parent) {\r\n                let parent = self.parent();\r\n                while (parent && !newEvt.isPropagationStopped()) {\r\n                    parent.fire(name, newEvt, false);\r\n                    parent = parent.parent();\r\n                }\r\n            }\r\n\r\n            return newEvt;\r\n        }\r\n\r\n\r\n        public on(name: string, callback: (...args: any[]) => any, prepend?: boolean): any {\r\n            return getEventDispatcher(this).on(name, callback, prepend);\r\n        }\r\n\r\n        public off(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).off(name, callback);\r\n        }\r\n\r\n        public once(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).once(name, callback);\r\n        }\r\n\r\n        public hasEventListeners(name: string): boolean {\r\n            return getEventDispatcher(this).has(name);\r\n        }\r\n    };\r\n}\r\n","//\r\n// Author:: Tom Tang <polpware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nimport { MemoryBackend } from './memory-backend';\r\nimport { observableDecorator } from '../decorators/observable.decorator';\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\nimport { IObservable } from '../interfaces/observable.interface';\r\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\r\nimport { INgZoneLike } from '../interfaces/ng-zone-like.interface';\r\n\r\nimport { ISlidingExpireCache } from './sliding-expire-cache.interface';\r\n\r\nconst locache = dependencies.locache;\r\nconst meld = dependencies.meld;\r\n\r\nconst originalRemove = Object.getPrototypeOf(locache.locache).remove;\r\n\r\nconst currentTime = function() {\r\n    return new Date().getTime();\r\n};\r\n\r\n@observableDecorator\r\nexport class SlidingExpirationCache<T> implements ISlidingExpireCache<T> {\r\n\r\n    private _cache: any;\r\n    private _timeInterval: any;\r\n\r\n    constructor(private _defaultSeconds: number,\r\n        scheduleInterval?: number, ngZone?: INgZoneLike) {\r\n\r\n        const backend = new MemoryBackend<T>();\r\n        this._cache = locache.locache.createCache({ storage: backend });\r\n\r\n        this._cache.remove = meld.around(originalRemove, (input: IJoinpoint) => {\r\n\r\n            const key = input.args[0];\r\n            const onExpireEvtName = this.onExpireEventName(key);\r\n            const event = this.asObservable.fire(onExpireEvtName, {});\r\n\r\n            // if the event is stopped, then stop doing it\r\n            // more time is required ...\r\n            if (event.isDefaultPrevented()) {\r\n                this.resetExpireKey(key, this._defaultSeconds);\r\n                return false;\r\n            }\r\n\r\n            // Otherwise, continue the original logic\r\n            // Remove all listener\r\n            this.asObservable.off(onExpireEvtName, null);\r\n            input.proceed();\r\n\r\n            // fire event\r\n            const afterRemoveEvtName = this.afterRemoveEventName(key);\r\n            this.asObservable.fire(afterRemoveEvtName, {});\r\n\r\n            return true;\r\n        });\r\n\r\n        // interval\r\n        if (scheduleInterval) {\r\n            if (ngZone) {\r\n                ngZone.runOutsideAngular(() => {\r\n                    this._timeInterval = setInterval(() => {\r\n                        this._cache.cleanup();\r\n                    }, scheduleInterval * 1000);\r\n                });\r\n            }\r\n            else {\r\n                this._timeInterval = setInterval(() => {\r\n                    this._cache.cleanup();\r\n                }, scheduleInterval * 1000);\r\n            }\r\n        } else {\r\n            this._timeInterval = null;\r\n        }\r\n    }\r\n\r\n    private onExpireEventName(key: string): string {\r\n        return 'onExpire:' + key;\r\n    }\r\n\r\n    private afterRemoveEventName(key: string): string {\r\n        return 'afterRemove:' + key;\r\n    }\r\n\r\n    private resetExpireKey(key: string, seconds: number) {\r\n        const expirekey = this._cache.expirekey(key);\r\n        const ms = seconds * 1000;\r\n        this._cache.storage.set(expirekey, currentTime() + ms);\r\n    }\r\n\r\n    get asObservable(): IObservable {\r\n        const self: any = this;\r\n        const observable: IObservable = self;\r\n        return observable;\r\n    }\r\n\r\n    // Given a key, a value and an optional number of seconds store the value\r\n    // in the storage backend.\r\n    set(key: string, value: T, seconds: number, afterRemoveCallback?: (evt: IEventArgs<{}>) => IEventArgs<{}>) {\r\n\r\n        const expirekey = this._cache.expirekey(key);\r\n        const valueKey = this._cache.key(key);\r\n\r\n        if (seconds) {\r\n            // The time stored is in milliseconds, but this function expects\r\n            // seconds, so multiply by 1000.\r\n            const ms = seconds * 1000;\r\n            this._cache.storage.set(expirekey, currentTime() + ms);\r\n        } else {\r\n            // Remove the expire key, if no timeout is set\r\n            this._cache.storage.remove(expirekey);\r\n        }\r\n\r\n        if (afterRemoveCallback) {\r\n            this.asObservable.once(this.afterRemoveEventName(key), afterRemoveCallback);\r\n        }\r\n\r\n        return this._cache.storage.set(valueKey, value);\r\n    }\r\n\r\n    // Fetch a value from the cache. Either returns the value, or if it\r\n    // doesn't exist (or has expired) return null.\r\n    get(key: string, seconds?: number): T | null {\r\n        // If the value has expired, before returning null remove the key\r\n        // from the storage backend to free up the space.\r\n        if (this._cache.hasExpired(key)) {\r\n            if (this._cache.remove(key)) {\r\n                return null;\r\n            }\r\n        }\r\n\r\n        const valueKey = this._cache.key(key);\r\n        const value = this._cache.storage.get(valueKey);\r\n\r\n        // Slide the expire ke\r\n        if (value) {\r\n            this.resetExpireKey(key, seconds || this._defaultSeconds);\r\n        }\r\n\r\n        // If value isn't truthy, it must be an empty string or similar, so\r\n        // just return that.\r\n        return value;\r\n    }\r\n\r\n    invalidate(key: string): void {\r\n        let keys: string[] = this._cache.keys() || [];\r\n        keys = keys.filter(a => a.indexOf(key) !== -1);\r\n        this.resetInternal(keys);\r\n    }\r\n\r\n    rmOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.off(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    addOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.on(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    public get count(): number {\r\n        return this._cache.length();\r\n    }\r\n\r\n    reset() {\r\n        const keys = this._cache.keys() || [];\r\n        this.resetInternal(keys);\r\n    }\r\n\r\n    private resetInternal(keys: string[]) {\r\n        keys.forEach((k) => {\r\n            this.asObservable.off(this.onExpireEventName(k), null);\r\n            originalRemove.call(this._cache, k);\r\n            this.asObservable.fire(this.afterRemoveEventName(k), {});\r\n        });\r\n    }\r\n\r\n    // must destory, or leaking ...\r\n    destroy() {\r\n        this.reset();\r\n\r\n        if (this._timeInterval) {\r\n            clearInterval(this._timeInterval);\r\n        }\r\n    }\r\n}\r\n","export interface IPolicyCtorOptions {\r\n    url: string;\r\n}\r\n\r\nexport interface IOAuthTokenPolicyCtorOptions extends IPolicyCtorOptions {\r\n    clientId: string;\r\n    clientSecret: string;\r\n    scope: string;\r\n}\r\n\r\nexport interface IAntiForgeryKeyCtorOptions extends IPolicyCtorOptions {\r\n    antiForgeryKey: string;\r\n    elementTag: string;\r\n}\r\n\r\nexport interface IOAuthParams {\r\n    client_id: string;\r\n    client_secret: string;\r\n    scope: string;\r\n    grant_type: any;\r\n}\r\n\r\nexport interface IOAuthToken {\r\n    expiresIn: number;\r\n    createdOn: number;\r\n    token: string;\r\n    refreshToken: string;\r\n}\r\n\r\nexport interface IOpenIDToken extends IOAuthToken {\r\n    openId: string;\r\n}\r\n\r\nexport interface IPolicy {\r\n    getTokenInternal(): PromiseLike<string>;\r\n\r\n    applyTo(options: any): void;\r\n\r\n    isExpired(): boolean;\r\n\r\n    readFrom(settings: {});\r\n\r\n    persistent(): any;\r\n\r\n    applyToV2(options: any): void;\r\n\r\n    applyToV3(options: any): void;\r\n\r\n    /**\r\n     * The interface for retrieving the token from a remote server.\r\n     * This method internally dispatches the call to another method\r\n     * and cache the token.\r\n     */\r\n    getTokenP(): PromiseLike<string>;\r\n\r\n    reset();\r\n}\r\n\r\nexport const DummyOAuthTokenCtorParams: IOAuthTokenPolicyCtorOptions = {\r\n    url: 'dummy',\r\n    clientId: 'dummy',\r\n    clientSecret: 'dummy',\r\n    scope: 'all'\r\n};\r\n","/**\n * @fileOverview\n * A base class for defining security plicies.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { lift } from '@polpware/fe-utilities';\n\nimport { IPolicyCtorOptions, IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nexport abstract class PolicyBase implements IPolicy {\n\n    protected url: string;\n    protected token: string;\n\n    constructor(settings: IPolicyCtorOptions) {\n        this.url = settings.url;\n        this.token = '';\n    }\n\n    abstract getTokenInternal(): PromiseLike<string>;\n\n    abstract applyTo(options: any): void;\n\n    abstract isExpired(): boolean;\n\n    abstract readFrom(settings: {});\n\n    abstract persistent(): any;\n\n    abstract applyToV2(options: any): void;\n\n    abstract applyToV3(options: any): void;\n\n\n    /**\n     * The interface for retrieving the token from a remote server.\n     * This method internally dispatches the call to another method\n     * and cache the token.\n     */\n    getTokenP(): PromiseLike<string> {\n        if (!_.isEmpty(this.token) && !this.isExpired()) {\n            return lift(this.token, null);\n        }\n\n        return this.getTokenInternal()\n            .then((token) => {\n                return this.token = token;\n            });\n    }\n\n    /**\n     * Reset the security policy, e.g.,\n     * removing established token.\n     */\n    reset() {\n        this.token = '';\n    }\n}\n","/**\n * @fileOverview\n * Defines a base class for retrieving OAuth2 tokens.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { safeParseInt } from '@polpware/fe-utilities';\nimport {\n    IOAuthTokenPolicyCtorOptions,\n    IOAuthToken,\n    IOAuthParams\n} from './interfaces';\nimport { PolicyBase } from './policy-base';\n\nconst _ = dependencies.underscore;\nconst $ = dependencies.jquery;\n\nexport function adaptToOAuthToken(data): IOAuthToken {\n    data = data || {};\n    data.expiresIn = data.expiresIn || 0;\n    data.createdOn = data.createdOn || 0;\n    data.token = data.token || '';\n    data.refreshToken = data.refreshToken || '';\n\n    return data;\n}\n\nexport class OAuthTokenPolicy extends PolicyBase {\n\n    protected clientId: string;\n    protected clientSecret: string;\n    protected scope: string;\n    protected expiresIn: number;\n    protected createdOn: number;\n    protected refreshToken: string;\n    public grantType: 'authorization_code' | 'refresh_token' | 'password' | 'client_credentials';\n\n    public response: any;\n\n    constructor(settings: IOAuthTokenPolicyCtorOptions) {\n        super(settings);\n\n        this.clientId = settings.clientId;\n        this.clientSecret = settings.clientSecret;\n        this.scope = settings.scope;\n        this.expiresIn = null;\n        this.createdOn = null;\n        this.refreshToken = '';\n\n        this.response = null;\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     */\n    readFrom(settings: IOAuthToken) {\n        this.expiresIn = settings.expiresIn;\n        this.createdOn = settings.createdOn;\n        this.token = settings.token;\n        this.refreshToken = settings.refreshToken;\n    }\n\n    /**\n     * Returns the data that are persistentable.\n     */\n    persistent(): IOAuthToken {\n        return {\n            expiresIn: this.expiresIn,\n            createdOn: this.createdOn,\n            token: this.token,\n            refreshToken: this.refreshToken\n        };\n    }\n\n    getParams(): any {\n        return {\n            client_id: this.clientId,\n            client_secret: this.clientSecret,\n            scope: this.scope,\n            grant_type: this.grantType\n        };\n    }\n\n    // TODO: Support progress loading\n    getTokenInternal(): PromiseLike<string> {\n        const params = this.getParams();\n        return $.ajax({\n            url: this.url,\n            data: params,\n            method: 'POST'\n        }).then((resp) => {\n\n            // Put down the response\n            this.response = resp;\n\n            this.createdOn = new Date().getTime();\n            this.expiresIn = resp.expires_in;\n            this.refreshToken = resp.refreshToken || '';\n            resp.scope && (this.scope = resp.scope);\n            return (resp.access_token);\n        });\n    }\n\n    /**\n     * Returns if the token is expired or not.\n     */\n    isExpired(): boolean {\n        if (!this.token || this.token.length < 1) {\n            return true;\n        }\n        if (!this.createdOn) {\n            return true;\n        }\n        const expiresIn = safeParseInt(this.expiresIn);\n        if (expiresIn <= 0) {\n            return true;\n        }\n        const now = new Date();\n        const diff = now.getTime() - this.createdOn;\n        if (diff < expiresIn * 1000) {\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * Applys the token to the given options.\n     */\n    applyTo(options: any): void {\n        options.beforeSend = (xhr) => {\n            xhr.setRequestHeader('Authorization', ('Bearer '.concat(this.token)));\n        };\n    }\n\n    /**\n     * Apply security policy to the given options.\n     */\n    applyToV2(options: any): void {\n        options.headers = options.headers || {};\n        options.headers = {\n            Authorization: 'Bearer '.concat(this.token)\n        };\n    }\n\n    /**\n     * App security policy the given options, used for our customized XHR.\n     */\n    applyToV3(options: any): void {\n        options.requestheaders = options.requestheaders || [];\n        options.requestheaders.push({\n            key: 'Authorization',\n            value: 'Bearer '.concat(this.token)\n        });\n    }\n\n    /**\n     * Resets the token and its assoicated information.\n     */\n    reset() {\n        super.reset();\n        this.refreshToken = '';\n        this.expiresIn = null;\n        this.createdOn = null;\n    }\n}\n","/**\r\n * @fileOverview\r\n * OpenID token policy, built upon OAuth2 token policy\r\n */\r\n\r\nimport {\r\n    IOpenIDToken,\r\n    DummyOAuthTokenCtorParams\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy, adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport function adaptToOpenIDToken(data): IOpenIDToken {\r\n    data = data || {};\r\n\r\n    const r = adaptToOAuthToken(data);\r\n    return { ...r, openId: data.openId || '' };\r\n}\r\n\r\nexport class OpenIDPolicy extends OAuthTokenPolicy {\r\n\r\n    private _openId: string;\r\n\r\n    constructor() {\r\n        super(DummyOAuthTokenCtorParams);\r\n        this._openId = '';\r\n    }\r\n\r\n    /**\r\n     * Returns the necessary information for peristence.\r\n     */\r\n    persistent(): IOpenIDToken {\r\n        const r = super.persistent();\r\n        return { ...r, openId: this._openId };\r\n    }\r\n\r\n    /**\r\n     * Reads credential from the given settings.\r\n     */\r\n    readFrom(settings: IOpenIDToken) {\r\n        super.readFrom(settings);\r\n        this._openId = settings.openId;\r\n        return this;\r\n    }\r\n}\r\n","import { lift } from '@polpware/fe-utilities';\r\n\r\nimport { IPolicy } from './interfaces';\r\n\r\nexport class NullPolicy implements IPolicy {\r\n\r\n    getTokenInternal(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    applyTo(options: any): void { }\r\n\r\n    isExpired(): boolean {\r\n        return false;\r\n    }\r\n\r\n    readFrom(settings: {}) { }\r\n\r\n\r\n    persistent(): any { }\r\n\r\n    applyToV2(options: any): void { }\r\n\r\n    applyToV3(options: any): void { }\r\n\r\n    getTokenP(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    reset() { }\r\n}\r\n","/**\n * @fileOverview\n * Defines the user credential. This user credential supports event\n * listening. Note that the credential is assumed to be Uppercase:\n * Username and Password\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport {\n    isArray\n} from '@polpware/fe-utilities';\n\nimport { observableDecorator } from '../decorators/observable.decorator';\nimport { IObservable } from '../interfaces/observable.interface';\nimport { IEventArgs } from '../interfaces/event-args.interface';\n\nimport { IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nfunction isEquiva(a: any, b: any): boolean {\n\n    // Strict equals\n    if (a === b) {\n        return true;\n    }\n\n    // Compare null\n    if (a === null || b === null) {\n        return a === b;\n    }\n\n    // Compare number, boolean, string, undefined\n    if (typeof a !== 'object' || typeof b !== 'object') {\n        return a === b;\n    }\n\n    // Compare arrays\n    if (isArray(b) && isArray(a)) {\n        if (a.length !== b.length) {\n            return false;\n        }\n\n        let k = a.length;\n        while (k--) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    const checked = {};\n    const objectB = b as Object;\n    for (const k in objectB) {\n        if (objectB.hasOwnProperty(k)) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n\n            checked[k] = true;\n        }\n    }\n\n    const objectA = a as Object;\n    for (const k in objectA) {\n        if (objectA.hasOwnProperty(k)) {\n            if (!checked[k] && !isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    return true;\n}\n\nexport interface IUserProfile {\n    username?: string;\n    email?: string;\n    role?: string;\n    displayName?: string;\n}\n\n// immutable\n\n@observableDecorator\nexport class UserCredential<T extends IPolicy> {\n\n    private _security: T;\n    private _user: IUserProfile;\n    /**\n     * @constructor Credential\n     */\n    constructor(public authPolicy: T) {\n        this._user = {};\n        this._security = authPolicy;\n    }\n\n    public get asObservable(): IObservable {\n        const self: any = this;\n        return self as IObservable;\n    }\n\n    public security(value?: T): T {\n        if (value) {\n            this._security = value;\n        }\n        return this._security;\n    }\n\n    // Does not trigger any event\n    readFrom<U extends IUserProfile>(data: U): void {\n        this._user = _.extend(this._user, data);\n    }\n\n    setUser<U extends IUserProfile>(data: U): void {\n        if (isEquiva(this._user, data)) {\n            return;\n        }\n\n        this._user = data;\n        this.asObservable.fire('change:user', {\n            data: this._user\n        });\n    }\n\n    extendUser<U extends IUserProfile>(data: U): void {\n        const newData = _.extend({}, this._user, data);\n        this.setUser(newData);\n    }\n\n    getUser<U extends IUserProfile>(): U {\n        return _.extend({}, this._user);\n    }\n\n    subscribe<U extends IUserProfile>(handler: (evt: IEventArgs<U>) => IEventArgs<U>, likeBehaviorSubject: boolean = false) {\n        this.asObservable.on('change:user', handler);\n\n        if (likeBehaviorSubject) {\n            const newEvt: any = { data: this._user };\n            handler(newEvt as IEventArgs<U>);\n        }\n    }\n\n    unSubscribe(handler: (evt: any) => any) {\n        this.asObservable.off('change:user', handler);\n    }\n\n    isUserKnown(): boolean {\n        return !!(this._user && this._user.username);\n    }\n\n    isAuthenticated(): boolean {\n        return this.authPolicy && !this.authPolicy.isExpired();\n    }\n}\n\n","/**\n * @fileOverview\n * Provides the anti-forgery security policy.\n * @name AntiForgeryKeyPolicy.js\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { liftWithGuard } from '@polpware/fe-utilities';\n\nimport { IAntiForgeryKeyCtorOptions } from './interfaces';\n\nimport { PolicyBase } from './policy-base';\n\nconst $ = dependencies.jquery;\nconst defaultAntiForgeryKey = '__RequestVerificationToken';\nconst defaultElementTag = '';\n\n/*\n <input name=\"__RequestVerificationToken\" type=\"hidden\"\n value=\"J8kl6w7KaBAteKOPeHW1IlG9RS7abCkbvQf2GwBlMVZZOX9FF-Bhc5mYmqXw4qe0MLraucQtKC-TAVh1rJEZ0SDfeLfqp-L5JrthIM9V0gp76-jnVz9J-rdYFhVeTT4Y0\">\n */\nfunction getTokenInternal(url: string, elementTag: string, inputField: string): PromiseLike<string> {\n    return $.ajax({\n        url: url, // A page containing required tokens\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        let doc, token, elm;\n        token = '';\n        doc = new DOMParser().parseFromString(data, 'text/html');\n        if (elementTag) {\n            elm = $(doc).find(elementTag);\n            if (elm.length > 0) {\n                elm = $(doc).find(inputField);\n                if (elm.length > 0) {\n                    elm = elm.eq(0);\n                    token = elm.attr('value');\n                }\n            }\n        } else {\n            elm = $(doc).find(inputField);\n            if (elm.length > 0) {\n                elm = elm.eq(0);\n                token = elm.attr('value');\n            }\n        }\n        return token;\n    });\n}\n\nexport class AntiForgeryKeyPolicy extends PolicyBase {\n\n    private _antiForgeryKey: string;\n    private _elementTag: string;\n    private _expired: boolean;\n\n    /**\n     * @constructor AntiForgeryKeyPolicy\n     * @param {Object} [settings] A set of settings.\n     */\n    constructor(settings: IAntiForgeryKeyCtorOptions) {\n        super(settings);\n        this._antiForgeryKey =\n            settings.antiForgeryKey || defaultAntiForgeryKey;\n        this._elementTag = settings.elementTag || defaultElementTag;\n        this._expired = true;\n    }\n\n    isExpired(): boolean {\n        return this._expired;\n    }\n\n    inputField(): string {\n        return 'input[name=\"' + this._antiForgeryKey + '\"]';\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     * @function readFrom\n     * @param {Object} settings\n     * @returns {Object}\n     */\n    readFrom(settings) {\n        this.token = settings.token;\n    }\n\n    /**\n     * Returns the object that are persistentable.\n     * @function persistent\n     * @returns {Object}\n     */\n    persistent() {\n        return {\n            token: this.token\n        };\n    }\n\n    /**\n     * Gets the anti-forgery token from the given url\n     * or the instance url.\n     * @function getTokenP\n     * @param {String}[url] The URL where the response from it may contain\n     * the anti-forgery token; it is optional and used when you want to\n     * overwrite the instance url.\n     * @returns {Promise}\n     * @throws {}\n     */\n    getTokenInternal(): PromiseLike<string> {\n        const ret = getTokenInternal(this.url, this._elementTag, this.inputField());\n        const p = liftWithGuard(ret, function(token) {\n            const isGoodToken = token && token.length > 0;\n            this._expired = !isGoodToken;\n            return isGoodToken;\n        });\n        return ret;\n    }\n\n    /**\n     * Applys the anti-forgery key and its value to the given options.\n     * @function apply\n     * @param {Object} options The options to be used for making a request.\n     */\n    applyTo(options) {\n        const data = options.data;\n        data[this._antiForgeryKey] = this.token;\n    }\n\n    /**\n     * Apply security policy to the given options.\n     * @function applyToV2\n     * @param {Object} options A params field is expected.\n     */\n    applyToV2(options) {\n        options.params = options.params || {};\n        options.params[this._antiForgeryKey] = this.token;\n    }\n\n    // TODO:\n    applyToV3(options) {\n    }\n\n    /**\n     * Resets the token and expired flag\n     * @function reset\n     */\n    reset() {\n        super.reset();\n        this._expired = true;\n    }\n}\n","import {\r\n    IOAuthTokenPolicyCtorOptions\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy } from './oauth-token-policy';\r\nexport { adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport class OAuthTokenExtPolicy extends OAuthTokenPolicy {\r\n\r\n    private _payload: object;\r\n\r\n    constructor(settings: IOAuthTokenPolicyCtorOptions, payload: object) {\r\n        super(settings);\r\n\r\n        this._payload = { ...payload };\r\n    }\r\n\r\n    public get payload(): object {\r\n        return this._payload;\r\n    }\r\n\r\n    // override\r\n    getParams(): any {\r\n        const p = super.getParams();\r\n        return { ...p, ... this._payload };\r\n    }\r\n}\r\n","import {\r\n    CollectionActionWithPayload,\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from '../collection-action-def';\r\n\r\nexport function reducer<T extends ICollectionItem>(\r\n    state: ICollectionState<T>,\r\n    action: CollectionActionWithPayload<T>\r\n): ICollectionState<T> {\r\n    switch (action.type) {\r\n\r\n        case 'ADD': {\r\n\r\n            const payload = action.payload.filter(x => {\r\n                // Look for it in the current list\r\n                const index = state.items.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: [\r\n                    ...state.items,\r\n                    ...payload\r\n                ]\r\n            };\r\n        }\r\n\r\n        case 'REMOVE': {\r\n\r\n            const newItems = state.items.filter(x => {\r\n                const index = action.payload.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: newItems\r\n            };\r\n        }\r\n\r\n        case 'MODIFY': {\r\n\r\n            // Nothing to do\r\n            return state;\r\n        }\r\n\r\n        default:\r\n            return state;\r\n\r\n    }\r\n}\r\n","import { ActionReducerMap } from '@ngrx/store';\r\nimport { combineReducers } from '@ngrx/store';\r\n\r\nimport { ICollectionState, ICollectionItem } from '../collection-action-def';\r\nimport * as fromCollection from './collection.reducer';\r\n\r\n\r\nexport interface GenericState<T extends ICollectionItem> {\r\n    collection: ICollectionState<T>;\r\n}\r\n\r\nexport function buildInitialState<T extends ICollectionItem>(): GenericState<T> {\r\n    return {\r\n        collection: {\r\n            items: []\r\n        }\r\n    };\r\n}\r\n\r\nexport function buildReducerMap<T extends ICollectionItem>(): ActionReducerMap<GenericState<T>> {\r\n    return {\r\n        collection: fromCollection.reducer\r\n    };\r\n}\r\n\r\n\r\n","import * as ngrxStore from '@ngrx/store';\r\n\r\nimport { ICollectionItem } from './collection-action-def';\r\n\r\nimport * as reducerIndex from './reducers/index';\r\n\r\n// Store\r\n/*\r\n    ReducerManager,\r\n    StateObservable,\r\n    ActionsSubject\r\n*/\r\n\r\n// StateObservable\r\n/*\r\n   ActionsSubject\r\n   ReducerManager\r\n   ScannnedActionsSubject => leaf\r\n   InitialState\r\n*/\r\n\r\n// ActionsSubject (leaf)\r\n\r\n// ReducerManager\r\n/*\r\n   ReducerManagerDispatcher\r\n   INITIAL_STATE  => pass in parameters\r\n   INITIAL_REDUCERS => ActionReducerMap (pass in parameters)\r\n   REDUCER_FACTORY => combineReducers\r\n   ActionReducerFactory<any, any>\r\n*/\r\n\r\n// ReducerManagerDispatcher\r\n\r\n/*\r\n   ActionSsubject  (leaf)\r\n*/\r\n\r\n// ActionReducerFactory<any, any> (Use combinReducer function from utils)\r\n\r\n/*\r\n   ActionReducerMap\r\n   initialState\r\n\r\n   ActionReducer\r\n*/\r\n\r\n// createReducerfactory\r\n/*\r\n   ActionReducerFactory\r\n   MataReducerFactory\r\n\r\n*/\r\n\r\nexport function factory<T extends ICollectionItem>(): ngrxStore.Store<reducerIndex.GenericState<T>> {\r\n\r\n    const actionSubject = new ngrxStore.ActionsSubject();\r\n    const scannerActionSubject = new ngrxStore.ScannedActionsSubject();\r\n    const reducerManagerDispatch: ngrxStore.ReducerManagerDispatcher = actionSubject;\r\n\r\n    const actionReducerFactory: ngrxStore.ActionReducerFactory<any, any> = ngrxStore.combineReducers;\r\n\r\n    const reducerManager = new ngrxStore.ReducerManager(actionSubject,\r\n        reducerIndex.buildInitialState<T>(),\r\n        reducerIndex.buildReducerMap<T>(),\r\n        actionReducerFactory);\r\n\r\n    const stateObservable = new ngrxStore.State(actionSubject,\r\n        reducerManager,\r\n        scannerActionSubject,\r\n        reducerIndex.buildInitialState<T>());\r\n\r\n    const store = new ngrxStore.Store<reducerIndex.GenericState<T>>(stateObservable, actionSubject, reducerManager);\r\n    return store;\r\n}\r\n","import { Store } from '@ngrx/store';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ICollectionState, ICollectionItem } from './collection-action-def';\r\n\r\nimport { ICollectionStore } from './collection-store.interface';\r\nimport { GenericState } from './reducers';\r\n\r\nexport abstract class CollectionAbstractStore<T extends ICollectionItem> implements ICollectionStore<T> {\r\n\r\n    public abstract getState(): Observable<ICollectionState<T>>;\r\n    public abstract getStore(): Store<GenericState<T>>;\r\n\r\n    public add(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'ADD',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public remove(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'REMOVE',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public modify(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'MODIFY',\r\n            payload: payload\r\n        });\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Store, } from '@ngrx/store';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { factory } from './factory';\r\n\r\nimport { GenericState } from './reducers/index';\r\nimport {\r\n    CollectionAbstractStore\r\n} from './collection-abstract.store';\r\n\r\nimport {\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from './collection-action-def';\r\n\r\n\r\n@Injectable()\r\nexport class CollectionStore<T extends ICollectionItem>\r\n    extends CollectionAbstractStore<T> {\r\n\r\n    private _store: Store<GenericState<T>>;\r\n\r\n    constructor() {\r\n        super();\r\n        this._store = factory<T>();\r\n    }\r\n\r\n    public getStore(): Store<GenericState<T>> {\r\n        return this._store;\r\n    }\r\n\r\n    public getState(): Observable<ICollectionState<T>> {\r\n        return this._store.select('collection');\r\n    }\r\n}\r\n","/**\n * @fileOverview\n * An endpoint which aggregates a few other endpoints, to form a new endpoint.\n * Note that the caller is responsible for resetting underlying data providers\n * and even caching them.\n * Moreover, this class does not assume any knowledge about providerGenerator.\n * providerGenerator may generate the same thing again as again.\n * Also note that it is the provider generator's responsibilty for\n * preversing the state of each data provider.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IBackboneCollectionLike } from '../interfaces/backbone.interface';\n\nconst when = dependencies.when;\nconst _ = dependencies.underscore;\n\nfunction hasNextPage(collection: IBackboneCollectionLike): boolean {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return true;\n    }\n    return collection.hasNextPage();\n}\n\nfunction getNextPage(collection: IBackboneCollectionLike): PromiseLike<any> {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return collection.getFirstPage();\n    }\n    return collection.getNextPage();\n}\n\nexport interface IProviderGenerator {\n    hasMore(): boolean;\n    getNext(): PromiseLike<Array<IBackboneCollectionLike>>;\n    reset(): void;\n}\n\nexport class AggregateCollection {\n\n    private _workingProviders: Array<IBackboneCollectionLike>;\n\n    constructor(private _providerGenerator: IProviderGenerator) {\n        this._workingProviders = [];\n    }\n\n    hasNextPage(): boolean {\n        // Case 1: The first time we request, we always have something.\n        if (this._workingProviders.length === 0) {\n            return true;\n        }\n        if (this._providerGenerator.hasMore()) {\n            return true;\n        }\n        return _.some(this._workingProviders, function(elem) {\n            return elem.hasNextPage();\n        });\n    }\n\n    getFirstPage(): PromiseLike<any> {\n        // Generate providers\n        return this._providerGenerator.getNext()\n            .then((providers) => {\n                providers = _.filter(providers, function(p) {\n                    return hasNextPage(p);\n                });\n                return providers;\n            })\n            .then((providers) => {\n                this._workingProviders.length = 0;\n                const promises = _.map(providers, function(p) {\n                    return getNextPage(p)\n                        .then((resp) => {\n                            this._workingProviders.push(p);\n                            return resp;\n                        });\n                });\n                return when.settle(promises);\n            });\n    }\n\n    getNextPage(): PromiseLike<any> {\n        return this.getFirstPage();\n    }\n\n    reset(): void {\n        this._providerGenerator.reset();\n        this._workingProviders = [];\n    }\n\n    forEach(func: (elem: any) => any) {\n        this._workingProviders.forEach((p) => {\n            p.forEach(func);\n        });\n    }\n\n    get(id) {\n        // TODO:\n    }\n}\n\n","/**\n * @fileOverview\n * A decorator to Backbone. It tracks all sync events of the Backbone\n * in a nonintrusive manner.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst backbone = dependencies.backbone;\nconst meld = dependencies.meld;\n\n/**\n * The callback for the sync event.\n * @callback EventHubcallback\n * @param {Object} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} response The response assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a callback for listening to the sync events from Backbone.\n * @function mountSyncListener\n * @param {EventHubcallback} callback\n * @throws {Error}\n */\nexport function mountSyncListener(callback) {\n    // Collection\n    const remover1 = meld.before(backbone.Collection.prototype, 'trigger', callback);\n    const remover2 = meld.before(backbone.Model.prototype, 'trigger', callback);\n    return [remover1, remover2];\n}\n\n/**\n * The callback for the sync event.\n * @callback EventHubsyncSignature\n * @param {String} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a pre-sync callback.\n * @function mountSyncBeforeAdvice\n * @param {EventHubsyncSignature} callback\n */\nexport function mountSyncBeforeAdvice(callback) {\n    return meld.before(backbone, 'sync', callback);\n}\n\n/**\n * The signature for the around advice.\n * @callback EventHubaroundAdviceSignature\n * @param {String} jointpoint the jointpoint for this advice.\n */\n\n/**\n * Sets up an around advice.\n * @function mountSyncAroundAdvice\n * @param {EventHubaroundAdviceSignature} callback\n */\nexport function mountSyncAroundAdvice(callback) {\n    return meld.around(backbone, 'sync', callback);\n}\n\n\n/**\n * Sets up a pre-ajax callback.\n * @function mountAjaxBeforeAdvice\n * @param {Function} callback\n */\nexport function mountAjaxBeforeAdvice(callback) {\n    return meld.before(backbone, 'ajax', callback);\n}\n\n","/**\n * @fileOverview\n * Provides a layer of backend service abstraction.\n * Defines the backend services. This class is built onto the backbone js, but with\n * enhanced abilities of managing the dependency among all services of the backend,\n * and caching some type of objects for a period of time.\n */\n/*jslint unparam: true */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nimport { SlidingExpirationCache } from '../cache/sliding-expiration-cache';\n\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\n\nimport {\n    mountSyncBeforeAdvice,\n    mountAjaxBeforeAdvice,\n    mountSyncAroundAdvice\n} from './event-hub';\n\nimport { IBackboneOptions, IBackboneConfiguration } from './interfaces';\n\nconst DataFlow = dependencies['dataflow'];\nconst backbone = dependencies['backbone'];\nconst _ = dependencies.underscore;\n\n/**\n * The endpoint types for a backend service.\n */\nexport const endPointEnum = {\n    model: 1,\n    collection: 2,\n    pagedCollection: 3\n};\n\n/**\n * The sync types defined in the backbone js.\n */\nexport const syncMethodEnum = {\n    /**\n     * Fetch a model or a collection.\n     */\n    read: 'read',\n    /**\n     * Save a model.\n     */\n    create: 'create',\n    patch: 'patch',\n    update: 'update',\n    /**\n     * Destroy a model\n     */\n    delete: 'delete'\n};\n\nconst globalConfigurationMapping: { [key: string]: IBackboneConfiguration } = {};\nconst mountedFeatureRemovers: any[] = [];\n\n// Idempotent\n// Instance once ...\nfunction mountFeatures() {\n\n    if (mountedFeatureRemovers.length > 0) {\n        return;\n    }\n    /*jslint unparam: true */\n    /*\n      eventHub.mountSyncListener(function (method, model, response, options) {\n      // Ignore other method\n      if (method !== 'sync') {\n      return;\n      }\n      if (options.endPointKey && options.methodKey) {\n      var dataflow = self._dataflow,\n      key = options.endPointKey + ':' + options.methodKey;\n      dataflow[key] = dataflow[key] + 1;\n      }\n      }); */\n\n    let remover = mountSyncBeforeAdvice(function(method, model, options) {\n        options.methodKey = method;\n        options.endPointKey = model.endPointKey || (model.collection ? model.collection.endPointKey : null);\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (method === 'delete') {\n                if (cfgOptions.deleteUrl) {\n                    options.url = cfgOptions.deleteUrl;\n                }\n                if (cfgOptions.deleteContentType) {\n                    options.contentType = cfgOptions.deleteContentType;\n                }\n            } else if (method === 'update') {\n                if (cfgOptions.updateUrl) {\n                    options.url = cfgOptions.updateUrl;\n                }\n                if (cfgOptions.updateContentType) {\n                    options.contentType = cfgOptions.updateContentType;\n                }\n            } else if (method === 'create') {\n                if (cfgOptions.createUrl) {\n                    options.url = cfgOptions.createUrl;\n                }\n                if (cfgOptions.createContentType) {\n                    options.contentType = cfgOptions.createContentType;\n                }\n            } else if (method === 'patch') {\n                if (cfgOptions.patchUrl) {\n                    options.url = cfgOptions.patchUrl;\n                }\n                if (cfgOptions.patchContentType) {\n                    options.contentType = cfgOptions.patchContentType;\n                }\n            }\n        }\n    });\n\n    mountedFeatureRemovers.push(remover);\n    remover = mountAjaxBeforeAdvice(function(options) {\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            const policyDelegate = cfgOptions.securityDelegate;\n            const extraParams = cfgOptions.extraParams;\n            if (cfgOptions.contentType === 'application/x-www-form-urlencoded' &&\n                options.contentType === 'application/json') {\n                options.data = JSON.parse(options.data);\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                options.data = urlEncode(options.data);\n                options.contentType = cfgOptions.contentType;\n            } else {\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                if (options.contentType === 'application/x-www-form-urlencoded') {\n                    options.data = urlEncode(options.data);\n                }\n            }\n        }\n    });\n    mountedFeatureRemovers.push(remover);\n\n    remover = mountSyncAroundAdvice(function(jointpoint: IJoinpoint) {\n        const options = jointpoint.args[2];\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (cfgOptions.syncDelegate) {\n                const syncDelegate = cfgOptions.syncDelegate;\n                // Return a promise\n                return syncDelegate(options.endPointKey, options, cfg, function() {\n                    return jointpoint.proceed();\n                });\n            }\n        }\n        return jointpoint.proceed();\n    });\n    mountedFeatureRemovers.push(remover);\n}\n\nconst defaultLivePeroid = 60 * 5;\n\nexport interface IGlobalProviderCtorOptions {\n    webhost?: string;\n}\n\nexport class GlobalProvider {\n\n    private _host: string;\n    private _dataflow: any;\n    private _cache: SlidingExpirationCache<any>;\n    private _myEndPointKeys: any[];\n    private _uniqueNamePrefix: string;\n\n    constructor(ctorOptions: IGlobalProviderCtorOptions) {\n        this._cache = new SlidingExpirationCache(defaultLivePeroid);\n        this._dataflow = new DataFlow();\n        this._myEndPointKeys = [];\n        this._host = ctorOptions.webhost || '';\n        this._uniqueNamePrefix = this._host ? (this._host.replace('.', '-') + '-') : '';\n\n        // Mount features\n        mountFeatures();\n    }\n\n    public get host(): string {\n        return this._host;\n    }\n\n    public get configurationMapping(): { [key: string]: any } {\n        return globalConfigurationMapping;\n    }\n\n    /**\n     * Defines an endpoint for a kind of service.\n     */\n    addEndPoint(name: string, tag: number, options: IBackboneOptions) {\n        const cfgMapping = this.configurationMapping;\n        const dataflow = this._dataflow;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (cfgMapping[uniqueName]) {\n            throw new Error('Redefined endpoint: ' + name);\n        }\n        cfgMapping[uniqueName] = {\n            options: _.extend(options, { endPointKey: uniqueName }),\n            tag: tag\n        };\n\n        this._myEndPointKeys.push(uniqueName);\n\n        // Set up data flow nodes (it is enough to use local names)\n        if (tag === endPointEnum.model) {\n            for (const k in syncMethodEnum) {\n                // skip loop if the property is from prototype\n                if (syncMethodEnum.hasOwnProperty(k)) {\n                    const value = syncMethodEnum[k];\n                    dataflow[name + ':' + value] = 1;\n                }\n            }\n        } else {\n            dataflow[name + ':' + syncMethodEnum.read] = 1;\n        }\n    }\n\n    /**\n     * Retrieves the endpoint by the given name.\n     */\n    getEndPoint(name: string, ignoreCache?: boolean) {\n        const cache = this._cache;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (ignoreCache !== true) {\n            const cachedValue = cache.get(uniqueName);\n            if (cachedValue) {\n                return cachedValue;\n            }\n        }\n\n        const cfgMapping = this.configurationMapping;\n\n        const cfg = cfgMapping[uniqueName];\n        if (!cfg) {\n            const error = new Error('No given endpoint is defined for: ' + name);\n            throw error;\n        }\n\n        let value = null;\n        if (cfg.tag === endPointEnum.model) {\n            value = backbone.Model.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.collection) {\n            value = backbone.Collection.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.pagedCollection) {\n            value = backbone.PageableCollection.extend(cfg.options);\n        } else {\n            throw new Error('Not implemented');\n        }\n\n        if (ignoreCache !== true) {\n            cache.set(uniqueName, value, defaultLivePeroid);\n        }\n        return value;\n    }\n\n    /**\n     * Get the underlying configuration for an endpoint.\n     */\n    getConfiguration(endPointKey: string) {\n        const uniqueName = this._uniqueNamePrefix + endPointKey;\n        const cfgMapping = this.configurationMapping;\n        return cfgMapping[uniqueName];\n    }\n\n    /**\n     * Provides the callback when some operations happen.\n     */\n    addWhenCallback(name: string[], callback: any) {\n        const dataflow = this._dataflow;\n        dataflow.when(name, callback);\n    }\n\n    /**\n     * Defines the dependency.\n     */\n    addDependency(src: string, dst: string) {\n        const dataflow = this._dataflow;\n        dataflow.on(src, function() {\n            dataflow[dst] = dataflow[dst] + 1;\n        });\n    }\n\n    /**\n     * Clean up all cached data provider\n     */\n    cleanupCache() {\n        // Remove what we have in cache\n        this._cache.reset();\n    }\n\n    cleanMountedFeatures() {\n        mountedFeatureRemovers.forEach(function(remover) {\n            remover.remove();\n        });\n        mountedFeatureRemovers.length = 0;\n    }\n\n    /**\n     * Destroy the provider to release resources\n     */\n    destroy() {\n        // Delete cache\n        this._myEndPointKeys.forEach(function(k) {\n            delete globalConfigurationMapping[k];\n        });\n\n        this._myEndPointKeys.length = 0;\n\n        this._cache.destroy();\n\n        // No destroy methods for the following two instances.\n        this._cache = null;\n        this._dataflow = null;\n        this._host = null;\n        this._uniqueNamePrefix = null;\n    }\n}\n\n\n\n","/**\n * @fileOverview\n * Provides type-safety operations of manipulating LocalStorage data.\n * @name LocalStorageUtil.js\n * @module hypercom/storage/LocalStorageUtil\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as externalInterface from '@polpware/fe-dependencies';\n// as polyfill for localstorage\n// Do NOT use the LocalStorage as there is global variable which cannot be resolved\n// and which is defined only in TINYMCE.\n// import * as localStorage from 'polpware-tinymce-tailor/src/util/LocalStorage.js';\n\nconst globalLocalStorage = window.localStorage;\n\nimport {\n    defaultValue,\n    ITypeDef,\n    tyArray,\n    ok as isType\n} from '@polpware/fe-utilities';\n\nconst _ = externalInterface.underscore,\n    find = _.find,\n    findIndex = _.findIndex,\n    union = _.union;\n\nexport interface IEntity {\n    Id: any;\n}\n\n/**\n * Reads the value of an entity by its key.\n * @function getEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n * @returns {*} The entity value.\n */\n\nexport function getEntity(key: string, ty: ITypeDef): any {\n    let data = defaultValue(ty);\n    try {\n        let tmp = globalLocalStorage.getItem(key);\n        if (tmp && tmp !== 'undefined') {\n            tmp = JSON.parse(tmp);\n            if (isType(tmp, ty)) {\n                data = tmp;\n            }\n        }\n    } catch (ex) {\n        console.log(ex);\n    }\n    return data;\n}\n/**\n * Updates the value of an entity by its key.\n * @function updateEntity\n * @param {String} key The entity key.\n * @param {*} data The new value to be replaced with.\n * @param {*} ty The type of the entity value.\n */\nexport function updateEntity(key: string, data: any, ty: ITypeDef = null) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(data));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Cleans the value of an entity by its key.\n * @function cleanEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n */\nexport function cleanEntity(key: string, ty: ITypeDef) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(defaultValue(ty)));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Inserts the given data into the value of an entity of type array.\n * Note that the inserted data should be disjoint with the current data\n * stored in this entity. Otherwise, the behavior may be undefined.\n * @function insertEntities\n * @param {String} key The entity key.\n * @param {Array} data The value to be inserted.\n * @param {Number} upperBound The max number of elements allows for this entity value.\n */\nexport function insertEntities(key: string, data: Array<IEntity>, upperBound: number) {\n    let newData = [];\n    const currentData = getEntity(key, tyArray) as Array<IEntity>;\n    if (upperBound > 0 && currentData.length > upperBound) {\n        newData = data;\n    } else {\n        newData = union(currentData, data);\n    }\n    updateEntity(key, newData, tyArray);\n}\n/**\n * Finds one element of an entity of type array.\n * @function findEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value. An Id field is assumed for each element.\n * @returns {*} The value of the found element.\n */\nexport function findEntityById(key: string, id): IEntity {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    return find(data, { Id: id });\n}\n\n/**\n * Removes an element of an entity of type array.\n * @function removeEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value for the element to be removed.\n */\nexport function removeEntityById(key: string, id) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: id });\n    if (index === -1) {\n        return;\n    }\n    data.splice(index, 1);\n    updateEntity(key, data, tyArray);\n}\n/**\n * Inserts or udpates an element of an entity of type array.\n * @function insertOrUpdateEntity\n * @param {String} key The entity key.\n * @param {Array} entity The new value of the entity.\n */\nexport function insertOrUpdateEntity(key: string, entity: IEntity) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: entity.Id });\n    if (index !== -1) {\n        data[index] = entity;\n    } else {\n        data.push(entity);\n    }\n    updateEntity(key, data, tyArray);\n}\n/**\n * Removes a group of entities by a given prefix.\n * @function cleanEntityGroup\n * @param {String} prefix The prefix of the keys of the entities to be removed. We organize entities somewhat hirarchly.\n * @returns {Boolean}\n */\nexport function cleanEntityGroup(prefix: string): Array<string> {\n    const keys = [];\n    for (const p in globalLocalStorage) {\n        if (globalLocalStorage.hasOwnProperty(p) &&\n            p.indexOf(prefix) === 0) {\n            keys.push(p);\n        }\n    }\n    if (keys.length === 0) {\n        return keys;\n    }\n    keys.forEach(function(k) {\n        globalLocalStorage.removeItem(k);\n    });\n    return keys;\n}\n","/**\n * @fileOverview\n * Encapsulates the local storage service into one\n * providing prmoise-aware services.\n * @name LocalStorageTable.js\n * @module hypercom/storage/LocalStorageTable\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as polpwareUtil from '@polpware/fe-utilities';\n\nimport * as localStorageUtil from './localstorage-util';\n\n/**\n * @class LocalStorageTable\n */\nexport class LocalStorageTable {\n\n    /**\n     * Gets the value for the given key.\n     * @function getP\n     * @param {String} key The key to be searched for.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    getP(key: string): PromiseLike<object> {\n        const data = localStorageUtil.getEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(data, null);\n    }\n\n    /**\n     * Removes the key from the keychain.\n     * @function removeP\n     * @param {String} key The key to be removed.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    removeP(key: string): PromiseLike<boolean> {\n        localStorageUtil.cleanEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n    /**\n     * Updates the value for the given key.\n     * @param {String} key The key to be searched for.\n     * @param {Object} value The new value.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    updateP(key: string, value: object): PromiseLike<boolean> {\n        localStorageUtil.updateEntity(key, value, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n}\n","/**\n * @fileOverview\n * Provides i18n service. This module is designed as\n * a delegate of the tinymce I18n service.\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst _i18n = dependencies.I18n;\n\nexport class I18n {\n\n    static getDictByCode(code: string) {\n        return _i18n.data[code];\n    }\n\n    /**\n     * Add a languge dictionary and set the current\n     * code as the current language.\n     */\n    static add(code: string, items: any) {\n        _i18n.add(code, items);\n    }\n\n    /**\n     * Trnsaltes a given text. If the given text\n     * is missing in the dictionary, use the given default value.\n     * @function translate\n     * @param {String} text A text to be translated.\n     * @param {String} defaultText The default value.\n     * @returns {String} The translation for the given text.\n     */\n    static translate(text: string, defaultText: string) {\n        const value = _i18n.translate(text);\n        if (value === text && defaultText) {\n            return defaultText;\n        }\n        return value;\n    }\n\n    /**\n     * Removes unused languages to release memory.\n     * @function recycleOthers\n     * @param {String} code The language code which should not released.\n     */\n    static recycleOthers(code: string) {\n        const data = _i18n.data;\n        const recycleList = [];\n        for (const key in data) {\n            // skip loop if the property is from prototype\n            if (data.hasOwnProperty(key) && key !== code) {\n                recycleList.push(key);\n            }\n        }\n        /*jslint plusplus: true */\n        for (let i = 0; i < recycleList.length; i++) {\n            const k = recycleList[i];\n            delete data[k];\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a Resources class.\n * With this class, you may configure a bunch of resources\n * accessible from global URIs, such as URLs.\n * Once the requested resources are loaded, they may be\n * cached in the memory.\n * Note that the resources are expected to be organized in\n * a common namespace hierarchy.\n * E.g.,\n * x.y.z corresponds to a json resource like:\n *    {\n *       y: {\n *             z: 112\n *          }\n *    }\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\n\nimport * as externalInterface from '@polpware/fe-dependencies';\nimport { replace, lift, convert } from '@polpware/fe-utilities';\n\nimport { ISlidingExpireCache } from '../cache/sliding-expire-cache.interface';\n\nimport { loadJsonUriP } from '../net/curl';\n\n\nconst _ = externalInterface.underscore;\nconst isString = _.isString;\n\n\n/**\n * Retrieves a value from a variable by a given namespace nested structure.\n * @function getByNamespace\n * @param {Object} repo\n * @param {*} fullyQualifiedNamespace A string or an arry of string defining the namespace.\n * @param {Number}[] startLevel\n * @returns {*}\n */\nfunction getByNamespace<T>(repo: { [key: string]: T },\n    identifiers: Array<string>,\n    startLevel: number = 1): T {\n\n    const restIdentifiers = identifiers.slice(startLevel);\n    const restKey = restIdentifiers.join('.');\n    if (repo[restKey]) {\n        return repo[restKey];\n    }\n\n    let initRepo: any = repo;\n    for (let index = startLevel; index < identifiers.length; index++) {\n        if (!initRepo) {\n            break;\n        }\n        const key = identifiers[index];\n        initRepo = initRepo[key];\n    }\n    return initRepo;\n}\n\ninterface IConfigurationEntry {\n    uri: string;\n    liveSeconds: number;\n}\n\n/**\n * @class Resources\n */\nexport class ResourceLoader {\n\n    private _configuration: { [key: string]: IConfigurationEntry };\n\n    /**\n     * Constructor\n     * @function init\n     */\n    constructor(private _cache: ISlidingExpireCache<any> = null) {\n        this._configuration = {};\n    }\n\n    /**\n     * Configure a resource\n     * @function register\n     * @param {String} key The resource key.\n     * @param {String} uri The resource URI.\n     * @param {Number} liveSeconds The cache period.\n     * @throws {Error}\n     */\n    register(key: string, uri: string, liveSeconds: number = 60) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            throw new Error('Registering an existing resource key: ' + key);\n        }\n        configuration[key] = {\n            uri: uri,\n            liveSeconds: liveSeconds\n        };\n    }\n\n    /**\n     * Removes a registered item\n     * @function undoRegister\n     * @param {String} key The resource key to be removed.\n     */\n    undoRegister(key: string) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            delete configuration[key];\n        }\n    }\n    /**\n     * Returns a promise for the resource key.\n     * @function getPromise\n     * @param {String} fullyQualifiedNamespace The resource key.\n     * @returns {*} The resource value.\n     * @throws {Error}\n     */\n    getPromise<T>(fullyQualifiedNamespace: string,\n        convertor: (any) => any): PromiseLike<T> {\n        const identifiers = fullyQualifiedNamespace.split('.');\n        const topIdentifier = identifiers[0];\n        const cache = this._cache;\n        if (cache) {\n            // Figure out the master key\n            const repo = cache.get(topIdentifier, 60);\n            if (repo) {\n                const value = getByNamespace<T>(repo, identifiers);\n                if (value) {\n                    // Return a promise\n                    return lift(value, null);\n                }\n            }\n        }\n\n        const entry = this._configuration[topIdentifier];\n        if (!entry) {\n            throw new Error('Get unregistered resource: ' + topIdentifier);\n        }\n\n        // Otherwise, load it\n        return loadJsonUriP(entry.uri).then((content) => {\n            content = convertor(content);\n            // Cache the new value\n            if (cache) {\n                cache.set(topIdentifier, content, entry.liveSeconds);\n            }\n            return getByNamespace(content, identifiers);\n        });\n    }\n}\n"]}