{"version":3,"sources":["../../../../node_modules/tslib/tslib.es6.js","ng://@polpware/fe-data/lib/relational/table.ts","ng://@polpware/fe-data/lib/relational/dummy-records.ts","ng://@polpware/fe-data/lib/relational/database.ts","ng://@polpware/fe-data/lib/net/xhr-promise.ts","ng://@polpware/fe-data/lib/net/curl.ts","ng://@polpware/fe-data/lib/cache/memory-backend.ts","ng://@polpware/fe-data/lib/decorators/observable.decorator.ts","ng://@polpware/fe-data/lib/cache/sliding-expiration-cache.ts","ng://@polpware/fe-data/lib/security/interfaces.ts","ng://@polpware/fe-data/lib/security/policy-base.ts","ng://@polpware/fe-data/lib/security/oauth-token-policy.ts","ng://@polpware/fe-data/lib/security/open-id-policy.ts","ng://@polpware/fe-data/lib/security/null-policy.ts","ng://@polpware/fe-data/lib/security/user-credential.ts","ng://@polpware/fe-data/lib/security/antiforgerykey-policy.ts","ng://@polpware/fe-data/lib/security/oauth-token-ext-policy.ts","ng://@polpware/fe-data/lib/generic-store/reducers/collection.reducer.ts","ng://@polpware/fe-data/lib/generic-store/reducers/index.ts","ng://@polpware/fe-data/lib/generic-store/factory.ts","ng://@polpware/fe-data/lib/generic-store/collection-abstract.store.ts","ng://@polpware/fe-data/lib/generic-store/collection.store.ts","ng://@polpware/fe-data/lib/backend/aggregate-collection.ts","ng://@polpware/fe-data/lib/backend/event-hub.ts","ng://@polpware/fe-data/lib/backend/provider.ts","ng://@polpware/fe-data/lib/storage/localstorage-util.ts","ng://@polpware/fe-data/lib/storage/localstorage-table.ts","ng://@polpware/fe-data/lib/i18n/dict.ts","ng://@polpware/fe-data/lib/i18n/resource-loader.ts"],"names":["extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__extends","__","this","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__decorate","decorators","target","key","desc","c","r","getOwnPropertyDescriptor","Reflect","decorate","defineProperty","__metadata","metadataKey","metadataValue","metadata","__read","o","m","Symbol","iterator","e","ar","next","done","push","value","error","__spread","concat","backbone","dependencies.backbone","_","dependencies.underscore","cjs","dependencies.constraintjs","RelationalTable","options","dummyRecords","_this","_name","name","_cascade","_foreignRelation","_reverseForeignRelation","dataProviderCtor","_dataProvider","ctor","Collection","extend","dataProviderCtorOption","_addConstraint","constraint","_deleteConstraint","_onDeletedHandler","args","_i","onDeleted","onChange","dataProvider","hasAnyReference","item","get","id","revRelations","hasFound","revK","revTables","some","fromTable","fromTableDataProvider","filter","findWhere","removeReverseForeign","removedItems","revRelation","forEach","reverseTable","toBeRemoved","anyItems","where","pushArray","destroyFromTable","thatItem","removedItem","remove","set","trigger","getForeignModel","foreignKey","attributes","getDummyRecord","add","model","selfContext","modelId","addedItem","newAttr","addMany","models","map","addForeignRelation","foreignTable","Error","addReverseForeignRelation","reverseForeignKey","table","reverseTables","findIndex","elem","hasForeignRelation","hasReverseForeignRelation","destroy","offChange","reset","DummyRecords","_data","Model","RelationDatabase","_referenceCounter","_tableCollection","_dummyRecords","getReference","addTable","getTable","addForeignkey","foreignName","k","XHR","dependencies.XHR","defaultOptions","async","content_type","response_type","requestheaders","success_scope","error_scope","scope","tools","dependencies.Tools","$","dependencies.jquery","loadJsonUriP","url","ajax","cache","dataType","MemoryBackend","_store","keys","index","enabled","EventDispatcher","dependencies.EventDispatcher","getEventDispatcher","obj","_eventDispatcher","toggleEvent","state","isNative","toggleNativeEvent","observableDecorator","_super","class_1","tslib_1.__extends","fire","evt","bubble","removed","newEvt","parent","parent_1","isPropagationStopped","on","callback","prepend","off","once","hasEventListeners","has","locache","dependencies.locache","meld","dependencies.meld","originalRemove","getPrototypeOf","currentTime","Date","getTime","SlidingExpirationCache","_defaultSeconds","scheduleInterval","ngZone","backend","_cache","createCache","storage","around","input","onExpireEvtName","onExpireEventName","asObservable","isDefaultPrevented","resetExpireKey","proceed","afterRemoveEvtName","afterRemoveEventName","runOutsideAngular","_timeInterval","setInterval","cleanup","seconds","expirekey","ms","afterRemoveCallback","valueKey","hasExpired","rmOnExpireHandler","addOnExpireHandler","clearInterval","DummyOAuthTokenCtorParams","clientId","clientSecret","PolicyBase","settings","token","getTokenP","isEmpty","isExpired","getTokenInternal","then","lift","adaptToOAuthToken","data","expiresIn","createdOn","refreshToken","OAuthTokenPolicy","response","readFrom","persistent","getParams","client_id","client_secret","grant_type","grantType","params","method","resp","expires_in","safeParseInt","applyTo","beforeSend","xhr","setRequestHeader","applyToV2","headers","Authorization","applyToV3","OpenIDPolicy","_openId","openId","NullPolicy","UserCredential","authPolicy","_user","_security","security","setUser","isEquiva","a","isArray","checked","objectB","objectA","extendUser","newData","getUser","subscribe","handler","likeBehaviorSubject","unSubscribe","isUserKnown","username","isAuthenticated","defaultAntiForgeryKey","defaultElementTag","AntiForgeryKeyPolicy","_antiForgeryKey","antiForgeryKey","_elementTag","elementTag","_expired","inputField","ret","doc","elm","DOMParser","parseFromString","find","eq","attr","liftWithGuard","isGoodToken","OAuthTokenExtPolicy","payload","_payload","reducer","action","type","x","items","y","newItems","buildInitialState","collection","buildReducerMap","fromCollection.reducer","factory","actionSubject","ngrxStore.ActionsSubject","scannerActionSubject","ngrxStore.ScannedActionsSubject","actionReducerFactory","ngrxStore.combineReducers","reducerManager","ngrxStore.ReducerManager","reducerIndex.buildReducerMap","stateObservable","ngrxStore.State","ngrxStore.Store","CollectionAbstractStore","getStore","dispatch","modify","CollectionStore","getState","select","Injectable","when","dependencies.when","AggregateCollection","_providerGenerator","_workingProviders","hasNextPage","hasMore","getFirstPage","getNext","providers","totalPages","totalRecords","promises","getNextPage","settle","func","mountSyncBeforeAdvice","before","mountSyncAroundAdvice","mountAjaxBeforeAdvice","DataFlow","dependencies['dataflow']","dependencies['backbone']","endPointEnum","pagedCollection","syncMethodEnum","read","patch","update","delete","globalConfigurationMapping","mountedFeatureRemovers","defaultLivePeroid","GlobalProvider","ctorOptions","_dataflow","_myEndPointKeys","_host","webhost","_uniqueNamePrefix","replace","remover","methodKey","endPointKey","cfgOptions","deleteUrl","deleteContentType","contentType","updateUrl","updateContentType","createUrl","createContentType","patchUrl","patchContentType","policyDelegate","securityDelegate","extraParams","JSON","parse","urlEncode","jointpoint","cfg","syncDelegate","mountFeatures","addEndPoint","tag","cfgMapping","configurationMapping","dataflow","uniqueName","getEndPoint","ignoreCache","cachedValue","PageableCollection","getConfiguration","addWhenCallback","addDependency","src","dst","cleanupCache","cleanMountedFeatures","globalLocalStorage","window","localStorage","externalInterface.underscore","union","getEntity","ty","defaultValue","tmp","getItem","isType","ex","console","log","updateEntity","setItem","stringify","cleanEntity","LocalStorageTable","getP","localStorageUtil.getEntity","polpwareUtil.tyObject","polpwareUtil.lift","removeP","localStorageUtil.cleanEntity","updateP","localStorageUtil.updateEntity","_i18n","dependencies.I18n","I18n","getDictByCode","code","translate","text","defaultText","recycleOthers","recycleList","isString","getByNamespace","repo","identifiers","startLevel","restKey","slice","join","initRepo","ResourceLoader","_configuration","register","uri","liveSeconds","configuration","undoRegister","getPromise","fullyQualifiedNamespace","convertor","split","topIdentifier","entry","content","prefix","indexOf","removeItem","tyArray","Id","upperBound","currentData","entity","ajaxParams","splice","Promise","resolve","reject","xhrSettings","success","output","send"],"mappings":"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","sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)\r\n            t[p[i]] = s[p[i]];\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\r\n    if (m) return m.call(o);\r\n    return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n","/**\n * @fileOverview\n * Defines a table in a relational database.\n * This table is observable, i.e., any change on this table will be notified to its listeners.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\nimport { pushArray } from '@polpware/fe-utilities';\nimport {\n    IModelLike,\n    IBackboneCollectionLike,\n    IFullBackboneCollectionLike,\n    IFullModelLike\n} from '../interfaces/backbone.interface';\nimport { DummyRecords } from './dummy-records';\n\nconst backbone = dependencies.backbone;\nconst _ = dependencies.underscore;\nconst cjs = dependencies.constraintjs;\n\nexport interface IRelationalTableOptions {\n    name: string;\n    cascade?: boolean;\n    dataProviderCtor?: any;\n    dataProviderCtorOption?: any;\n}\n\nexport interface IRelationalTable {\n    name: string;\n    cascade: boolean;\n    dataProvider(): IFullBackboneCollectionLike;\n    get(id: any): IFullModelLike;\n    add(model: object): IFullModelLike;\n    addMany(models: any[]): IFullModelLike[];\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void;\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void;\n    hasForeignRelation(foreignKey: string): boolean;\n    hasReverseForeignRelation(reverseForeignKey: string): boolean;\n    destroy(): void;\n}\n\nexport class RelationalTable implements IRelationalTable {\n\n    private _name: string;\n    private _cascade: boolean;\n    private _addConstraint: any;\n    private _deleteConstraint: any;\n    private _foreignRelation: { [key: string]: IRelationalTable };\n    private _reverseForeignRelation: { [key: string]: IRelationalTable[] };\n\n    private _dataProvider: IFullBackboneCollectionLike;\n    private _onDeletedHandler: any;\n\n    constructor(options: IRelationalTableOptions,\n        public dummyRecords: DummyRecords) {\n\n        this._name = options.name;\n        this._cascade = false;\n\n        this._foreignRelation = {};\n        this._reverseForeignRelation = {};\n\n\n        if (options.dataProviderCtor) {\n            this._dataProvider = new options.dataProviderCtor();\n        } else {\n            const ctor = backbone.Collection.extend(options.dataProviderCtorOption || {});\n            this._dataProvider = new ctor();\n        }\n\n        this._addConstraint = cjs.constraint([]);\n        this._deleteConstraint = cjs.constraint([]);\n\n        // Todo: Figure out parameters\n        this._onDeletedHandler = (...args: any[]) => {\n            this.onDeleted();\n        };\n\n        // Set up constraint\n        this._deleteConstraint.onChange(this._onDeletedHandler);\n    }\n\n    public get name(): string {\n        return this._name;\n    }\n\n    public get cascade(): boolean {\n        return this._cascade;\n    }\n\n    public dataProvider(): IFullBackboneCollectionLike {\n        return this._dataProvider;\n    }\n\n    // TODO: Figure out ...\n    public onDeleted() {\n    }\n\n    /**\n     * Check if the given items are still in use.\n     */\n    private hasAnyReference(item: IModelLike): boolean {\n        // Check if this item is in this table or not\n        const itemInTable = this._dataProvider.get(item.id);\n        if (!itemInTable) {\n            return false;\n        }\n\n        const revRelations = this._reverseForeignRelation;\n        let hasFound = false;\n        for (const revK in revRelations) {\n            if (revRelations.hasOwnProperty(revK)) {\n                const revTables = revRelations[revK];\n                hasFound = _.some(revTables, (fromTable) => {\n                    const fromTableDataProvider = fromTable.dataProvider();\n                    const filter = {};\n                    filter[revK] = item.id;\n                    const anyUse = fromTableDataProvider.findWhere(filter);\n                    return !!anyUse;\n                });\n                if (hasFound) {\n                    break;\n                }\n            }\n        }\n\n        return hasFound;\n    }\n\n    /**\n     * Removing any items in other tables which depend on the deleted item.\n     */\n    private removeReverseForeign(removedItems: IModelLike[]): void {\n        const revRelation = this._reverseForeignRelation;\n        for (const revK in revRelation) {\n            if (revRelation.hasOwnProperty(revK)) {\n                const revTables = revRelation[revK];\n                revTables.forEach((reverseTable) => {\n                    const dataProvider = reverseTable.dataProvider();\n                    const toBeRemoved = [];\n                    removedItems.forEach((item) => {\n                        const filter = {};\n                        filter[revK] = item.id;\n                        const anyItems = dataProvider.where(filter);\n                        pushArray(toBeRemoved, anyItems);\n                    });\n                    toBeRemoved.forEach((item) => {\n                        item.destroyFromTable();\n                    });\n                });\n            }\n        }\n    }\n\n    /**\n     * Gets the model in the table by id.\n     */\n    get(id: any): IFullModelLike {\n        return this._dataProvider.get(id);\n    }\n\n    private destroyFromTable(thatItem: IModelLike): void {\n        const removedItem = this._dataProvider.remove(thatItem);\n        if (!removedItem) {\n            return;\n        }\n        // Notify of its collection\n        removedItem.set('invalidated', true);\n        removedItem.trigger('destroy', removedItem);\n\n        this.removeReverseForeign([removedItem]);\n    }\n\n    private getForeignModel(thatItem: IModelLike, foreignKey: string): IModelLike {\n        const value = thatItem.attributes[foreignKey];\n\n        // If we do not have this foreignKey, then return a dummy one\n        if (!value) {\n            return this.dummyRecords.getDummyRecord(foreignKey);\n        }\n\n        const table = this._foreignRelation[foreignKey];\n        return table.dataProvider().get(value);\n    }\n\n    /**\n     * Adds an item in the Table and recursively add foreign items.\n     */\n    add(model: object): IFullModelLike {\n\n        const selfContext = this;\n\n        const dataProvider = this._dataProvider;\n        const foreignRelation = this._foreignRelation;\n\n        // Check if the item to be added is already in this table.\n        const modelId = dataProvider.modelId(model);\n        let addedItem = dataProvider.get(modelId);\n\n        if (addedItem) {\n            const newAttr = _.extend({}, addedItem.attributes, model);\n            addedItem.set(newAttr);\n            return addedItem;\n        }\n\n        // Otherwise a new item\n        addedItem = dataProvider.add(model);\n\n        // Add convenient methods\n        addedItem.destroyFromTable = function() {\n            const thatItem = this;\n            selfContext.destroyFromTable(thatItem);\n        };\n\n        addedItem.getForeignModel = function(foreignKey: string): IModelLike {\n            const thatItem = this;\n            return selfContext.getForeignModel(thatItem, foreignKey);\n        };\n\n        addedItem.hasAnyReference = function(): boolean {\n            const thatItem = this;\n            return selfContext.hasAnyReference(thatItem);\n        };\n\n        return addedItem;\n    }\n\n    /**\n     * Add many items into a table.\n     */\n    addMany(models: any[]): IFullModelLike[] {\n        return models.map(model => {\n            return this.add(model);\n        });\n    }\n\n    /**\n     * Adds a foreign relation.\n     */\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void {\n        if (this._foreignRelation[foreignKey]) {\n            throw new Error('Foreign key exists: ' + foreignKey);\n        }\n        this._foreignRelation[foreignKey] = foreignTable;\n    }\n\n    /**\n     * Add a reverse foreign relation.\n     */\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void {\n        const reverseTables = this._reverseForeignRelation[reverseForeignKey];\n        if (reverseTables) {\n            const index = reverseTables.findIndex((elem) => {\n                return elem === table;\n            });\n\n            if (index !== -1) {\n                throw new Error('Reverse foreign table exists: ' + reverseForeignKey);\n            }\n\n            reverseTables.push(table);\n        } else {\n            this._reverseForeignRelation[reverseForeignKey] = [table];\n        }\n    }\n\n    /**\n     * Check if a given foreign relation is present.\n     */\n    hasForeignRelation(foreignKey: string): boolean {\n        return !!this._foreignRelation[foreignKey];\n    }\n\n    /**\n     * Checks if a given reverse foreign relation is present.\n     */\n    hasReverseForeignRelation(reverseForeignKey: string): boolean {\n        return !!this._reverseForeignRelation[reverseForeignKey];\n    }\n\n    /**\n     * Destroys table\n     */\n    destroy(): void {\n        // Remove constraint\n        this._deleteConstraint.offChange(this._onDeletedHandler);\n        this._dataProvider.reset();\n    }\n}\n\n","/**\n * @fileOverview\n * Defines a global dummy records for tables. Each table is configured with a dummy record.\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IModelLike } from '../interfaces/backbone.interface';\n\nconst backbone = dependencies.backbone;\n\nexport class DummyRecords {\n\n    private _data: { [key: string]: IModelLike };\n\n    constructor() {\n        this._data = {};\n    }\n\n    getDummyRecord(key: string) {\n        if (!this._data[key]) {\n            this._data[key] = new backbone.Model({});\n        }\n        return this._data[key];\n    }\n}\n","/**\n * @fileOverview\n * Defines a relational database which supports foreign keys and primary keys.\n * Also this database support cascading deletion and addition.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IRelationalTableOptions, IRelationalTable, RelationalTable } from './table';\nimport { DummyRecords } from './dummy-records';\n\nexport interface IRelationalDatabase {\n    getReference(): IRelationalDatabase;\n    addTable(options: IRelationalTableOptions): IRelationalTable;\n    getTable(name: string): IRelationalTable;\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void;\n    destroy(): void;\n}\n\nexport class RelationDatabase implements IRelationalDatabase {\n\n    private _tableCollection: { [key: string]: IRelationalTable };\n    private _referenceCounter: number;\n    private _dummyRecords: DummyRecords;\n\n    /**\n     * Represents a relational database.\n     */\n    constructor() {\n        this._referenceCounter = 1;\n        this._tableCollection = {};\n        this._dummyRecords = new DummyRecords();\n    }\n\n    /**\n     * Gets a reference of the file system database\n     */\n    getReference(): IRelationalDatabase {\n        this._referenceCounter++;\n        return this;\n    }\n\n    /**\n     * Defines a table in the database.\n     * @function addTable\n     * @param {Object} settings\n     */\n    addTable(options: IRelationalTableOptions): IRelationalTable {\n        return this._tableCollection[options.name] = new RelationalTable(options, this._dummyRecords);\n    }\n\n    /**\n     * Retrieves a table by name.\n     */\n    getTable(name: string): IRelationalTable {\n        return this._tableCollection[name];\n    }\n\n    /**\n     * Defines a foreign relation between two tables.\n     */\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void {\n        // Constraints\n        const table = this._tableCollection[name];\n        if (!table) {\n            throw new Error('Undefined table: ' + name);\n        }\n\n        const foreignTable = this._tableCollection[foreignName];\n        if (!foreignTable) {\n            throw new Error('Undefined foreign table: ' + foreignName);\n        }\n\n        table.addForeignRelation(foreignKey, foreignTable);\n        foreignTable.addReverseForeignRelation(foreignKey, table);\n    }\n\n    /**\n     * Destroys database\n     */\n    destroy(): void {\n        this._referenceCounter--;\n        if (this._referenceCounter === 0) {\n            for (const k in this._tableCollection) {\n                if (this._tableCollection.hasOwnProperty(k)) {\n                    const table = this._tableCollection[k];\n                    table.destroy();\n                }\n            }\n            this._tableCollection = {};\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a class for performing XHR in an exception way and in a promise way\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst XHR = dependencies.XHR;\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nconst _ = dependencies.underscore;\n\nexport interface IXHRCtorOption {\n    url: string;\n    async?: boolean;\n    type?: 'POST' | 'GET';\n    content_type: 'application/x-www-form-urlencoded' | 'application/json' | '';\n    response_type: 'json' | 'blob' | 'document' | 'text' | 'arraybuffer' | '';\n    requestheaders: any[];\n    scope?: any;\n    success_scope?: any;\n    error_scope?: any;\n    data?: any;\n}\n\nconst defaultOptions = {\n    async: true,\n    content_type: '',\n    response_type: 'json',\n    requestheaders: [],\n    success_scope: null,\n    error_scope: null,\n    scope: null\n};\n\nexport function sendPromise(options: IXHRCtorOption): PromiseLike<any> {\n    const settings = _.extend({}, defaultOptions, options);\n\n    const promise: PromiseLike<any> = new Promise((resolve, reject) => {\n        const xhrSettings = {\n            url: settings.url,\n            content_type: settings.content_type,\n            response_type: settings.response_type,\n            type: settings.type,\n            data: settings.data,\n            async: settings.async,\n            success: (output, xhr, input) => {\n                resolve({\n                    response: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            error: (output, xhr, input) => {\n                reject({\n                    error: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            success_scope: settings.success_scope,\n            error_scope: settings.error_scope,\n            scope: settings.scope,\n            requestheaders: settings.requestheaders\n        };\n        // Process sent-out data\n        if (settings.content_type === 'application/x-www-form-urlencoded') {\n            xhrSettings.data = urlEncode(xhrSettings.data);\n        } else if (settings.content_type === 'application/json') {\n            xhrSettings.data = JSON.stringify(xhrSettings.data);\n        }\n        XHR.send(xhrSettings);\n    });\n\n    return promise;\n}\n","/**\n * @fileOverview\n * Provides a bunch of utilties on network communication.\n * @name Curl.js\n * @module hypercom/util/Curl\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst tools = dependencies.Tools;\n\nconst $ = dependencies.jquery;\n\n/**\n * Load a local json file from the given url.\n * This method encapsulates the behavior of loading a local json\n * file, in order that changing its behavior in the future\n * will not impact other modules.\n * We currently leaverage the cache capability of a browser.\n * In the future, we may use memory cache.\n * Also this method returns a promise compatible project, and\n * therefore, please use \"then\" to go future.\n * @function loadJsonUriP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadJsonUriP(url) {\n    const deferred = $.ajax({\n        url: url, /* 'lang/options.json', */\n        cache: true,\n        dataType: 'json'\n    });\n    return deferred;\n}\n\n/**\n * Tests if a url is reachable.\n * @function pingP\n * @param {String} url The url to be tested.\n * @param {Object} [options]  A set of ajax parameters.\n * @returns {Promise}\n */\nexport function pingP(url, options) {\n    options = options || {};\n    const ajaxParams = tools.extend({ url: url }, options);\n    return $.ajax(ajaxParams);\n}\n\n/**\n * Reads a the response from a given url and\n * parses it into a jquery object.\n * @function loadHtmlP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadHtmlP(url) {\n    return $.ajax({\n        url: url,\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        const doc = new DOMParser().parseFromString(data, 'text/html');\n        return $(doc);\n    });\n}\n","import { ICacheBackend } from './cache-backend.interface';\r\n\r\n\r\nexport class MemoryBackend<T> implements ICacheBackend<T> {\r\n\r\n    private _store: { [key: string]: T | number };\r\n\r\n    constructor() {\r\n        this._store = {};\r\n    }\r\n\r\n    /**\r\n     * Sets a key-value pair\r\n     */\r\n    set(key: string, value: T | number): T | number {\r\n        this._store[key] = value;\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * Gets the value for a given key.\r\n     */\r\n    get(key: string): T | number | null {\r\n        return this._store[key] || null;\r\n    }\r\n\r\n    /**\r\n     * Removes the given key and its corresponding value.\r\n     */\r\n    remove(key: string): void {\r\n        delete this._store[key];\r\n    }\r\n\r\n    /**\r\n     * Returns the number of stored items.\r\n     */\r\n    length(key: string): number {\r\n        return Object.keys(this._store).length;\r\n    }\r\n\r\n    /**\r\n     * Retuns the ith key in the store table.\r\n     */\r\n    key(index: number): string {\r\n        const keys = Object.keys(this._store);\r\n\r\n        if (index >= 0 && index < keys.length) {\r\n            return keys[index];\r\n        }\r\n\r\n        return '';\r\n    }\r\n\r\n    /**\r\n     * Returns if this storage is enabled.\r\n     * This method is required by locachejs.\r\n     */\r\n    enabled(): boolean {\r\n        return true;\r\n    }\r\n}\r\n\r\n","//\r\n// Author:: Tom Tang <principleware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nconst EventDispatcher = dependencies.EventDispatcher;\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\n\r\nconst getEventDispatcher = function(obj) {\r\n    if (!obj._eventDispatcher) {\r\n        obj._eventDispatcher = new EventDispatcher({\r\n            scope: obj,\r\n            toggleEvent: function(name, state) {\r\n                if (EventDispatcher.isNative(name) && obj.toggleNativeEvent) {\r\n                    obj.toggleNativeEvent(name, state);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    return obj._eventDispatcher;\r\n};\r\n\r\nexport function observableDecorator<T extends { new(...args: any[]) }>(constructor: T) {\r\n    return class extends constructor {\r\n\r\n        public fire<U>(name: string, evt: IEventArgs<U>, bubble?: boolean): IEventArgs<U> {\r\n            const self = this;\r\n\r\n            // Prevent all events except the remove event after the instance has been removed\r\n            if (self.removed && name !== 'remove') {\r\n                return null;\r\n            }\r\n\r\n            const newEvt = getEventDispatcher(self).fire(name, evt, bubble);\r\n\r\n            // Bubble event up to parents\r\n            if (bubble !== false && self.parent) {\r\n                let parent = self.parent();\r\n                while (parent && !newEvt.isPropagationStopped()) {\r\n                    parent.fire(name, newEvt, false);\r\n                    parent = parent.parent();\r\n                }\r\n            }\r\n\r\n            return newEvt;\r\n        }\r\n\r\n\r\n        public on(name: string, callback: (...args: any[]) => any, prepend?: boolean): any {\r\n            return getEventDispatcher(this).on(name, callback, prepend);\r\n        }\r\n\r\n        public off(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).off(name, callback);\r\n        }\r\n\r\n        public once(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).once(name, callback);\r\n        }\r\n\r\n        public hasEventListeners(name: string): boolean {\r\n            return getEventDispatcher(this).has(name);\r\n        }\r\n    };\r\n}\r\n","//\r\n// Author:: Tom Tang <polpware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nimport { MemoryBackend } from './memory-backend';\r\nimport { observableDecorator } from '../decorators/observable.decorator';\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\nimport { IObservable } from '../interfaces/observable.interface';\r\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\r\nimport { INgZoneLike } from '../interfaces/ng-zone-like.interface';\r\n\r\nimport { ISlidingExpireCache } from './sliding-expire-cache.interface';\r\n\r\nconst locache = dependencies.locache;\r\nconst meld = dependencies.meld;\r\n\r\nconst originalRemove = Object.getPrototypeOf(locache.locache).remove;\r\n\r\nconst currentTime = function() {\r\n    return new Date().getTime();\r\n};\r\n\r\n@observableDecorator\r\nexport class SlidingExpirationCache<T> implements ISlidingExpireCache<T> {\r\n\r\n    private _cache: any;\r\n    private _timeInterval: any;\r\n\r\n    constructor(private _defaultSeconds: number,\r\n        scheduleInterval?: number, ngZone?: INgZoneLike) {\r\n\r\n        const backend = new MemoryBackend<T>();\r\n        this._cache = locache.locache.createCache({ storage: backend });\r\n\r\n        this._cache.remove = meld.around(originalRemove, (input: IJoinpoint) => {\r\n\r\n            const key = input.args[0];\r\n            const onExpireEvtName = this.onExpireEventName(key);\r\n            const event = this.asObservable.fire(onExpireEvtName, {});\r\n\r\n            // if the event is stopped, then stop doing it\r\n            // more time is required ...\r\n            if (event.isDefaultPrevented()) {\r\n                this.resetExpireKey(key, this._defaultSeconds);\r\n                return false;\r\n            }\r\n\r\n            // Otherwise, continue the original logic\r\n            // Remove all listener\r\n            this.asObservable.off(onExpireEvtName, null);\r\n            input.proceed();\r\n\r\n            // fire event\r\n            const afterRemoveEvtName = this.afterRemoveEventName(key);\r\n            this.asObservable.fire(afterRemoveEvtName, {});\r\n\r\n            return true;\r\n        });\r\n\r\n        // interval\r\n        if (scheduleInterval) {\r\n            if (ngZone) {\r\n                ngZone.runOutsideAngular(() => {\r\n                    this._timeInterval = setInterval(() => {\r\n                        this._cache.cleanup();\r\n                    }, scheduleInterval * 1000);\r\n                });\r\n            }\r\n            else {\r\n                this._timeInterval = setInterval(() => {\r\n                    this._cache.cleanup();\r\n                }, scheduleInterval * 1000);\r\n            }\r\n        } else {\r\n            this._timeInterval = null;\r\n        }\r\n    }\r\n\r\n    private onExpireEventName(key: string): string {\r\n        return 'onExpire:' + key;\r\n    }\r\n\r\n    private afterRemoveEventName(key: string): string {\r\n        return 'afterRemove:' + key;\r\n    }\r\n\r\n    private resetExpireKey(key: string, seconds: number) {\r\n        const expirekey = this._cache.expirekey(key);\r\n        const ms = seconds * 1000;\r\n        this._cache.storage.set(expirekey, currentTime() + ms);\r\n    }\r\n\r\n    get asObservable(): IObservable {\r\n        const self: any = this;\r\n        const observable: IObservable = self;\r\n        return observable;\r\n    }\r\n\r\n    // Given a key, a value and an optional number of seconds store the value\r\n    // in the storage backend.\r\n    set(key: string, value: T, seconds: number, afterRemoveCallback?: (evt: IEventArgs<{}>) => IEventArgs<{}>) {\r\n\r\n        const expirekey = this._cache.expirekey(key);\r\n        const valueKey = this._cache.key(key);\r\n\r\n        if (seconds) {\r\n            // The time stored is in milliseconds, but this function expects\r\n            // seconds, so multiply by 1000.\r\n            const ms = seconds * 1000;\r\n            this._cache.storage.set(expirekey, currentTime() + ms);\r\n        } else {\r\n            // Remove the expire key, if no timeout is set\r\n            this._cache.storage.remove(expirekey);\r\n        }\r\n\r\n        if (afterRemoveCallback) {\r\n            this.asObservable.once(this.afterRemoveEventName(key), afterRemoveCallback);\r\n        }\r\n\r\n        return this._cache.storage.set(valueKey, value);\r\n    }\r\n\r\n    // Fetch a value from the cache. Either returns the value, or if it\r\n    // doesn't exist (or has expired) return null.\r\n    get(key: string, seconds?: number): T | null {\r\n        // If the value has expired, before returning null remove the key\r\n        // from the storage backend to free up the space.\r\n        if (this._cache.hasExpired(key)) {\r\n            if (this._cache.remove(key)) {\r\n                return null;\r\n            }\r\n        }\r\n\r\n        const valueKey = this._cache.key(key);\r\n        const value = this._cache.storage.get(valueKey);\r\n\r\n        // Slide the expire ke\r\n        if (value) {\r\n            this.resetExpireKey(key, seconds || this._defaultSeconds);\r\n        }\r\n\r\n        // If value isn't truthy, it must be an empty string or similar, so\r\n        // just return that.\r\n        return value;\r\n    }\r\n\r\n    rmOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.off(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    addOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.on(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    public get count(): number {\r\n        return this._cache.length();\r\n    }\r\n\r\n    reset() {\r\n        const keys = this._cache.keys();\r\n        keys.forEach((k) => {\r\n            this.asObservable.off(this.onExpireEventName(k), null);\r\n            originalRemove.call(this._cache, k);\r\n            this.asObservable.fire(this.afterRemoveEventName(k), {});\r\n        });\r\n    }\r\n\r\n    // must destory, or leaking ...\r\n    destroy() {\r\n        this.reset();\r\n\r\n        if (this._timeInterval) {\r\n            clearInterval(this._timeInterval);\r\n        }\r\n    }\r\n}\r\n","export interface IPolicyCtorOptions {\r\n    url: string;\r\n}\r\n\r\nexport interface IOAuthTokenPolicyCtorOptions extends IPolicyCtorOptions {\r\n    clientId: string;\r\n    clientSecret: string;\r\n    scope: string;\r\n}\r\n\r\nexport interface IAntiForgeryKeyCtorOptions extends IPolicyCtorOptions {\r\n    antiForgeryKey: string;\r\n    elementTag: string;\r\n}\r\n\r\nexport interface IOAuthParams {\r\n    client_id: string;\r\n    client_secret: string;\r\n    scope: string;\r\n    grant_type: any;\r\n}\r\n\r\nexport interface IOAuthToken {\r\n    expiresIn: number;\r\n    createdOn: number;\r\n    token: string;\r\n    refreshToken: string;\r\n}\r\n\r\nexport interface IOpenIDToken extends IOAuthToken {\r\n    openId: string;\r\n}\r\n\r\nexport interface IPolicy {\r\n    getTokenInternal(): PromiseLike<string>;\r\n\r\n    applyTo(options: any): void;\r\n\r\n    isExpired(): boolean;\r\n\r\n    readFrom(settings: {});\r\n\r\n    persistent(): any;\r\n\r\n    applyToV2(options: any): void;\r\n\r\n    applyToV3(options: any): void;\r\n\r\n    /**\r\n     * The interface for retrieving the token from a remote server.\r\n     * This method internally dispatches the call to another method\r\n     * and cache the token.\r\n     */\r\n    getTokenP(): PromiseLike<string>;\r\n\r\n    reset();\r\n}\r\n\r\nexport const DummyOAuthTokenCtorParams: IOAuthTokenPolicyCtorOptions = {\r\n    url: 'dummy',\r\n    clientId: 'dummy',\r\n    clientSecret: 'dummy',\r\n    scope: 'all'\r\n};\r\n","/**\n * @fileOverview\n * A base class for defining security plicies.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { lift } from '@polpware/fe-utilities';\n\nimport { IPolicyCtorOptions, IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nexport abstract class PolicyBase implements IPolicy {\n\n    protected url: string;\n    protected token: string;\n\n    constructor(settings: IPolicyCtorOptions) {\n        this.url = settings.url;\n        this.token = '';\n    }\n\n    abstract getTokenInternal(): PromiseLike<string>;\n\n    abstract applyTo(options: any): void;\n\n    abstract isExpired(): boolean;\n\n    abstract readFrom(settings: {});\n\n    abstract persistent(): any;\n\n    abstract applyToV2(options: any): void;\n\n    abstract applyToV3(options: any): void;\n\n\n    /**\n     * The interface for retrieving the token from a remote server.\n     * This method internally dispatches the call to another method\n     * and cache the token.\n     */\n    getTokenP(): PromiseLike<string> {\n        if (!_.isEmpty(this.token) && !this.isExpired()) {\n            return lift(this.token, null);\n        }\n\n        return this.getTokenInternal()\n            .then((token) => {\n                return this.token = token;\n            });\n    }\n\n    /**\n     * Reset the security policy, e.g.,\n     * removing established token.\n     */\n    reset() {\n        this.token = '';\n    }\n}\n","/**\n * @fileOverview\n * Defines a base class for retrieving OAuth2 tokens.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { safeParseInt } from '@polpware/fe-utilities';\nimport {\n    IOAuthTokenPolicyCtorOptions,\n    IOAuthToken,\n    IOAuthParams\n} from './interfaces';\nimport { PolicyBase } from './policy-base';\n\nconst _ = dependencies.underscore;\nconst $ = dependencies.jquery;\n\nexport function adaptToOAuthToken(data): IOAuthToken {\n    data = data || {};\n    data.expiresIn = data.expiresIn || 0;\n    data.createdOn = data.createdOn || 0;\n    data.token = data.token || '';\n    data.refreshToken = data.refreshToken || '';\n\n    return data;\n}\n\nexport class OAuthTokenPolicy extends PolicyBase {\n\n    protected clientId: string;\n    protected clientSecret: string;\n    protected scope: string;\n    protected expiresIn: number;\n    protected createdOn: number;\n    protected refreshToken: string;\n    public grantType: 'authorization_code' | 'refresh_token' | 'password' | 'client_credentials';\n\n    public response: any;\n\n    constructor(settings: IOAuthTokenPolicyCtorOptions) {\n        super(settings);\n\n        this.clientId = settings.clientId;\n        this.clientSecret = settings.clientSecret;\n        this.scope = settings.scope;\n        this.expiresIn = null;\n        this.createdOn = null;\n        this.refreshToken = '';\n\n        this.response = null;\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     */\n    readFrom(settings: IOAuthToken) {\n        this.expiresIn = settings.expiresIn;\n        this.createdOn = settings.createdOn;\n        this.token = settings.token;\n        this.refreshToken = settings.refreshToken;\n    }\n\n    /**\n     * Returns the data that are persistentable.\n     */\n    persistent(): IOAuthToken {\n        return {\n            expiresIn: this.expiresIn,\n            createdOn: this.createdOn,\n            token: this.token,\n            refreshToken: this.refreshToken\n        };\n    }\n\n    getParams(): any {\n        return {\n            client_id: this.clientId,\n            client_secret: this.clientSecret,\n            scope: this.scope,\n            grant_type: this.grantType\n        };\n    }\n\n    // TODO: Support progress loading\n    getTokenInternal(): PromiseLike<string> {\n        const params = this.getParams();\n        return $.ajax({\n            url: this.url,\n            data: params,\n            method: 'POST'\n        }).then((resp) => {\n\n            // Put down the response\n            this.response = resp;\n\n            this.createdOn = new Date().getTime();\n            this.expiresIn = resp.expires_in;\n            this.refreshToken = resp.refreshToken || '';\n            resp.scope && (this.scope = resp.scope);\n            return (resp.access_token);\n        });\n    }\n\n    /**\n     * Returns if the token is expired or not.\n     */\n    isExpired(): boolean {\n        if (!this.token || this.token.length < 1) {\n            return true;\n        }\n        if (!this.createdOn) {\n            return true;\n        }\n        const expiresIn = safeParseInt(this.expiresIn);\n        if (expiresIn <= 0) {\n            return true;\n        }\n        const now = new Date();\n        const diff = now.getTime() - this.createdOn;\n        if (diff < expiresIn * 1000) {\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * Applys the token to the given options.\n     */\n    applyTo(options: any): void {\n        options.beforeSend = (xhr) => {\n            xhr.setRequestHeader('Authorization', ('Bearer '.concat(this.token)));\n        };\n    }\n\n    /**\n     * Apply security policy to the given options.\n     */\n    applyToV2(options: any): void {\n        options.headers = options.headers || {};\n        options.headers = {\n            Authorization: 'Bearer '.concat(this.token)\n        };\n    }\n\n    /**\n     * App security policy the given options, used for our customized XHR.\n     */\n    applyToV3(options: any): void {\n        options.requestheaders = options.requestheaders || [];\n        options.requestheaders.push({\n            key: 'Authorization',\n            value: 'Bearer '.concat(this.token)\n        });\n    }\n\n    /**\n     * Resets the token and its assoicated information.\n     */\n    reset() {\n        super.reset();\n        this.refreshToken = '';\n        this.expiresIn = null;\n        this.createdOn = null;\n    }\n}\n","/**\r\n * @fileOverview\r\n * OpenID token policy, built upon OAuth2 token policy\r\n */\r\n\r\nimport {\r\n    IOpenIDToken,\r\n    DummyOAuthTokenCtorParams\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy, adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport function adaptToOpenIDToken(data): IOpenIDToken {\r\n    data = data || {};\r\n\r\n    const r = adaptToOAuthToken(data);\r\n    return { ...r, openId: data.openId || '' };\r\n}\r\n\r\nexport class OpenIDPolicy extends OAuthTokenPolicy {\r\n\r\n    private _openId: string;\r\n\r\n    constructor() {\r\n        super(DummyOAuthTokenCtorParams);\r\n        this._openId = '';\r\n    }\r\n\r\n    /**\r\n     * Returns the necessary information for peristence.\r\n     */\r\n    persistent(): IOpenIDToken {\r\n        const r = super.persistent();\r\n        return { ...r, openId: this._openId };\r\n    }\r\n\r\n    /**\r\n     * Reads credential from the given settings.\r\n     */\r\n    readFrom(settings: IOpenIDToken) {\r\n        super.readFrom(settings);\r\n        this._openId = settings.openId;\r\n        return this;\r\n    }\r\n}\r\n","import { lift } from '@polpware/fe-utilities';\r\n\r\nimport { IPolicy } from './interfaces';\r\n\r\nexport class NullPolicy implements IPolicy {\r\n\r\n    getTokenInternal(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    applyTo(options: any): void { }\r\n\r\n    isExpired(): boolean {\r\n        return false;\r\n    }\r\n\r\n    readFrom(settings: {}) { }\r\n\r\n\r\n    persistent(): any { }\r\n\r\n    applyToV2(options: any): void { }\r\n\r\n    applyToV3(options: any): void { }\r\n\r\n    getTokenP(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    reset() { }\r\n}\r\n","/**\n * @fileOverview\n * Defines the user credential. This user credential supports event\n * listening. Note that the credential is assumed to be Uppercase:\n * Username and Password\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport {\n    isArray\n} from '@polpware/fe-utilities';\n\nimport { observableDecorator } from '../decorators/observable.decorator';\nimport { IObservable } from '../interfaces/observable.interface';\nimport { IEventArgs } from '../interfaces/event-args.interface';\n\nimport { IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nfunction isEquiva(a: any, b: any): boolean {\n\n    // Strict equals\n    if (a === b) {\n        return true;\n    }\n\n    // Compare null\n    if (a === null || b === null) {\n        return a === b;\n    }\n\n    // Compare number, boolean, string, undefined\n    if (typeof a !== 'object' || typeof b !== 'object') {\n        return a === b;\n    }\n\n    // Compare arrays\n    if (isArray(b) && isArray(a)) {\n        if (a.length !== b.length) {\n            return false;\n        }\n\n        let k = a.length;\n        while (k--) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    const checked = {};\n    const objectB = b as Object;\n    for (const k in objectB) {\n        if (objectB.hasOwnProperty(k)) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n\n            checked[k] = true;\n        }\n    }\n\n    const objectA = a as Object;\n    for (const k in objectA) {\n        if (objectA.hasOwnProperty(k)) {\n            if (!checked[k] && !isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    return true;\n}\n\nexport interface IUserProfile {\n    username?: string;\n    email?: string;\n    role?: string;\n    displayName?: string;\n}\n\n// immutable\n\n@observableDecorator\nexport class UserCredential<T extends IPolicy> {\n\n    private _security: T;\n    private _user: IUserProfile;\n    /**\n     * @constructor Credential\n     */\n    constructor(public authPolicy: T) {\n        this._user = {};\n        this._security = authPolicy;\n    }\n\n    public get asObservable(): IObservable {\n        const self: any = this;\n        return self as IObservable;\n    }\n\n    public security(value?: T): T {\n        if (value) {\n            this._security = value;\n        }\n        return this._security;\n    }\n\n    // Does not trigger any event\n    readFrom<U extends IUserProfile>(data: U): void {\n        this._user = _.extend(this._user, data);\n    }\n\n    setUser<U extends IUserProfile>(data: U): void {\n        if (isEquiva(this._user, data)) {\n            return;\n        }\n\n        this._user = data;\n        this.asObservable.fire('change:user', {\n            data: this._user\n        });\n    }\n\n    extendUser<U extends IUserProfile>(data: U): void {\n        const newData = _.extend({}, this._user, data);\n        this.setUser(newData);\n    }\n\n    getUser<U extends IUserProfile>(): U {\n        return _.extend({}, this._user);\n    }\n\n    subscribe<U extends IUserProfile>(handler: (evt: IEventArgs<U>) => IEventArgs<U>, likeBehaviorSubject: boolean = false) {\n        this.asObservable.on('change:user', handler);\n\n        if (likeBehaviorSubject) {\n            const newEvt: any = { data: this._user };\n            handler(newEvt as IEventArgs<U>);\n        }\n    }\n\n    unSubscribe(handler: (evt: any) => any) {\n        this.asObservable.off('change:user', handler);\n    }\n\n    isUserKnown(): boolean {\n        return !!(this._user && this._user.username);\n    }\n\n    isAuthenticated(): boolean {\n        return this.authPolicy && !this.authPolicy.isExpired();\n    }\n}\n\n","/**\n * @fileOverview\n * Provides the anti-forgery security policy.\n * @name AntiForgeryKeyPolicy.js\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { liftWithGuard } from '@polpware/fe-utilities';\n\nimport { IAntiForgeryKeyCtorOptions } from './interfaces';\n\nimport { PolicyBase } from './policy-base';\n\nconst $ = dependencies.jquery;\nconst defaultAntiForgeryKey = '__RequestVerificationToken';\nconst defaultElementTag = '';\n\n/*\n <input name=\"__RequestVerificationToken\" type=\"hidden\"\n value=\"J8kl6w7KaBAteKOPeHW1IlG9RS7abCkbvQf2GwBlMVZZOX9FF-Bhc5mYmqXw4qe0MLraucQtKC-TAVh1rJEZ0SDfeLfqp-L5JrthIM9V0gp76-jnVz9J-rdYFhVeTT4Y0\">\n */\nfunction getTokenInternal(url: string, elementTag: string, inputField: string): PromiseLike<string> {\n    return $.ajax({\n        url: url, // A page containing required tokens\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        let doc, token, elm;\n        token = '';\n        doc = new DOMParser().parseFromString(data, 'text/html');\n        if (elementTag) {\n            elm = $(doc).find(elementTag);\n            if (elm.length > 0) {\n                elm = $(doc).find(inputField);\n                if (elm.length > 0) {\n                    elm = elm.eq(0);\n                    token = elm.attr('value');\n                }\n            }\n        } else {\n            elm = $(doc).find(inputField);\n            if (elm.length > 0) {\n                elm = elm.eq(0);\n                token = elm.attr('value');\n            }\n        }\n        return token;\n    });\n}\n\nexport class AntiForgeryKeyPolicy extends PolicyBase {\n\n    private _antiForgeryKey: string;\n    private _elementTag: string;\n    private _expired: boolean;\n\n    /**\n     * @constructor AntiForgeryKeyPolicy\n     * @param {Object} [settings] A set of settings.\n     */\n    constructor(settings: IAntiForgeryKeyCtorOptions) {\n        super(settings);\n        this._antiForgeryKey =\n            settings.antiForgeryKey || defaultAntiForgeryKey;\n        this._elementTag = settings.elementTag || defaultElementTag;\n        this._expired = true;\n    }\n\n    isExpired(): boolean {\n        return this._expired;\n    }\n\n    inputField(): string {\n        return 'input[name=\"' + this._antiForgeryKey + '\"]';\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     * @function readFrom\n     * @param {Object} settings\n     * @returns {Object}\n     */\n    readFrom(settings) {\n        this.token = settings.token;\n    }\n\n    /**\n     * Returns the object that are persistentable.\n     * @function persistent\n     * @returns {Object}\n     */\n    persistent() {\n        return {\n            token: this.token\n        };\n    }\n\n    /**\n     * Gets the anti-forgery token from the given url\n     * or the instance url.\n     * @function getTokenP\n     * @param {String}[url] The URL where the response from it may contain\n     * the anti-forgery token; it is optional and used when you want to\n     * overwrite the instance url.\n     * @returns {Promise}\n     * @throws {}\n     */\n    getTokenInternal(): PromiseLike<string> {\n        const ret = getTokenInternal(this.url, this._elementTag, this.inputField());\n        const p = liftWithGuard(ret, function(token) {\n            const isGoodToken = token && token.length > 0;\n            this._expired = !isGoodToken;\n            return isGoodToken;\n        });\n        return ret;\n    }\n\n    /**\n     * Applys the anti-forgery key and its value to the given options.\n     * @function apply\n     * @param {Object} options The options to be used for making a request.\n     */\n    applyTo(options) {\n        const data = options.data;\n        data[this._antiForgeryKey] = this.token;\n    }\n\n    /**\n     * Apply security policy to the given options.\n     * @function applyToV2\n     * @param {Object} options A params field is expected.\n     */\n    applyToV2(options) {\n        options.params = options.params || {};\n        options.params[this._antiForgeryKey] = this.token;\n    }\n\n    // TODO:\n    applyToV3(options) {\n    }\n\n    /**\n     * Resets the token and expired flag\n     * @function reset\n     */\n    reset() {\n        super.reset();\n        this._expired = true;\n    }\n}\n","import {\r\n    IOAuthTokenPolicyCtorOptions\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy } from './oauth-token-policy';\r\nexport { adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport class OAuthTokenExtPolicy extends OAuthTokenPolicy {\r\n\r\n    private _payload: object;\r\n\r\n    constructor(settings: IOAuthTokenPolicyCtorOptions, payload: object) {\r\n        super(settings);\r\n\r\n        this._payload = { ...payload };\r\n    }\r\n\r\n    public get payload(): object {\r\n        return this._payload;\r\n    }\r\n\r\n    // override\r\n    getParams(): any {\r\n        const p = super.getParams();\r\n        return { ...p, ... this._payload };\r\n    }\r\n}\r\n","import {\r\n    CollectionActionWithPayload,\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from '../collection-action-def';\r\n\r\nexport function reducer<T extends ICollectionItem>(\r\n    state: ICollectionState<T>,\r\n    action: CollectionActionWithPayload<T>\r\n): ICollectionState<T> {\r\n    switch (action.type) {\r\n\r\n        case 'ADD': {\r\n\r\n            const payload = action.payload.filter(x => {\r\n                // Look for it in the current list\r\n                const index = state.items.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: [\r\n                    ...state.items,\r\n                    ...payload\r\n                ]\r\n            };\r\n        }\r\n\r\n        case 'REMOVE': {\r\n\r\n            const newItems = state.items.filter(x => {\r\n                const index = action.payload.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: newItems\r\n            };\r\n        }\r\n\r\n        case 'MODIFY': {\r\n\r\n            // Nothing to do\r\n            return state;\r\n        }\r\n\r\n        default:\r\n            return state;\r\n\r\n    }\r\n}\r\n","import { ActionReducerMap } from '@ngrx/store';\r\nimport { combineReducers } from '@ngrx/store';\r\n\r\nimport { ICollectionState, ICollectionItem } from '../collection-action-def';\r\nimport * as fromCollection from './collection.reducer';\r\n\r\n\r\nexport interface GenericState<T extends ICollectionItem> {\r\n    collection: ICollectionState<T>;\r\n}\r\n\r\nexport function buildInitialState<T extends ICollectionItem>(): GenericState<T> {\r\n    return {\r\n        collection: {\r\n            items: []\r\n        }\r\n    };\r\n}\r\n\r\nexport function buildReducerMap<T extends ICollectionItem>(): ActionReducerMap<GenericState<T>> {\r\n    return {\r\n        collection: fromCollection.reducer\r\n    };\r\n}\r\n\r\n\r\n","import * as ngrxStore from '@ngrx/store';\r\n\r\nimport { ICollectionItem } from './collection-action-def';\r\n\r\nimport * as reducerIndex from './reducers/index';\r\n\r\n// Store\r\n/*\r\n    ReducerManager,\r\n    StateObservable,\r\n    ActionsSubject\r\n*/\r\n\r\n// StateObservable\r\n/*\r\n   ActionsSubject\r\n   ReducerManager\r\n   ScannnedActionsSubject => leaf\r\n   InitialState\r\n*/\r\n\r\n// ActionsSubject (leaf)\r\n\r\n// ReducerManager\r\n/*\r\n   ReducerManagerDispatcher\r\n   INITIAL_STATE  => pass in parameters\r\n   INITIAL_REDUCERS => ActionReducerMap (pass in parameters)\r\n   REDUCER_FACTORY => combineReducers\r\n   ActionReducerFactory<any, any>\r\n*/\r\n\r\n// ReducerManagerDispatcher\r\n\r\n/*\r\n   ActionSsubject  (leaf)\r\n*/\r\n\r\n// ActionReducerFactory<any, any> (Use combinReducer function from utils)\r\n\r\n/*\r\n   ActionReducerMap\r\n   initialState\r\n\r\n   ActionReducer\r\n*/\r\n\r\n// createReducerfactory\r\n/*\r\n   ActionReducerFactory\r\n   MataReducerFactory\r\n\r\n*/\r\n\r\nexport function factory<T extends ICollectionItem>(): ngrxStore.Store<reducerIndex.GenericState<T>> {\r\n\r\n    const actionSubject = new ngrxStore.ActionsSubject();\r\n    const scannerActionSubject = new ngrxStore.ScannedActionsSubject();\r\n    const reducerManagerDispatch: ngrxStore.ReducerManagerDispatcher = actionSubject;\r\n\r\n    const actionReducerFactory: ngrxStore.ActionReducerFactory<any, any> = ngrxStore.combineReducers;\r\n\r\n    const reducerManager = new ngrxStore.ReducerManager(actionSubject,\r\n        reducerIndex.buildInitialState<T>(),\r\n        reducerIndex.buildReducerMap<T>(),\r\n        actionReducerFactory);\r\n\r\n    const stateObservable = new ngrxStore.State(actionSubject,\r\n        reducerManager,\r\n        scannerActionSubject,\r\n        reducerIndex.buildInitialState<T>());\r\n\r\n    const store = new ngrxStore.Store<reducerIndex.GenericState<T>>(stateObservable, actionSubject, reducerManager);\r\n    return store;\r\n}\r\n","import { Store } from '@ngrx/store';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ICollectionState, ICollectionItem } from './collection-action-def';\r\n\r\nimport { ICollectionStore } from './collection-store.interface';\r\nimport { GenericState } from './reducers';\r\n\r\nexport abstract class CollectionAbstractStore<T extends ICollectionItem> implements ICollectionStore<T> {\r\n\r\n    public abstract getState(): Observable<ICollectionState<T>>;\r\n    public abstract getStore(): Store<GenericState<T>>;\r\n\r\n    public add(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'ADD',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public remove(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'REMOVE',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public modify(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'MODIFY',\r\n            payload: payload\r\n        });\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Store, } from '@ngrx/store';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { factory } from './factory';\r\n\r\nimport { GenericState } from './reducers/index';\r\nimport {\r\n    CollectionAbstractStore\r\n} from './collection-abstract.store';\r\n\r\nimport {\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from './collection-action-def';\r\n\r\n\r\n@Injectable()\r\nexport class CollectionStore<T extends ICollectionItem>\r\n    extends CollectionAbstractStore<T> {\r\n\r\n    private _store: Store<GenericState<T>>;\r\n\r\n    constructor() {\r\n        super();\r\n        this._store = factory<T>();\r\n    }\r\n\r\n    public getStore(): Store<GenericState<T>> {\r\n        return this._store;\r\n    }\r\n\r\n    public getState(): Observable<ICollectionState<T>> {\r\n        return this._store.select('collection');\r\n    }\r\n}\r\n","/**\n * @fileOverview\n * An endpoint which aggregates a few other endpoints, to form a new endpoint.\n * Note that the caller is responsible for resetting underlying data providers\n * and even caching them.\n * Moreover, this class does not assume any knowledge about providerGenerator.\n * providerGenerator may generate the same thing again as again.\n * Also note that it is the provider generator's responsibilty for\n * preversing the state of each data provider.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IBackboneCollectionLike } from '../interfaces/backbone.interface';\n\nconst when = dependencies.when;\nconst _ = dependencies.underscore;\n\nfunction hasNextPage(collection: IBackboneCollectionLike): boolean {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return true;\n    }\n    return collection.hasNextPage();\n}\n\nfunction getNextPage(collection: IBackboneCollectionLike): PromiseLike<any> {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return collection.getFirstPage();\n    }\n    return collection.getNextPage();\n}\n\nexport interface IProviderGenerator {\n    hasMore(): boolean;\n    getNext(): PromiseLike<Array<IBackboneCollectionLike>>;\n    reset(): void;\n}\n\nexport class AggregateCollection {\n\n    private _workingProviders: Array<IBackboneCollectionLike>;\n\n    constructor(private _providerGenerator: IProviderGenerator) {\n        this._workingProviders = [];\n    }\n\n    hasNextPage(): boolean {\n        // Case 1: The first time we request, we always have something.\n        if (this._workingProviders.length === 0) {\n            return true;\n        }\n        if (this._providerGenerator.hasMore()) {\n            return true;\n        }\n        return _.some(this._workingProviders, function(elem) {\n            return elem.hasNextPage();\n        });\n    }\n\n    getFirstPage(): PromiseLike<any> {\n        // Generate providers\n        return this._providerGenerator.getNext()\n            .then((providers) => {\n                providers = _.filter(providers, function(p) {\n                    return hasNextPage(p);\n                });\n                return providers;\n            })\n            .then((providers) => {\n                this._workingProviders.length = 0;\n                const promises = _.map(providers, function(p) {\n                    return getNextPage(p)\n                        .then((resp) => {\n                            this._workingProviders.push(p);\n                            return resp;\n                        });\n                });\n                return when.settle(promises);\n            });\n    }\n\n    getNextPage(): PromiseLike<any> {\n        return this.getFirstPage();\n    }\n\n    reset(): void {\n        this._providerGenerator.reset();\n        this._workingProviders = [];\n    }\n\n    forEach(func: (elem: any) => any) {\n        this._workingProviders.forEach((p) => {\n            p.forEach(func);\n        });\n    }\n\n    get(id) {\n        // TODO:\n    }\n}\n\n","/**\n * @fileOverview\n * A decorator to Backbone. It tracks all sync events of the Backbone\n * in a nonintrusive manner.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst backbone = dependencies.backbone;\nconst meld = dependencies.meld;\n\n/**\n * The callback for the sync event.\n * @callback EventHubcallback\n * @param {Object} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} response The response assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a callback for listening to the sync events from Backbone.\n * @function mountSyncListener\n * @param {EventHubcallback} callback\n * @throws {Error}\n */\nexport function mountSyncListener(callback) {\n    // Collection\n    const remover1 = meld.before(backbone.Collection.prototype, 'trigger', callback);\n    const remover2 = meld.before(backbone.Model.prototype, 'trigger', callback);\n    return [remover1, remover2];\n}\n\n/**\n * The callback for the sync event.\n * @callback EventHubsyncSignature\n * @param {String} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a pre-sync callback.\n * @function mountSyncBeforeAdvice\n * @param {EventHubsyncSignature} callback\n */\nexport function mountSyncBeforeAdvice(callback) {\n    return meld.before(backbone, 'sync', callback);\n}\n\n/**\n * The signature for the around advice.\n * @callback EventHubaroundAdviceSignature\n * @param {String} jointpoint the jointpoint for this advice.\n */\n\n/**\n * Sets up an around advice.\n * @function mountSyncAroundAdvice\n * @param {EventHubaroundAdviceSignature} callback\n */\nexport function mountSyncAroundAdvice(callback) {\n    return meld.around(backbone, 'sync', callback);\n}\n\n\n/**\n * Sets up a pre-ajax callback.\n * @function mountAjaxBeforeAdvice\n * @param {Function} callback\n */\nexport function mountAjaxBeforeAdvice(callback) {\n    return meld.before(backbone, 'ajax', callback);\n}\n\n","/**\n * @fileOverview\n * Provides a layer of backend service abstraction.\n * Defines the backend services. This class is built onto the backbone js, but with\n * enhanced abilities of managing the dependency among all services of the backend,\n * and caching some type of objects for a period of time.\n */\n/*jslint unparam: true */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nimport { SlidingExpirationCache } from '../cache/sliding-expiration-cache';\n\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\n\nimport {\n    mountSyncBeforeAdvice,\n    mountAjaxBeforeAdvice,\n    mountSyncAroundAdvice\n} from './event-hub';\n\nimport { IBackboneOptions, IBackboneConfiguration } from './interfaces';\n\nconst DataFlow = dependencies['dataflow'];\nconst backbone = dependencies['backbone'];\nconst _ = dependencies.underscore;\n\n/**\n * The endpoint types for a backend service.\n */\nexport const endPointEnum = {\n    model: 1,\n    collection: 2,\n    pagedCollection: 3\n};\n\n/**\n * The sync types defined in the backbone js.\n */\nexport const syncMethodEnum = {\n    /**\n     * Fetch a model or a collection.\n     */\n    read: 'read',\n    /**\n     * Save a model.\n     */\n    create: 'create',\n    patch: 'patch',\n    update: 'update',\n    /**\n     * Destroy a model\n     */\n    delete: 'delete'\n};\n\nconst globalConfigurationMapping: { [key: string]: IBackboneConfiguration } = {};\nconst mountedFeatureRemovers: any[] = [];\n\n// Idempotent\n// Instance once ...\nfunction mountFeatures() {\n\n    if (mountedFeatureRemovers.length > 0) {\n        return;\n    }\n    /*jslint unparam: true */\n    /*\n      eventHub.mountSyncListener(function (method, model, response, options) {\n      // Ignore other method\n      if (method !== 'sync') {\n      return;\n      }\n      if (options.endPointKey && options.methodKey) {\n      var dataflow = self._dataflow,\n      key = options.endPointKey + ':' + options.methodKey;\n      dataflow[key] = dataflow[key] + 1;\n      }\n      }); */\n\n    let remover = mountSyncBeforeAdvice(function(method, model, options) {\n        options.methodKey = method;\n        options.endPointKey = model.endPointKey || (model.collection ? model.collection.endPointKey : null);\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (method === 'delete') {\n                if (cfgOptions.deleteUrl) {\n                    options.url = cfgOptions.deleteUrl;\n                }\n                if (cfgOptions.deleteContentType) {\n                    options.contentType = cfgOptions.deleteContentType;\n                }\n            } else if (method === 'update') {\n                if (cfgOptions.updateUrl) {\n                    options.url = cfgOptions.updateUrl;\n                }\n                if (cfgOptions.updateContentType) {\n                    options.contentType = cfgOptions.updateContentType;\n                }\n            } else if (method === 'create') {\n                if (cfgOptions.createUrl) {\n                    options.url = cfgOptions.createUrl;\n                }\n                if (cfgOptions.createContentType) {\n                    options.contentType = cfgOptions.createContentType;\n                }\n            } else if (method === 'patch') {\n                if (cfgOptions.patchUrl) {\n                    options.url = cfgOptions.patchUrl;\n                }\n                if (cfgOptions.patchContentType) {\n                    options.contentType = cfgOptions.patchContentType;\n                }\n            }\n        }\n    });\n\n    mountedFeatureRemovers.push(remover);\n    remover = mountAjaxBeforeAdvice(function(options) {\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            const policyDelegate = cfgOptions.securityDelegate;\n            const extraParams = cfgOptions.extraParams;\n            if (cfgOptions.contentType === 'application/x-www-form-urlencoded' &&\n                options.contentType === 'application/json') {\n                options.data = JSON.parse(options.data);\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                options.data = urlEncode(options.data);\n                options.contentType = cfgOptions.contentType;\n            } else {\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                if (options.contentType === 'application/x-www-form-urlencoded') {\n                    options.data = urlEncode(options.data);\n                }\n            }\n        }\n    });\n    mountedFeatureRemovers.push(remover);\n\n    remover = mountSyncAroundAdvice(function(jointpoint: IJoinpoint) {\n        const options = jointpoint.args[2];\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (cfgOptions.syncDelegate) {\n                const syncDelegate = cfgOptions.syncDelegate;\n                // Return a promise\n                return syncDelegate(options.endPointKey, options, cfg, function() {\n                    return jointpoint.proceed();\n                });\n            }\n        }\n        return jointpoint.proceed();\n    });\n    mountedFeatureRemovers.push(remover);\n}\n\nconst defaultLivePeroid = 60 * 5;\n\nexport interface IGlobalProviderCtorOptions {\n    webhost?: string;\n}\n\nexport class GlobalProvider {\n\n    private _host: string;\n    private _dataflow: any;\n    private _cache: SlidingExpirationCache<any>;\n    private _myEndPointKeys: any[];\n    private _uniqueNamePrefix: string;\n\n    constructor(ctorOptions: IGlobalProviderCtorOptions) {\n        this._cache = new SlidingExpirationCache(defaultLivePeroid);\n        this._dataflow = new DataFlow();\n        this._myEndPointKeys = [];\n        this._host = ctorOptions.webhost || '';\n        this._uniqueNamePrefix = this._host ? (this._host.replace('.', '-') + '-') : '';\n\n        // Mount features\n        mountFeatures();\n    }\n\n    public get host(): string {\n        return this._host;\n    }\n\n    public get configurationMapping(): { [key: string]: any } {\n        return globalConfigurationMapping;\n    }\n\n    /**\n     * Defines an endpoint for a kind of service.\n     */\n    addEndPoint(name: string, tag: number, options: IBackboneOptions) {\n        const cfgMapping = this.configurationMapping;\n        const dataflow = this._dataflow;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (cfgMapping[uniqueName]) {\n            throw new Error('Redefined endpoint: ' + name);\n        }\n        cfgMapping[uniqueName] = {\n            options: _.extend(options, { endPointKey: uniqueName }),\n            tag: tag\n        };\n\n        this._myEndPointKeys.push(uniqueName);\n\n        // Set up data flow nodes (it is enough to use local names)\n        if (tag === endPointEnum.model) {\n            for (const k in syncMethodEnum) {\n                // skip loop if the property is from prototype\n                if (syncMethodEnum.hasOwnProperty(k)) {\n                    const value = syncMethodEnum[k];\n                    dataflow[name + ':' + value] = 1;\n                }\n            }\n        } else {\n            dataflow[name + ':' + syncMethodEnum.read] = 1;\n        }\n    }\n\n    /**\n     * Retrieves the endpoint by the given name.\n     */\n    getEndPoint(name: string, ignoreCache?: boolean) {\n        const cache = this._cache;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (ignoreCache !== true) {\n            const cachedValue = cache.get(uniqueName);\n            if (cachedValue) {\n                return cachedValue;\n            }\n        }\n\n        const cfgMapping = this.configurationMapping;\n\n        const cfg = cfgMapping[uniqueName];\n        if (!cfg) {\n            const error = new Error('No given endpoint is defined for: ' + name);\n            throw error;\n        }\n\n        let value = null;\n        if (cfg.tag === endPointEnum.model) {\n            value = backbone.Model.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.collection) {\n            value = backbone.Collection.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.pagedCollection) {\n            value = backbone.PageableCollection.extend(cfg.options);\n        } else {\n            throw new Error('Not implemented');\n        }\n\n        if (ignoreCache !== true) {\n            cache.set(uniqueName, value, defaultLivePeroid);\n        }\n        return value;\n    }\n\n    /**\n     * Get the underlying configuration for an endpoint.\n     */\n    getConfiguration(endPointKey: string) {\n        const uniqueName = this._uniqueNamePrefix + endPointKey;\n        const cfgMapping = this.configurationMapping;\n        return cfgMapping[uniqueName];\n    }\n\n    /**\n     * Provides the callback when some operations happen.\n     */\n    addWhenCallback(name: string[], callback: any) {\n        const dataflow = this._dataflow;\n        dataflow.when(name, callback);\n    }\n\n    /**\n     * Defines the dependency.\n     */\n    addDependency(src: string, dst: string) {\n        const dataflow = this._dataflow;\n        dataflow.on(src, function() {\n            dataflow[dst] = dataflow[dst] + 1;\n        });\n    }\n\n    /**\n     * Clean up all cached data provider\n     */\n    cleanupCache() {\n        // Remove what we have in cache\n        this._cache.reset();\n    }\n\n    cleanMountedFeatures() {\n        mountedFeatureRemovers.forEach(function(remover) {\n            remover.remove();\n        });\n        mountedFeatureRemovers.length = 0;\n    }\n\n    /**\n     * Destroy the provider to release resources\n     */\n    destroy() {\n        // Delete cache\n        this._myEndPointKeys.forEach(function(k) {\n            delete globalConfigurationMapping[k];\n        });\n\n        this._myEndPointKeys.length = 0;\n\n        this._cache.destroy();\n\n        // No destroy methods for the following two instances.\n        this._cache = null;\n        this._dataflow = null;\n        this._host = null;\n        this._uniqueNamePrefix = null;\n    }\n}\n\n\n\n","/**\n * @fileOverview\n * Provides type-safety operations of manipulating LocalStorage data.\n * @name LocalStorageUtil.js\n * @module hypercom/storage/LocalStorageUtil\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as externalInterface from '@polpware/fe-dependencies';\n// as polyfill for localstorage\n// Do NOT use the LocalStorage as there is global variable which cannot be resolved\n// and which is defined only in TINYMCE.\n// import * as localStorage from 'polpware-tinymce-tailor/src/util/LocalStorage.js';\n\nconst globalLocalStorage = window.localStorage;\n\nimport {\n    defaultValue,\n    ITypeDef,\n    tyArray,\n    ok as isType\n} from '@polpware/fe-utilities';\n\nconst _ = externalInterface.underscore,\n    find = _.find,\n    findIndex = _.findIndex,\n    union = _.union;\n\nexport interface IEntity {\n    Id: any;\n}\n\n/**\n * Reads the value of an entity by its key.\n * @function getEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n * @returns {*} The entity value.\n */\n\nexport function getEntity(key: string, ty: ITypeDef): any {\n    let data = defaultValue(ty);\n    try {\n        let tmp = globalLocalStorage.getItem(key);\n        if (tmp && tmp !== 'undefined') {\n            tmp = JSON.parse(tmp);\n            if (isType(tmp, ty)) {\n                data = tmp;\n            }\n        }\n    } catch (ex) {\n        console.log(ex);\n    }\n    return data;\n}\n/**\n * Updates the value of an entity by its key.\n * @function updateEntity\n * @param {String} key The entity key.\n * @param {*} data The new value to be replaced with.\n * @param {*} ty The type of the entity value.\n */\nexport function updateEntity(key: string, data: any, ty: ITypeDef = null) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(data));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Cleans the value of an entity by its key.\n * @function cleanEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n */\nexport function cleanEntity(key: string, ty: ITypeDef) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(defaultValue(ty)));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Inserts the given data into the value of an entity of type array.\n * Note that the inserted data should be disjoint with the current data\n * stored in this entity. Otherwise, the behavior may be undefined.\n * @function insertEntities\n * @param {String} key The entity key.\n * @param {Array} data The value to be inserted.\n * @param {Number} upperBound The max number of elements allows for this entity value.\n */\nexport function insertEntities(key: string, data: Array<IEntity>, upperBound: number) {\n    let newData = [];\n    const currentData = getEntity(key, tyArray) as Array<IEntity>;\n    if (upperBound > 0 && currentData.length > upperBound) {\n        newData = data;\n    } else {\n        newData = union(currentData, data);\n    }\n    updateEntity(key, newData, tyArray);\n}\n/**\n * Finds one element of an entity of type array.\n * @function findEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value. An Id field is assumed for each element.\n * @returns {*} The value of the found element.\n */\nexport function findEntityById(key: string, id): IEntity {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    return find(data, { Id: id });\n}\n\n/**\n * Removes an element of an entity of type array.\n * @function removeEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value for the element to be removed.\n */\nexport function removeEntityById(key: string, id) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: id });\n    if (index === -1) {\n        return;\n    }\n    data.splice(index, 1);\n    updateEntity(key, data, tyArray);\n}\n/**\n * Inserts or udpates an element of an entity of type array.\n * @function insertOrUpdateEntity\n * @param {String} key The entity key.\n * @param {Array} entity The new value of the entity.\n */\nexport function insertOrUpdateEntity(key: string, entity: IEntity) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: entity.Id });\n    if (index !== -1) {\n        data[index] = entity;\n    } else {\n        data.push(entity);\n    }\n    updateEntity(key, data, tyArray);\n}\n/**\n * Removes a group of entities by a given prefix.\n * @function cleanEntityGroup\n * @param {String} prefix The prefix of the keys of the entities to be removed. We organize entities somewhat hirarchly.\n * @returns {Boolean}\n */\nexport function cleanEntityGroup(prefix: string): Array<string> {\n    const keys = [];\n    for (const p in globalLocalStorage) {\n        if (globalLocalStorage.hasOwnProperty(p) &&\n            p.indexOf(prefix) === 0) {\n            keys.push(p);\n        }\n    }\n    if (keys.length === 0) {\n        return keys;\n    }\n    keys.forEach(function(k) {\n        globalLocalStorage.removeItem(k);\n    });\n    return keys;\n}\n","/**\n * @fileOverview\n * Encapsulates the local storage service into one\n * providing prmoise-aware services.\n * @name LocalStorageTable.js\n * @module hypercom/storage/LocalStorageTable\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as polpwareUtil from '@polpware/fe-utilities';\n\nimport * as localStorageUtil from './localstorage-util';\n\n/**\n * @class LocalStorageTable\n */\nexport class LocalStorageTable {\n\n    /**\n     * Gets the value for the given key.\n     * @function getP\n     * @param {String} key The key to be searched for.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    getP(key: string): PromiseLike<object> {\n        const data = localStorageUtil.getEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(data, null);\n    }\n\n    /**\n     * Removes the key from the keychain.\n     * @function removeP\n     * @param {String} key The key to be removed.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    removeP(key: string): PromiseLike<boolean> {\n        localStorageUtil.cleanEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n    /**\n     * Updates the value for the given key.\n     * @param {String} key The key to be searched for.\n     * @param {Object} value The new value.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    updateP(key: string, value: object): PromiseLike<boolean> {\n        localStorageUtil.updateEntity(key, value, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n}\n","/**\n * @fileOverview\n * Provides i18n service. This module is designed as\n * a delegate of the tinymce I18n service.\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst _i18n = dependencies.I18n;\n\nexport class I18n {\n\n    static getDictByCode(code: string) {\n        return _i18n.data[code];\n    }\n\n    /**\n     * Add a languge dictionary and set the current\n     * code as the current language.\n     */\n    static add(code: string, items: any) {\n        _i18n.add(code, items);\n    }\n\n    /**\n     * Trnsaltes a given text. If the given text\n     * is missing in the dictionary, use the given default value.\n     * @function translate\n     * @param {String} text A text to be translated.\n     * @param {String} defaultText The default value.\n     * @returns {String} The translation for the given text.\n     */\n    static translate(text: string, defaultText: string) {\n        const value = _i18n.translate(text);\n        if (value === text && defaultText) {\n            return defaultText;\n        }\n        return value;\n    }\n\n    /**\n     * Removes unused languages to release memory.\n     * @function recycleOthers\n     * @param {String} code The language code which should not released.\n     */\n    static recycleOthers(code: string) {\n        const data = _i18n.data;\n        const recycleList = [];\n        for (const key in data) {\n            // skip loop if the property is from prototype\n            if (data.hasOwnProperty(key) && key !== code) {\n                recycleList.push(key);\n            }\n        }\n        /*jslint plusplus: true */\n        for (let i = 0; i < recycleList.length; i++) {\n            const k = recycleList[i];\n            delete data[k];\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a Resources class.\n * With this class, you may configure a bunch of resources\n * accessible from global URIs, such as URLs.\n * Once the requested resources are loaded, they may be\n * cached in the memory.\n * Note that the resources are expected to be organized in\n * a common namespace hierarchy.\n * E.g.,\n * x.y.z corresponds to a json resource like:\n *    {\n *       y: {\n *             z: 112\n *          }\n *    }\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\n\nimport * as externalInterface from '@polpware/fe-dependencies';\nimport { replace, lift, convert } from '@polpware/fe-utilities';\n\nimport { ISlidingExpireCache } from '../cache/sliding-expire-cache.interface';\n\nimport { loadJsonUriP } from '../net/curl';\n\n\nconst _ = externalInterface.underscore;\nconst isString = _.isString;\n\n\n/**\n * Retrieves a value from a variable by a given namespace nested structure.\n * @function getByNamespace\n * @param {Object} repo\n * @param {*} fullyQualifiedNamespace A string or an arry of string defining the namespace.\n * @param {Number}[] startLevel\n * @returns {*}\n */\nfunction getByNamespace<T>(repo: { [key: string]: T },\n    identifiers: Array<string>,\n    startLevel: number = 1): T {\n\n    const restIdentifiers = identifiers.slice(startLevel);\n    const restKey = restIdentifiers.join('.');\n    if (repo[restKey]) {\n        return repo[restKey];\n    }\n\n    let initRepo: any = repo;\n    for (let index = startLevel; index < identifiers.length; index++) {\n        if (!initRepo) {\n            break;\n        }\n        const key = identifiers[index];\n        initRepo = initRepo[key];\n    }\n    return initRepo;\n}\n\ninterface IConfigurationEntry {\n    uri: string;\n    liveSeconds: number;\n}\n\n/**\n * @class Resources\n */\nexport class ResourceLoader {\n\n    private _configuration: { [key: string]: IConfigurationEntry };\n\n    /**\n     * Constructor\n     * @function init\n     */\n    constructor(private _cache: ISlidingExpireCache<any> = null) {\n        this._configuration = {};\n    }\n\n    /**\n     * Configure a resource\n     * @function register\n     * @param {String} key The resource key.\n     * @param {String} uri The resource URI.\n     * @param {Number} liveSeconds The cache period.\n     * @throws {Error}\n     */\n    register(key: string, uri: string, liveSeconds: number = 60) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            throw new Error('Registering an existing resource key: ' + key);\n        }\n        configuration[key] = {\n            uri: uri,\n            liveSeconds: liveSeconds\n        };\n    }\n\n    /**\n     * Removes a registered item\n     * @function undoRegister\n     * @param {String} key The resource key to be removed.\n     */\n    undoRegister(key: string) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            delete configuration[key];\n        }\n    }\n    /**\n     * Returns a promise for the resource key.\n     * @function getPromise\n     * @param {String} fullyQualifiedNamespace The resource key.\n     * @returns {*} The resource value.\n     * @throws {Error}\n     */\n    getPromise<T>(fullyQualifiedNamespace: string,\n        convertor: (any) => any): PromiseLike<T> {\n        const identifiers = fullyQualifiedNamespace.split('.');\n        const topIdentifier = identifiers[0];\n        const cache = this._cache;\n        if (cache) {\n            // Figure out the master key\n            const repo = cache.get(topIdentifier, 60);\n            if (repo) {\n                const value = getByNamespace<T>(repo, identifiers);\n                if (value) {\n                    // Return a promise\n                    return lift(value, null);\n                }\n            }\n        }\n\n        const entry = this._configuration[topIdentifier];\n        if (!entry) {\n            throw new Error('Get unregistered resource: ' + topIdentifier);\n        }\n\n        // Otherwise, load it\n        return loadJsonUriP(entry.uri).then((content) => {\n            content = convertor(content);\n            // Cache the new value\n            if (cache) {\n                cache.set(topIdentifier, content, entry.liveSeconds);\n            }\n            return getByNamespace(content, identifiers);\n        });\n    }\n}\n"]}