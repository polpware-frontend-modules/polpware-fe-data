{"version":3,"file":"polpware-fe-data.js","sources":["ng://@polpware/fe-data/lib/relational/table.ts","ng://@polpware/fe-data/lib/relational/dummy-records.ts","ng://@polpware/fe-data/lib/relational/database.ts","ng://@polpware/fe-data/lib/net/xhr-promise.ts","ng://@polpware/fe-data/lib/net/curl.ts","ng://@polpware/fe-data/lib/cache/memory-backend.ts","ng://@polpware/fe-data/lib/decorators/observable.decorator.ts","ng://@polpware/fe-data/lib/cache/sliding-expiration-cache.ts","ng://@polpware/fe-data/lib/security/interfaces.ts","ng://@polpware/fe-data/lib/security/policy-base.ts","ng://@polpware/fe-data/lib/security/oauth-token-policy.ts","ng://@polpware/fe-data/lib/security/open-id-policy.ts","ng://@polpware/fe-data/lib/security/null-policy.ts","ng://@polpware/fe-data/lib/security/user-credential.ts","ng://@polpware/fe-data/lib/security/antiforgerykey-policy.ts","ng://@polpware/fe-data/lib/security/oauth-token-ext-policy.ts","ng://@polpware/fe-data/lib/generic-store/reducers/collection.reducer.ts","ng://@polpware/fe-data/lib/generic-store/reducers/index.ts","ng://@polpware/fe-data/lib/generic-store/factory.ts","ng://@polpware/fe-data/lib/generic-store/collection-abstract.store.ts","ng://@polpware/fe-data/lib/generic-store/collection.store.ts","ng://@polpware/fe-data/lib/backend/aggregate-collection.ts","ng://@polpware/fe-data/lib/backend/event-hub.ts","ng://@polpware/fe-data/lib/backend/provider.ts","ng://@polpware/fe-data/lib/storage/localstorage-util.ts","ng://@polpware/fe-data/lib/storage/localstorage-table.ts","ng://@polpware/fe-data/lib/i18n/dict.ts","ng://@polpware/fe-data/lib/i18n/resource-loader.ts","ng://@polpware/fe-data/polpware-fe-data.ts"],"sourcesContent":["/**\n * @fileOverview\n * Defines a table in a relational database.\n * This table is observable, i.e., any change on this table will be notified to its listeners.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\nimport { pushArray } from '@polpware/fe-utilities';\nimport {\n    IModelLike,\n    IBackboneCollectionLike,\n    IFullBackboneCollectionLike,\n    IFullModelLike\n} from '../interfaces/backbone.interface';\nimport { DummyRecords } from './dummy-records';\n\nconst backbone = dependencies.backbone;\nconst _ = dependencies.underscore;\nconst cjs = dependencies.constraintjs;\n\nexport interface IRelationalTableOptions {\n    name: string;\n    cascade?: boolean;\n    dataProviderCtor?: any;\n    dataProviderCtorOption?: any;\n}\n\nexport interface IRelationalTable {\n    name: string;\n    cascade: boolean;\n    dataProvider(): IFullBackboneCollectionLike;\n    get(id: any): IFullModelLike;\n    add(model: object): IFullModelLike;\n    addMany(models: any[]): IFullModelLike[];\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void;\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void;\n    hasForeignRelation(foreignKey: string): boolean;\n    hasReverseForeignRelation(reverseForeignKey: string): boolean;\n    destroy(): void;\n}\n\nexport class RelationalTable implements IRelationalTable {\n\n    private _name: string;\n    private _cascade: boolean;\n    private _addConstraint: any;\n    private _deleteConstraint: any;\n    private _foreignRelation: { [key: string]: IRelationalTable };\n    private _reverseForeignRelation: { [key: string]: IRelationalTable[] };\n\n    private _dataProvider: IFullBackboneCollectionLike;\n    private _onDeletedHandler: any;\n\n    constructor(options: IRelationalTableOptions,\n        public dummyRecords: DummyRecords) {\n\n        this._name = options.name;\n        this._cascade = false;\n\n        this._foreignRelation = {};\n        this._reverseForeignRelation = {};\n\n\n        if (options.dataProviderCtor) {\n            this._dataProvider = new options.dataProviderCtor();\n        } else {\n            const ctor = backbone.Collection.extend(options.dataProviderCtorOption || {});\n            this._dataProvider = new ctor();\n        }\n\n        this._addConstraint = cjs.constraint([]);\n        this._deleteConstraint = cjs.constraint([]);\n\n        // Todo: Figure out parameters\n        this._onDeletedHandler = (...args: any[]) => {\n            this.onDeleted();\n        };\n\n        // Set up constraint\n        this._deleteConstraint.onChange(this._onDeletedHandler);\n    }\n\n    public get name(): string {\n        return this._name;\n    }\n\n    public get cascade(): boolean {\n        return this._cascade;\n    }\n\n    public dataProvider(): IFullBackboneCollectionLike {\n        return this._dataProvider;\n    }\n\n    // TODO: Figure out ...\n    public onDeleted() {\n    }\n\n    /**\n     * Check if the given items are still in use.\n     */\n    private hasAnyReference(item: IModelLike): boolean {\n        // Check if this item is in this table or not\n        const itemInTable = this._dataProvider.get(item.id);\n        if (!itemInTable) {\n            return false;\n        }\n\n        const revRelations = this._reverseForeignRelation;\n        let hasFound = false;\n        for (const revK in revRelations) {\n            if (revRelations.hasOwnProperty(revK)) {\n                const revTables = revRelations[revK];\n                hasFound = _.some(revTables, (fromTable) => {\n                    const fromTableDataProvider = fromTable.dataProvider();\n                    const filter = {};\n                    filter[revK] = item.id;\n                    const anyUse = fromTableDataProvider.findWhere(filter);\n                    return !!anyUse;\n                });\n                if (hasFound) {\n                    break;\n                }\n            }\n        }\n\n        return hasFound;\n    }\n\n    /**\n     * Removing any items in other tables which depend on the deleted item.\n     */\n    private removeReverseForeign(removedItems: IModelLike[]): void {\n        const revRelation = this._reverseForeignRelation;\n        for (const revK in revRelation) {\n            if (revRelation.hasOwnProperty(revK)) {\n                const revTables = revRelation[revK];\n                revTables.forEach((reverseTable) => {\n                    const dataProvider = reverseTable.dataProvider();\n                    const toBeRemoved = [];\n                    removedItems.forEach((item) => {\n                        const filter = {};\n                        filter[revK] = item.id;\n                        const anyItems = dataProvider.where(filter);\n                        pushArray(toBeRemoved, anyItems);\n                    });\n                    toBeRemoved.forEach((item) => {\n                        item.destroyFromTable();\n                    });\n                });\n            }\n        }\n    }\n\n    /**\n     * Gets the model in the table by id.\n     */\n    get(id: any): IFullModelLike {\n        return this._dataProvider.get(id);\n    }\n\n    private destroyFromTable(thatItem: IModelLike): void {\n        const removedItem = this._dataProvider.remove(thatItem);\n        if (!removedItem) {\n            return;\n        }\n        // Notify of its collection\n        removedItem.set('invalidated', true);\n        removedItem.trigger('destroy', removedItem);\n\n        this.removeReverseForeign([removedItem]);\n    }\n\n    private getForeignModel(thatItem: IModelLike, foreignKey: string): IModelLike {\n        const value = thatItem.attributes[foreignKey];\n\n        // If we do not have this foreignKey, then return a dummy one\n        if (!value) {\n            return this.dummyRecords.getDummyRecord(foreignKey);\n        }\n\n        const table = this._foreignRelation[foreignKey];\n        return table.dataProvider().get(value);\n    }\n\n    /**\n     * Adds an item in the Table and recursively add foreign items.\n     */\n    add(model: object): IFullModelLike {\n\n        const selfContext = this;\n\n        const dataProvider = this._dataProvider;\n        const foreignRelation = this._foreignRelation;\n\n        // Check if the item to be added is already in this table.\n        const modelId = dataProvider.modelId(model);\n        let addedItem = dataProvider.get(modelId);\n\n        if (addedItem) {\n            const newAttr = _.extend({}, addedItem.attributes, model);\n            addedItem.set(newAttr);\n            return addedItem;\n        }\n\n        // Otherwise a new item\n        addedItem = dataProvider.add(model);\n\n        // Add convenient methods\n        addedItem.destroyFromTable = function() {\n            const thatItem = this;\n            selfContext.destroyFromTable(thatItem);\n        };\n\n        addedItem.getForeignModel = function(foreignKey: string): IModelLike {\n            const thatItem = this;\n            return selfContext.getForeignModel(thatItem, foreignKey);\n        };\n\n        addedItem.hasAnyReference = function(): boolean {\n            const thatItem = this;\n            return selfContext.hasAnyReference(thatItem);\n        };\n\n        return addedItem;\n    }\n\n    /**\n     * Add many items into a table.\n     */\n    addMany(models: any[]): IFullModelLike[] {\n        return models.map(model => {\n            return this.add(model);\n        });\n    }\n\n    /**\n     * Adds a foreign relation.\n     */\n    addForeignRelation(foreignKey: string, foreignTable: IRelationalTable): void {\n        if (this._foreignRelation[foreignKey]) {\n            throw new Error('Foreign key exists: ' + foreignKey);\n        }\n        this._foreignRelation[foreignKey] = foreignTable;\n    }\n\n    /**\n     * Add a reverse foreign relation.\n     */\n    addReverseForeignRelation(reverseForeignKey: string, table: IRelationalTable): void {\n        const reverseTables = this._reverseForeignRelation[reverseForeignKey];\n        if (reverseTables) {\n            const index = reverseTables.findIndex((elem) => {\n                return elem === table;\n            });\n\n            if (index !== -1) {\n                throw new Error('Reverse foreign table exists: ' + reverseForeignKey);\n            }\n\n            reverseTables.push(table);\n        } else {\n            this._reverseForeignRelation[reverseForeignKey] = [table];\n        }\n    }\n\n    /**\n     * Check if a given foreign relation is present.\n     */\n    hasForeignRelation(foreignKey: string): boolean {\n        return !!this._foreignRelation[foreignKey];\n    }\n\n    /**\n     * Checks if a given reverse foreign relation is present.\n     */\n    hasReverseForeignRelation(reverseForeignKey: string): boolean {\n        return !!this._reverseForeignRelation[reverseForeignKey];\n    }\n\n    /**\n     * Destroys table\n     */\n    destroy(): void {\n        // Remove constraint\n        this._deleteConstraint.offChange(this._onDeletedHandler);\n        this._dataProvider.reset();\n    }\n}\n\n","/**\n * @fileOverview\n * Defines a global dummy records for tables. Each table is configured with a dummy record.\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IModelLike } from '../interfaces/backbone.interface';\n\nconst backbone = dependencies.backbone;\n\nexport class DummyRecords {\n\n    private _data: { [key: string]: IModelLike };\n\n    constructor() {\n        this._data = {};\n    }\n\n    getDummyRecord(key: string) {\n        if (!this._data[key]) {\n            this._data[key] = new backbone.Model({});\n        }\n        return this._data[key];\n    }\n}\n","/**\n * @fileOverview\n * Defines a relational database which supports foreign keys and primary keys.\n * Also this database support cascading deletion and addition.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IRelationalTableOptions, IRelationalTable, RelationalTable } from './table';\nimport { DummyRecords } from './dummy-records';\n\nexport interface IRelationalDatabase {\n    getReference(): IRelationalDatabase;\n    addTable(options: IRelationalTableOptions): IRelationalTable;\n    getTable(name: string): IRelationalTable;\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void;\n    destroy(): void;\n}\n\nexport class RelationDatabase implements IRelationalDatabase {\n\n    private _tableCollection: { [key: string]: IRelationalTable };\n    private _referenceCounter: number;\n    private _dummyRecords: DummyRecords;\n\n    /**\n     * Represents a relational database.\n     */\n    constructor() {\n        this._referenceCounter = 1;\n        this._tableCollection = {};\n        this._dummyRecords = new DummyRecords();\n    }\n\n    /**\n     * Gets a reference of the file system database\n     */\n    getReference(): IRelationalDatabase {\n        this._referenceCounter++;\n        return this;\n    }\n\n    /**\n     * Defines a table in the database.\n     * @function addTable\n     * @param {Object} settings\n     */\n    addTable(options: IRelationalTableOptions): IRelationalTable {\n        return this._tableCollection[options.name] = new RelationalTable(options, this._dummyRecords);\n    }\n\n    /**\n     * Retrieves a table by name.\n     */\n    getTable(name: string): IRelationalTable {\n        return this._tableCollection[name];\n    }\n\n    /**\n     * Defines a foreign relation between two tables.\n     */\n    addForeignkey(name: string, foreignKey: string, foreignName: string): void {\n        // Constraints\n        const table = this._tableCollection[name];\n        if (!table) {\n            throw new Error('Undefined table: ' + name);\n        }\n\n        const foreignTable = this._tableCollection[foreignName];\n        if (!foreignTable) {\n            throw new Error('Undefined foreign table: ' + foreignName);\n        }\n\n        table.addForeignRelation(foreignKey, foreignTable);\n        foreignTable.addReverseForeignRelation(foreignKey, table);\n    }\n\n    /**\n     * Destroys database\n     */\n    destroy(): void {\n        this._referenceCounter--;\n        if (this._referenceCounter === 0) {\n            for (const k in this._tableCollection) {\n                if (this._tableCollection.hasOwnProperty(k)) {\n                    const table = this._tableCollection[k];\n                    table.destroy();\n                }\n            }\n            this._tableCollection = {};\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a class for performing XHR in an exception way and in a promise way\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst XHR = dependencies.XHR;\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nconst _ = dependencies.underscore;\n\nexport interface IXHRCtorOption {\n    url: string;\n    async?: boolean;\n    type?: 'POST' | 'GET';\n    content_type: 'application/x-www-form-urlencoded' | 'application/json' | '';\n    response_type: 'json' | 'blob' | 'document' | 'text' | 'arraybuffer' | '';\n    requestheaders: any[];\n    scope?: any;\n    success_scope?: any;\n    error_scope?: any;\n    data?: any;\n}\n\nconst defaultOptions = {\n    async: true,\n    content_type: '',\n    response_type: 'json',\n    requestheaders: [],\n    success_scope: null,\n    error_scope: null,\n    scope: null\n};\n\nexport function sendPromise(options: IXHRCtorOption): PromiseLike<any> {\n    const settings = _.extend({}, defaultOptions, options);\n\n    const promise: PromiseLike<any> = new Promise((resolve, reject) => {\n        const xhrSettings = {\n            url: settings.url,\n            content_type: settings.content_type,\n            response_type: settings.response_type,\n            type: settings.type,\n            data: settings.data,\n            async: settings.async,\n            success: (output, xhr, input) => {\n                resolve({\n                    response: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            error: (output, xhr, input) => {\n                reject({\n                    error: output,\n                    xhr: xhr,\n                    settings: input\n                });\n            },\n            success_scope: settings.success_scope,\n            error_scope: settings.error_scope,\n            scope: settings.scope,\n            requestheaders: settings.requestheaders\n        };\n        // Process sent-out data\n        if (settings.content_type === 'application/x-www-form-urlencoded') {\n            xhrSettings.data = urlEncode(xhrSettings.data);\n        } else if (settings.content_type === 'application/json') {\n            xhrSettings.data = JSON.stringify(xhrSettings.data);\n        }\n        XHR.send(xhrSettings);\n    });\n\n    return promise;\n}\n","/**\n * @fileOverview\n * Provides a bunch of utilties on network communication.\n * @name Curl.js\n * @module hypercom/util/Curl\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst tools = dependencies.Tools;\n\nconst $ = dependencies.jquery;\n\n/**\n * Load a local json file from the given url.\n * This method encapsulates the behavior of loading a local json\n * file, in order that changing its behavior in the future\n * will not impact other modules.\n * We currently leaverage the cache capability of a browser.\n * In the future, we may use memory cache.\n * Also this method returns a promise compatible project, and\n * therefore, please use \"then\" to go future.\n * @function loadJsonUriP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadJsonUriP(url) {\n    const deferred = $.ajax({\n        url: url, /* 'lang/options.json', */\n        cache: true,\n        dataType: 'json'\n    });\n    return deferred;\n}\n\n/**\n * Tests if a url is reachable.\n * @function pingP\n * @param {String} url The url to be tested.\n * @param {Object} [options]  A set of ajax parameters.\n * @returns {Promise}\n */\nexport function pingP(url, options) {\n    options = options || {};\n    const ajaxParams = tools.extend({ url: url }, options);\n    return $.ajax(ajaxParams);\n}\n\n/**\n * Reads a the response from a given url and\n * parses it into a jquery object.\n * @function loadHtmlP\n * @param {String} url\n * @returns {Promise}\n */\nexport function loadHtmlP(url) {\n    return $.ajax({\n        url: url,\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        const doc = new DOMParser().parseFromString(data, 'text/html');\n        return $(doc);\n    });\n}\n","import { ICacheBackend } from './cache-backend.interface';\r\n\r\n\r\nexport class MemoryBackend<T> implements ICacheBackend<T> {\r\n\r\n    private _store: { [key: string]: T | number };\r\n\r\n    constructor() {\r\n        this._store = {};\r\n    }\r\n\r\n    /**\r\n     * Sets a key-value pair\r\n     */\r\n    set(key: string, value: T | number): T | number {\r\n        this._store[key] = value;\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * Gets the value for a given key.\r\n     */\r\n    get(key: string): T | number | null {\r\n        return this._store[key] || null;\r\n    }\r\n\r\n    /**\r\n     * Removes the given key and its corresponding value.\r\n     */\r\n    remove(key: string): void {\r\n        delete this._store[key];\r\n    }\r\n\r\n    /**\r\n     * Returns the number of stored items.\r\n     */\r\n    length(key: string): number {\r\n        return Object.keys(this._store).length;\r\n    }\r\n\r\n    /**\r\n     * Retuns the ith key in the store table.\r\n     */\r\n    key(index: number): string {\r\n        const keys = Object.keys(this._store);\r\n\r\n        if (index >= 0 && index < keys.length) {\r\n            return keys[index];\r\n        }\r\n\r\n        return '';\r\n    }\r\n\r\n    /**\r\n     * Returns if this storage is enabled.\r\n     * This method is required by locachejs.\r\n     */\r\n    enabled(): boolean {\r\n        return true;\r\n    }\r\n}\r\n\r\n","//\r\n// Author:: Tom Tang <principleware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nconst EventDispatcher = dependencies.EventDispatcher;\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\n\r\nconst getEventDispatcher = function(obj) {\r\n    if (!obj._eventDispatcher) {\r\n        obj._eventDispatcher = new EventDispatcher({\r\n            scope: obj,\r\n            toggleEvent: function(name, state) {\r\n                if (EventDispatcher.isNative(name) && obj.toggleNativeEvent) {\r\n                    obj.toggleNativeEvent(name, state);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    return obj._eventDispatcher;\r\n};\r\n\r\nexport function observableDecorator<T extends { new(...args: any[]) }>(constructor: T) {\r\n    return class extends constructor {\r\n\r\n        public fire<U>(name: string, evt: IEventArgs<U>, bubble?: boolean): IEventArgs<U> {\r\n            const self = this;\r\n\r\n            // Prevent all events except the remove event after the instance has been removed\r\n            if (self.removed && name !== 'remove') {\r\n                return null;\r\n            }\r\n\r\n            const newEvt = getEventDispatcher(self).fire(name, evt, bubble);\r\n\r\n            // Bubble event up to parents\r\n            if (bubble !== false && self.parent) {\r\n                let parent = self.parent();\r\n                while (parent && !newEvt.isPropagationStopped()) {\r\n                    parent.fire(name, newEvt, false);\r\n                    parent = parent.parent();\r\n                }\r\n            }\r\n\r\n            return newEvt;\r\n        }\r\n\r\n\r\n        public on(name: string, callback: (...args: any[]) => any, prepend?: boolean): any {\r\n            return getEventDispatcher(this).on(name, callback, prepend);\r\n        }\r\n\r\n        public off(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).off(name, callback);\r\n        }\r\n\r\n        public once(name: string, callback: (...args: any[]) => any): any {\r\n            return getEventDispatcher(this).once(name, callback);\r\n        }\r\n\r\n        public hasEventListeners(name: string): boolean {\r\n            return getEventDispatcher(this).has(name);\r\n        }\r\n    };\r\n}\r\n","//\r\n// Author:: Tom Tang <polpware@gmail.com>\r\n// Copyright:: Copyright (c) 2017, Xiaolong Tang\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining\r\n// a copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to\r\n// permit persons to whom the Software is furnished to do so, subject to\r\n// the following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be\r\n// included in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\r\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\r\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\r\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\r\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n//\r\n// Except as contained in this notice, the name(s) of the above copyright\r\n// holders shall not be used in advertising or otherwise to promote the\r\n// sale, use or other dealings in this Software without prior written\r\n// authorization.\r\n\r\nimport * as dependencies from '@polpware/fe-dependencies';\r\n\r\nimport { MemoryBackend } from './memory-backend';\r\nimport { observableDecorator } from '../decorators/observable.decorator';\r\n\r\nimport { IEventArgs } from '../interfaces/event-args.interface';\r\nimport { IObservable } from '../interfaces/observable.interface';\r\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\r\nimport { INgZoneLike } from '../interfaces/ng-zone-like.interface';\r\n\r\nimport { ISlidingExpireCache } from './sliding-expire-cache.interface';\r\n\r\nconst locache = dependencies.locache;\r\nconst meld = dependencies.meld;\r\n\r\nconst originalRemove = Object.getPrototypeOf(locache.locache).remove;\r\n\r\nconst currentTime = function() {\r\n    return new Date().getTime();\r\n};\r\n\r\n@observableDecorator\r\nexport class SlidingExpirationCache<T> implements ISlidingExpireCache<T> {\r\n\r\n    private _cache: any;\r\n    private _timeInterval: any;\r\n\r\n    constructor(private _defaultSeconds: number,\r\n        scheduleInterval?: number, ngZone?: INgZoneLike) {\r\n\r\n        const backend = new MemoryBackend<T>();\r\n        this._cache = locache.locache.createCache({ storage: backend });\r\n\r\n        this._cache.remove = meld.around(originalRemove, (input: IJoinpoint) => {\r\n\r\n            const key = input.args[0];\r\n            const onExpireEvtName = this.onExpireEventName(key);\r\n            const event = this.asObservable.fire(onExpireEvtName, {});\r\n\r\n            // if the event is stopped, then stop doing it\r\n            // more time is required ...\r\n            if (event.isDefaultPrevented()) {\r\n                this.resetExpireKey(key, this._defaultSeconds);\r\n                return false;\r\n            }\r\n\r\n            // Otherwise, continue the original logic\r\n            // Remove all listener\r\n            this.asObservable.off(onExpireEvtName, null);\r\n            input.proceed();\r\n\r\n            // fire event\r\n            const afterRemoveEvtName = this.afterRemoveEventName(key);\r\n            this.asObservable.fire(afterRemoveEvtName, {});\r\n\r\n            return true;\r\n        });\r\n\r\n        // interval\r\n        if (scheduleInterval) {\r\n            if (ngZone) {\r\n                ngZone.runOutsideAngular(() => {\r\n                    this._timeInterval = setInterval(() => {\r\n                        this._cache.cleanup();\r\n                    }, scheduleInterval * 1000);\r\n                });\r\n            }\r\n            else {\r\n                this._timeInterval = setInterval(() => {\r\n                    this._cache.cleanup();\r\n                }, scheduleInterval * 1000);\r\n            }\r\n        } else {\r\n            this._timeInterval = null;\r\n        }\r\n    }\r\n\r\n    private onExpireEventName(key: string): string {\r\n        return 'onExpire:' + key;\r\n    }\r\n\r\n    private afterRemoveEventName(key: string): string {\r\n        return 'afterRemove:' + key;\r\n    }\r\n\r\n    private resetExpireKey(key: string, seconds: number) {\r\n        const expirekey = this._cache.expirekey(key);\r\n        const ms = seconds * 1000;\r\n        this._cache.storage.set(expirekey, currentTime() + ms);\r\n    }\r\n\r\n    get asObservable(): IObservable {\r\n        const self: any = this;\r\n        const observable: IObservable = self;\r\n        return observable;\r\n    }\r\n\r\n    // Given a key, a value and an optional number of seconds store the value\r\n    // in the storage backend.\r\n    set(key: string, value: T, seconds: number, afterRemoveCallback?: (evt: IEventArgs<{}>) => IEventArgs<{}>) {\r\n\r\n        const expirekey = this._cache.expirekey(key);\r\n        const valueKey = this._cache.key(key);\r\n\r\n        if (seconds) {\r\n            // The time stored is in milliseconds, but this function expects\r\n            // seconds, so multiply by 1000.\r\n            const ms = seconds * 1000;\r\n            this._cache.storage.set(expirekey, currentTime() + ms);\r\n        } else {\r\n            // Remove the expire key, if no timeout is set\r\n            this._cache.storage.remove(expirekey);\r\n        }\r\n\r\n        if (afterRemoveCallback) {\r\n            this.asObservable.once(this.afterRemoveEventName(key), afterRemoveCallback);\r\n        }\r\n\r\n        return this._cache.storage.set(valueKey, value);\r\n    }\r\n\r\n    // Fetch a value from the cache. Either returns the value, or if it\r\n    // doesn't exist (or has expired) return null.\r\n    get(key: string, seconds?: number): T | null {\r\n        // If the value has expired, before returning null remove the key\r\n        // from the storage backend to free up the space.\r\n        if (this._cache.hasExpired(key)) {\r\n            if (this._cache.remove(key)) {\r\n                return null;\r\n            }\r\n        }\r\n\r\n        const valueKey = this._cache.key(key);\r\n        const value = this._cache.storage.get(valueKey);\r\n\r\n        // Slide the expire ke\r\n        if (value) {\r\n            this.resetExpireKey(key, seconds || this._defaultSeconds);\r\n        }\r\n\r\n        // If value isn't truthy, it must be an empty string or similar, so\r\n        // just return that.\r\n        return value;\r\n    }\r\n\r\n    invalidate(key: string): void {\r\n        let keys: string[] = this._cache.keys() || [];\r\n        keys = keys.filter(a => a.indexOf(key) !== -1);\r\n        this.resetInternal(keys);\r\n    }\r\n\r\n    rmOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.off(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    addOnExpireHandler(key: string, callback: (evt: IEventArgs<{}>) => IEventArgs<{}>): void {\r\n        this.asObservable.on(this.onExpireEventName(key), callback);\r\n    }\r\n\r\n    public get count(): number {\r\n        return this._cache.length();\r\n    }\r\n\r\n    reset() {\r\n        const keys = this._cache.keys() || [];\r\n        this.resetInternal(keys);\r\n    }\r\n\r\n    private resetInternal(keys: string[]) {\r\n        keys.forEach((k) => {\r\n            this.asObservable.off(this.onExpireEventName(k), null);\r\n            originalRemove.call(this._cache, k);\r\n            this.asObservable.fire(this.afterRemoveEventName(k), {});\r\n        });\r\n    }\r\n\r\n    // must destory, or leaking ...\r\n    destroy() {\r\n        this.reset();\r\n\r\n        if (this._timeInterval) {\r\n            clearInterval(this._timeInterval);\r\n        }\r\n    }\r\n}\r\n","export interface IPolicyCtorOptions {\r\n    url: string;\r\n}\r\n\r\nexport interface IOAuthTokenPolicyCtorOptions extends IPolicyCtorOptions {\r\n    clientId: string;\r\n    clientSecret: string;\r\n    scope: string;\r\n}\r\n\r\nexport interface IAntiForgeryKeyCtorOptions extends IPolicyCtorOptions {\r\n    antiForgeryKey: string;\r\n    elementTag: string;\r\n}\r\n\r\nexport interface IOAuthParams {\r\n    client_id: string;\r\n    client_secret: string;\r\n    scope: string;\r\n    grant_type: any;\r\n}\r\n\r\nexport interface IOAuthToken {\r\n    expiresIn: number;\r\n    createdOn: number;\r\n    token: string;\r\n    refreshToken: string;\r\n}\r\n\r\nexport interface IOpenIDToken extends IOAuthToken {\r\n    openId: string;\r\n}\r\n\r\nexport interface IPolicy {\r\n    getTokenInternal(): PromiseLike<string>;\r\n\r\n    applyTo(options: any): void;\r\n\r\n    isExpired(): boolean;\r\n\r\n    readFrom(settings: {});\r\n\r\n    persistent(): any;\r\n\r\n    applyToV2(options: any): void;\r\n\r\n    applyToV3(options: any): void;\r\n\r\n    /**\r\n     * The interface for retrieving the token from a remote server.\r\n     * This method internally dispatches the call to another method\r\n     * and cache the token.\r\n     */\r\n    getTokenP(): PromiseLike<string>;\r\n\r\n    reset();\r\n}\r\n\r\nexport const DummyOAuthTokenCtorParams: IOAuthTokenPolicyCtorOptions = {\r\n    url: 'dummy',\r\n    clientId: 'dummy',\r\n    clientSecret: 'dummy',\r\n    scope: 'all'\r\n};\r\n","/**\n * @fileOverview\n * A base class for defining security plicies.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { lift } from '@polpware/fe-utilities';\n\nimport { IPolicyCtorOptions, IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nexport abstract class PolicyBase implements IPolicy {\n\n    protected url: string;\n    protected token: string;\n\n    constructor(settings: IPolicyCtorOptions) {\n        this.url = settings.url;\n        this.token = '';\n    }\n\n    abstract getTokenInternal(): PromiseLike<string>;\n\n    abstract applyTo(options: any): void;\n\n    abstract isExpired(): boolean;\n\n    abstract readFrom(settings: {});\n\n    abstract persistent(): any;\n\n    abstract applyToV2(options: any): void;\n\n    abstract applyToV3(options: any): void;\n\n\n    /**\n     * The interface for retrieving the token from a remote server.\n     * This method internally dispatches the call to another method\n     * and cache the token.\n     */\n    getTokenP(): PromiseLike<string> {\n        if (!_.isEmpty(this.token) && !this.isExpired()) {\n            return lift(this.token, null);\n        }\n\n        return this.getTokenInternal()\n            .then((token) => {\n                return this.token = token;\n            });\n    }\n\n    /**\n     * Reset the security policy, e.g.,\n     * removing established token.\n     */\n    reset() {\n        this.token = '';\n    }\n}\n","/**\n * @fileOverview\n * Defines a base class for retrieving OAuth2 tokens.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { safeParseInt } from '@polpware/fe-utilities';\nimport {\n    IOAuthTokenPolicyCtorOptions,\n    IOAuthToken,\n    IOAuthParams\n} from './interfaces';\nimport { PolicyBase } from './policy-base';\n\nconst _ = dependencies.underscore;\nconst $ = dependencies.jquery;\n\nexport function adaptToOAuthToken(data): IOAuthToken {\n    data = data || {};\n    data.expiresIn = data.expiresIn || 0;\n    data.createdOn = data.createdOn || 0;\n    data.token = data.token || '';\n    data.refreshToken = data.refreshToken || '';\n\n    return data;\n}\n\nexport class OAuthTokenPolicy extends PolicyBase {\n\n    protected clientId: string;\n    protected clientSecret: string;\n    protected scope: string;\n    protected expiresIn: number;\n    protected createdOn: number;\n    protected refreshToken: string;\n    public grantType: 'authorization_code' | 'refresh_token' | 'password' | 'client_credentials';\n\n    public response: any;\n\n    constructor(settings: IOAuthTokenPolicyCtorOptions) {\n        super(settings);\n\n        this.clientId = settings.clientId;\n        this.clientSecret = settings.clientSecret;\n        this.scope = settings.scope;\n        this.expiresIn = null;\n        this.createdOn = null;\n        this.refreshToken = '';\n\n        this.response = null;\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     */\n    readFrom(settings: IOAuthToken) {\n        this.expiresIn = settings.expiresIn;\n        this.createdOn = settings.createdOn;\n        this.token = settings.token;\n        this.refreshToken = settings.refreshToken;\n    }\n\n    /**\n     * Returns the data that are persistentable.\n     */\n    persistent(): IOAuthToken {\n        return {\n            expiresIn: this.expiresIn,\n            createdOn: this.createdOn,\n            token: this.token,\n            refreshToken: this.refreshToken\n        };\n    }\n\n    getParams(): any {\n        return {\n            client_id: this.clientId,\n            client_secret: this.clientSecret,\n            scope: this.scope,\n            grant_type: this.grantType\n        };\n    }\n\n    // TODO: Support progress loading\n    getTokenInternal(): PromiseLike<string> {\n        const params = this.getParams();\n        return $.ajax({\n            url: this.url,\n            data: params,\n            method: 'POST'\n        }).then((resp) => {\n\n            // Put down the response\n            this.response = resp;\n\n            this.createdOn = new Date().getTime();\n            this.expiresIn = resp.expires_in;\n            this.refreshToken = resp.refreshToken || '';\n            resp.scope && (this.scope = resp.scope);\n            return (resp.access_token);\n        });\n    }\n\n    /**\n     * Returns if the token is expired or not.\n     */\n    isExpired(): boolean {\n        if (!this.token || this.token.length < 1) {\n            return true;\n        }\n        if (!this.createdOn) {\n            return true;\n        }\n        const expiresIn = safeParseInt(this.expiresIn);\n        if (expiresIn <= 0) {\n            return true;\n        }\n        const now = new Date();\n        const diff = now.getTime() - this.createdOn;\n        if (diff < expiresIn * 1000) {\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * Applys the token to the given options.\n     */\n    applyTo(options: any): void {\n        options.beforeSend = (xhr) => {\n            xhr.setRequestHeader('Authorization', ('Bearer '.concat(this.token)));\n        };\n    }\n\n    /**\n     * Apply security policy to the given options.\n     */\n    applyToV2(options: any): void {\n        options.headers = options.headers || {};\n        options.headers = {\n            Authorization: 'Bearer '.concat(this.token)\n        };\n    }\n\n    /**\n     * App security policy the given options, used for our customized XHR.\n     */\n    applyToV3(options: any): void {\n        options.requestheaders = options.requestheaders || [];\n        options.requestheaders.push({\n            key: 'Authorization',\n            value: 'Bearer '.concat(this.token)\n        });\n    }\n\n    /**\n     * Resets the token and its assoicated information.\n     */\n    reset() {\n        super.reset();\n        this.refreshToken = '';\n        this.expiresIn = null;\n        this.createdOn = null;\n    }\n}\n","/**\r\n * @fileOverview\r\n * OpenID token policy, built upon OAuth2 token policy\r\n */\r\n\r\nimport {\r\n    IOpenIDToken,\r\n    DummyOAuthTokenCtorParams\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy, adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport function adaptToOpenIDToken(data): IOpenIDToken {\r\n    data = data || {};\r\n\r\n    const r = adaptToOAuthToken(data);\r\n    return { ...r, openId: data.openId || '' };\r\n}\r\n\r\nexport class OpenIDPolicy extends OAuthTokenPolicy {\r\n\r\n    private _openId: string;\r\n\r\n    constructor() {\r\n        super(DummyOAuthTokenCtorParams);\r\n        this._openId = '';\r\n    }\r\n\r\n    /**\r\n     * Returns the necessary information for peristence.\r\n     */\r\n    persistent(): IOpenIDToken {\r\n        const r = super.persistent();\r\n        return { ...r, openId: this._openId };\r\n    }\r\n\r\n    /**\r\n     * Reads credential from the given settings.\r\n     */\r\n    readFrom(settings: IOpenIDToken) {\r\n        super.readFrom(settings);\r\n        this._openId = settings.openId;\r\n        return this;\r\n    }\r\n}\r\n","import { lift } from '@polpware/fe-utilities';\r\n\r\nimport { IPolicy } from './interfaces';\r\n\r\nexport class NullPolicy implements IPolicy {\r\n\r\n    getTokenInternal(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    applyTo(options: any): void { }\r\n\r\n    isExpired(): boolean {\r\n        return false;\r\n    }\r\n\r\n    readFrom(settings: {}) { }\r\n\r\n\r\n    persistent(): any { }\r\n\r\n    applyToV2(options: any): void { }\r\n\r\n    applyToV3(options: any): void { }\r\n\r\n    getTokenP(): PromiseLike<string> {\r\n        throw new Error('NotImplemented');\r\n    }\r\n\r\n    reset() { }\r\n}\r\n","/**\n * @fileOverview\n * Defines the user credential. This user credential supports event\n * listening. Note that the credential is assumed to be Uppercase:\n * Username and Password\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport {\n    isArray\n} from '@polpware/fe-utilities';\n\nimport { observableDecorator } from '../decorators/observable.decorator';\nimport { IObservable } from '../interfaces/observable.interface';\nimport { IEventArgs } from '../interfaces/event-args.interface';\n\nimport { IPolicy } from './interfaces';\n\nconst _ = dependencies.underscore;\n\nfunction isEquiva(a: any, b: any): boolean {\n\n    // Strict equals\n    if (a === b) {\n        return true;\n    }\n\n    // Compare null\n    if (a === null || b === null) {\n        return a === b;\n    }\n\n    // Compare number, boolean, string, undefined\n    if (typeof a !== 'object' || typeof b !== 'object') {\n        return a === b;\n    }\n\n    // Compare arrays\n    if (isArray(b) && isArray(a)) {\n        if (a.length !== b.length) {\n            return false;\n        }\n\n        let k = a.length;\n        while (k--) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    const checked = {};\n    const objectB = b as Object;\n    for (const k in objectB) {\n        if (objectB.hasOwnProperty(k)) {\n            if (!isEquiva(a[k], b[k])) {\n                return false;\n            }\n\n            checked[k] = true;\n        }\n    }\n\n    const objectA = a as Object;\n    for (const k in objectA) {\n        if (objectA.hasOwnProperty(k)) {\n            if (!checked[k] && !isEquiva(a[k], b[k])) {\n                return false;\n            }\n        }\n    }\n\n    return true;\n}\n\nexport interface IUserProfile {\n    username?: string;\n    email?: string;\n    role?: string;\n    displayName?: string;\n}\n\n// immutable\n\n@observableDecorator\nexport class UserCredential<T extends IPolicy> {\n\n    private _security: T;\n    private _user: IUserProfile;\n    /**\n     * @constructor Credential\n     */\n    constructor(public authPolicy: T) {\n        this._user = {};\n        this._security = authPolicy;\n    }\n\n    public get asObservable(): IObservable {\n        const self: any = this;\n        return self as IObservable;\n    }\n\n    public security(value?: T): T {\n        if (value) {\n            this._security = value;\n        }\n        return this._security;\n    }\n\n    // Does not trigger any event\n    readFrom<U extends IUserProfile>(data: U): void {\n        this._user = _.extend(this._user, data);\n    }\n\n    setUser<U extends IUserProfile>(data: U): void {\n        if (isEquiva(this._user, data)) {\n            return;\n        }\n\n        this._user = data;\n        this.asObservable.fire('change:user', {\n            data: this._user\n        });\n    }\n\n    extendUser<U extends IUserProfile>(data: U): void {\n        const newData = _.extend({}, this._user, data);\n        this.setUser(newData);\n    }\n\n    getUser<U extends IUserProfile>(): U {\n        return _.extend({}, this._user);\n    }\n\n    subscribe<U extends IUserProfile>(handler: (evt: IEventArgs<U>) => IEventArgs<U>, likeBehaviorSubject: boolean = false) {\n        this.asObservable.on('change:user', handler);\n\n        if (likeBehaviorSubject) {\n            const newEvt: any = { data: this._user };\n            handler(newEvt as IEventArgs<U>);\n        }\n    }\n\n    unSubscribe(handler: (evt: any) => any) {\n        this.asObservable.off('change:user', handler);\n    }\n\n    isUserKnown(): boolean {\n        return !!(this._user && this._user.username);\n    }\n\n    isAuthenticated(): boolean {\n        return this.authPolicy && !this.authPolicy.isExpired();\n    }\n}\n\n","/**\n * @fileOverview\n * Provides the anti-forgery security policy.\n * @name AntiForgeryKeyPolicy.js\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { liftWithGuard } from '@polpware/fe-utilities';\n\nimport { IAntiForgeryKeyCtorOptions } from './interfaces';\n\nimport { PolicyBase } from './policy-base';\n\nconst $ = dependencies.jquery;\nconst defaultAntiForgeryKey = '__RequestVerificationToken';\nconst defaultElementTag = '';\n\n/*\n <input name=\"__RequestVerificationToken\" type=\"hidden\"\n value=\"J8kl6w7KaBAteKOPeHW1IlG9RS7abCkbvQf2GwBlMVZZOX9FF-Bhc5mYmqXw4qe0MLraucQtKC-TAVh1rJEZ0SDfeLfqp-L5JrthIM9V0gp76-jnVz9J-rdYFhVeTT4Y0\">\n */\nfunction getTokenInternal(url: string, elementTag: string, inputField: string): PromiseLike<string> {\n    return $.ajax({\n        url: url, // A page containing required tokens\n        dataType: 'html text'\n    }).then(function(data) {\n        /*global DOMParser */\n        let doc, token, elm;\n        token = '';\n        doc = new DOMParser().parseFromString(data, 'text/html');\n        if (elementTag) {\n            elm = $(doc).find(elementTag);\n            if (elm.length > 0) {\n                elm = $(doc).find(inputField);\n                if (elm.length > 0) {\n                    elm = elm.eq(0);\n                    token = elm.attr('value');\n                }\n            }\n        } else {\n            elm = $(doc).find(inputField);\n            if (elm.length > 0) {\n                elm = elm.eq(0);\n                token = elm.attr('value');\n            }\n        }\n        return token;\n    });\n}\n\nexport class AntiForgeryKeyPolicy extends PolicyBase {\n\n    private _antiForgeryKey: string;\n    private _elementTag: string;\n    private _expired: boolean;\n\n    /**\n     * @constructor AntiForgeryKeyPolicy\n     * @param {Object} [settings] A set of settings.\n     */\n    constructor(settings: IAntiForgeryKeyCtorOptions) {\n        super(settings);\n        this._antiForgeryKey =\n            settings.antiForgeryKey || defaultAntiForgeryKey;\n        this._elementTag = settings.elementTag || defaultElementTag;\n        this._expired = true;\n    }\n\n    isExpired(): boolean {\n        return this._expired;\n    }\n\n    inputField(): string {\n        return 'input[name=\"' + this._antiForgeryKey + '\"]';\n    }\n\n    /**\n     * Feeds the policy with some settings from outside,\n     * usually from local storage\n     * @function readFrom\n     * @param {Object} settings\n     * @returns {Object}\n     */\n    readFrom(settings) {\n        this.token = settings.token;\n    }\n\n    /**\n     * Returns the object that are persistentable.\n     * @function persistent\n     * @returns {Object}\n     */\n    persistent() {\n        return {\n            token: this.token\n        };\n    }\n\n    /**\n     * Gets the anti-forgery token from the given url\n     * or the instance url.\n     * @function getTokenP\n     * @param {String}[url] The URL where the response from it may contain\n     * the anti-forgery token; it is optional and used when you want to\n     * overwrite the instance url.\n     * @returns {Promise}\n     * @throws {}\n     */\n    getTokenInternal(): PromiseLike<string> {\n        const ret = getTokenInternal(this.url, this._elementTag, this.inputField());\n        const p = liftWithGuard(ret, function(token) {\n            const isGoodToken = token && token.length > 0;\n            this._expired = !isGoodToken;\n            return isGoodToken;\n        });\n        return ret;\n    }\n\n    /**\n     * Applys the anti-forgery key and its value to the given options.\n     * @function apply\n     * @param {Object} options The options to be used for making a request.\n     */\n    applyTo(options) {\n        const data = options.data;\n        data[this._antiForgeryKey] = this.token;\n    }\n\n    /**\n     * Apply security policy to the given options.\n     * @function applyToV2\n     * @param {Object} options A params field is expected.\n     */\n    applyToV2(options) {\n        options.params = options.params || {};\n        options.params[this._antiForgeryKey] = this.token;\n    }\n\n    // TODO:\n    applyToV3(options) {\n    }\n\n    /**\n     * Resets the token and expired flag\n     * @function reset\n     */\n    reset() {\n        super.reset();\n        this._expired = true;\n    }\n}\n","import {\r\n    IOAuthTokenPolicyCtorOptions\r\n} from './interfaces';\r\n\r\nimport { OAuthTokenPolicy } from './oauth-token-policy';\r\nexport { adaptToOAuthToken } from './oauth-token-policy';\r\n\r\nexport class OAuthTokenExtPolicy extends OAuthTokenPolicy {\r\n\r\n    private _payload: object;\r\n\r\n    constructor(settings: IOAuthTokenPolicyCtorOptions, payload: object) {\r\n        super(settings);\r\n\r\n        this._payload = { ...payload };\r\n    }\r\n\r\n    public get payload(): object {\r\n        return this._payload;\r\n    }\r\n\r\n    // override\r\n    getParams(): any {\r\n        const p = super.getParams();\r\n        return { ...p, ... this._payload };\r\n    }\r\n}\r\n","import {\r\n    CollectionActionWithPayload,\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from '../collection-action-def';\r\n\r\nexport function reducer<T extends ICollectionItem>(\r\n    state: ICollectionState<T>,\r\n    action: CollectionActionWithPayload<T>\r\n): ICollectionState<T> {\r\n    switch (action.type) {\r\n\r\n        case 'ADD': {\r\n\r\n            const payload = action.payload.filter(x => {\r\n                // Look for it in the current list\r\n                const index = state.items.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: [\r\n                    ...state.items,\r\n                    ...payload\r\n                ]\r\n            };\r\n        }\r\n\r\n        case 'REMOVE': {\r\n\r\n            const newItems = state.items.filter(x => {\r\n                const index = action.payload.findIndex((y) => {\r\n                    return x.id === y.id;\r\n                });\r\n                return index === -1;\r\n            });\r\n\r\n            return {\r\n                ...state,\r\n                items: newItems\r\n            };\r\n        }\r\n\r\n        case 'MODIFY': {\r\n\r\n            // Nothing to do\r\n            return state;\r\n        }\r\n\r\n        default:\r\n            return state;\r\n\r\n    }\r\n}\r\n","import { ActionReducerMap } from '@ngrx/store';\r\nimport { combineReducers } from '@ngrx/store';\r\n\r\nimport { ICollectionState, ICollectionItem } from '../collection-action-def';\r\nimport * as fromCollection from './collection.reducer';\r\n\r\n\r\nexport interface GenericState<T extends ICollectionItem> {\r\n    collection: ICollectionState<T>;\r\n}\r\n\r\nexport function buildInitialState<T extends ICollectionItem>(): GenericState<T> {\r\n    return {\r\n        collection: {\r\n            items: []\r\n        }\r\n    };\r\n}\r\n\r\nexport function buildReducerMap<T extends ICollectionItem>(): ActionReducerMap<GenericState<T>> {\r\n    return {\r\n        collection: fromCollection.reducer\r\n    };\r\n}\r\n\r\n\r\n","import * as ngrxStore from '@ngrx/store';\r\n\r\nimport { ICollectionItem } from './collection-action-def';\r\n\r\nimport * as reducerIndex from './reducers/index';\r\n\r\n// Store\r\n/*\r\n    ReducerManager,\r\n    StateObservable,\r\n    ActionsSubject\r\n*/\r\n\r\n// StateObservable\r\n/*\r\n   ActionsSubject\r\n   ReducerManager\r\n   ScannnedActionsSubject => leaf\r\n   InitialState\r\n*/\r\n\r\n// ActionsSubject (leaf)\r\n\r\n// ReducerManager\r\n/*\r\n   ReducerManagerDispatcher\r\n   INITIAL_STATE  => pass in parameters\r\n   INITIAL_REDUCERS => ActionReducerMap (pass in parameters)\r\n   REDUCER_FACTORY => combineReducers\r\n   ActionReducerFactory<any, any>\r\n*/\r\n\r\n// ReducerManagerDispatcher\r\n\r\n/*\r\n   ActionSsubject  (leaf)\r\n*/\r\n\r\n// ActionReducerFactory<any, any> (Use combinReducer function from utils)\r\n\r\n/*\r\n   ActionReducerMap\r\n   initialState\r\n\r\n   ActionReducer\r\n*/\r\n\r\n// createReducerfactory\r\n/*\r\n   ActionReducerFactory\r\n   MataReducerFactory\r\n\r\n*/\r\n\r\nexport function factory<T extends ICollectionItem>(): ngrxStore.Store<reducerIndex.GenericState<T>> {\r\n\r\n    const actionSubject = new ngrxStore.ActionsSubject();\r\n    const scannerActionSubject = new ngrxStore.ScannedActionsSubject();\r\n    const reducerManagerDispatch: ngrxStore.ReducerManagerDispatcher = actionSubject;\r\n\r\n    const actionReducerFactory: ngrxStore.ActionReducerFactory<any, any> = ngrxStore.combineReducers;\r\n\r\n    const reducerManager = new ngrxStore.ReducerManager(actionSubject,\r\n        reducerIndex.buildInitialState<T>(),\r\n        reducerIndex.buildReducerMap<T>(),\r\n        actionReducerFactory);\r\n\r\n    const stateObservable = new ngrxStore.State(actionSubject,\r\n        reducerManager,\r\n        scannerActionSubject,\r\n        reducerIndex.buildInitialState<T>());\r\n\r\n    const store = new ngrxStore.Store<reducerIndex.GenericState<T>>(stateObservable, actionSubject, reducerManager);\r\n    return store;\r\n}\r\n","import { Store } from '@ngrx/store';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ICollectionState, ICollectionItem } from './collection-action-def';\r\n\r\nimport { ICollectionStore } from './collection-store.interface';\r\nimport { GenericState } from './reducers';\r\n\r\nexport abstract class CollectionAbstractStore<T extends ICollectionItem> implements ICollectionStore<T> {\r\n\r\n    public abstract getState(): Observable<ICollectionState<T>>;\r\n    public abstract getStore(): Store<GenericState<T>>;\r\n\r\n    public add(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'ADD',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public remove(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'REMOVE',\r\n            payload: payload\r\n        });\r\n    }\r\n\r\n    public modify(payload: Array<T>): void {\r\n        this.getStore().dispatch({\r\n            type: 'MODIFY',\r\n            payload: payload\r\n        });\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Store, } from '@ngrx/store';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { factory } from './factory';\r\n\r\nimport { GenericState } from './reducers/index';\r\nimport {\r\n    CollectionAbstractStore\r\n} from './collection-abstract.store';\r\n\r\nimport {\r\n    ICollectionState,\r\n    ICollectionItem\r\n} from './collection-action-def';\r\n\r\n\r\n@Injectable()\r\nexport class CollectionStore<T extends ICollectionItem>\r\n    extends CollectionAbstractStore<T> {\r\n\r\n    private _store: Store<GenericState<T>>;\r\n\r\n    constructor() {\r\n        super();\r\n        this._store = factory<T>();\r\n    }\r\n\r\n    public getStore(): Store<GenericState<T>> {\r\n        return this._store;\r\n    }\r\n\r\n    public getState(): Observable<ICollectionState<T>> {\r\n        return this._store.select('collection');\r\n    }\r\n}\r\n","/**\n * @fileOverview\n * An endpoint which aggregates a few other endpoints, to form a new endpoint.\n * Note that the caller is responsible for resetting underlying data providers\n * and even caching them.\n * Moreover, this class does not assume any knowledge about providerGenerator.\n * providerGenerator may generate the same thing again as again.\n * Also note that it is the provider generator's responsibilty for\n * preversing the state of each data provider.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { IBackboneCollectionLike } from '../interfaces/backbone.interface';\n\nconst when = dependencies.when;\nconst _ = dependencies.underscore;\n\nfunction hasNextPage(collection: IBackboneCollectionLike): boolean {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return true;\n    }\n    return collection.hasNextPage();\n}\n\nfunction getNextPage(collection: IBackboneCollectionLike): PromiseLike<any> {\n    if (!collection.state.totalPages && !collection.state.totalRecords) {\n        return collection.getFirstPage();\n    }\n    return collection.getNextPage();\n}\n\nexport interface IProviderGenerator {\n    hasMore(): boolean;\n    getNext(): PromiseLike<Array<IBackboneCollectionLike>>;\n    reset(): void;\n}\n\nexport class AggregateCollection {\n\n    private _workingProviders: Array<IBackboneCollectionLike>;\n\n    constructor(private _providerGenerator: IProviderGenerator) {\n        this._workingProviders = [];\n    }\n\n    hasNextPage(): boolean {\n        // Case 1: The first time we request, we always have something.\n        if (this._workingProviders.length === 0) {\n            return true;\n        }\n        if (this._providerGenerator.hasMore()) {\n            return true;\n        }\n        return _.some(this._workingProviders, function(elem) {\n            return elem.hasNextPage();\n        });\n    }\n\n    getFirstPage(): PromiseLike<any> {\n        // Generate providers\n        return this._providerGenerator.getNext()\n            .then((providers) => {\n                providers = _.filter(providers, function(p) {\n                    return hasNextPage(p);\n                });\n                return providers;\n            })\n            .then((providers) => {\n                this._workingProviders.length = 0;\n                const promises = _.map(providers, function(p) {\n                    return getNextPage(p)\n                        .then((resp) => {\n                            this._workingProviders.push(p);\n                            return resp;\n                        });\n                });\n                return when.settle(promises);\n            });\n    }\n\n    getNextPage(): PromiseLike<any> {\n        return this.getFirstPage();\n    }\n\n    reset(): void {\n        this._providerGenerator.reset();\n        this._workingProviders = [];\n    }\n\n    forEach(func: (elem: any) => any) {\n        this._workingProviders.forEach((p) => {\n            p.forEach(func);\n        });\n    }\n\n    get(id) {\n        // TODO:\n    }\n}\n\n","/**\n * @fileOverview\n * A decorator to Backbone. It tracks all sync events of the Backbone\n * in a nonintrusive manner.\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst backbone = dependencies.backbone;\nconst meld = dependencies.meld;\n\n/**\n * The callback for the sync event.\n * @callback EventHubcallback\n * @param {Object} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} response The response assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a callback for listening to the sync events from Backbone.\n * @function mountSyncListener\n * @param {EventHubcallback} callback\n * @throws {Error}\n */\nexport function mountSyncListener(callback) {\n    // Collection\n    const remover1 = meld.before(backbone.Collection.prototype, 'trigger', callback);\n    const remover2 = meld.before(backbone.Model.prototype, 'trigger', callback);\n    return [remover1, remover2];\n}\n\n/**\n * The callback for the sync event.\n * @callback EventHubsyncSignature\n * @param {String} method The method assoicated with the sync event.\n * @param {Object} model The model assoicated with the sync event.\n * @param {Object} options The options associated with the sync event.\n */\n\n/**\n * Sets up a pre-sync callback.\n * @function mountSyncBeforeAdvice\n * @param {EventHubsyncSignature} callback\n */\nexport function mountSyncBeforeAdvice(callback) {\n    return meld.before(backbone, 'sync', callback);\n}\n\n/**\n * The signature for the around advice.\n * @callback EventHubaroundAdviceSignature\n * @param {String} jointpoint the jointpoint for this advice.\n */\n\n/**\n * Sets up an around advice.\n * @function mountSyncAroundAdvice\n * @param {EventHubaroundAdviceSignature} callback\n */\nexport function mountSyncAroundAdvice(callback) {\n    return meld.around(backbone, 'sync', callback);\n}\n\n\n/**\n * Sets up a pre-ajax callback.\n * @function mountAjaxBeforeAdvice\n * @param {Function} callback\n */\nexport function mountAjaxBeforeAdvice(callback) {\n    return meld.before(backbone, 'ajax', callback);\n}\n\n","/**\n * @fileOverview\n * Provides a layer of backend service abstraction.\n * Defines the backend services. This class is built onto the backbone js, but with\n * enhanced abilities of managing the dependency among all services of the backend,\n * and caching some type of objects for a period of time.\n */\n/*jslint unparam: true */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nimport { urlEncode } from '@polpware/fe-utilities';\n\nimport { SlidingExpirationCache } from '../cache/sliding-expiration-cache';\n\nimport { IJoinpoint } from '../interfaces/joint-point.interface';\n\nimport {\n    mountSyncBeforeAdvice,\n    mountAjaxBeforeAdvice,\n    mountSyncAroundAdvice\n} from './event-hub';\n\nimport { IBackboneOptions, IBackboneConfiguration } from './interfaces';\n\nconst DataFlow = dependencies['dataflow'];\nconst backbone = dependencies['backbone'];\nconst _ = dependencies.underscore;\n\n/**\n * The endpoint types for a backend service.\n */\nexport const endPointEnum = {\n    model: 1,\n    collection: 2,\n    pagedCollection: 3\n};\n\n/**\n * The sync types defined in the backbone js.\n */\nexport const syncMethodEnum = {\n    /**\n     * Fetch a model or a collection.\n     */\n    read: 'read',\n    /**\n     * Save a model.\n     */\n    create: 'create',\n    patch: 'patch',\n    update: 'update',\n    /**\n     * Destroy a model\n     */\n    delete: 'delete'\n};\n\nconst globalConfigurationMapping: { [key: string]: IBackboneConfiguration } = {};\nconst mountedFeatureRemovers: any[] = [];\n\n// Idempotent\n// Instance once ...\nfunction mountFeatures() {\n\n    if (mountedFeatureRemovers.length > 0) {\n        return;\n    }\n    /*jslint unparam: true */\n    /*\n      eventHub.mountSyncListener(function (method, model, response, options) {\n      // Ignore other method\n      if (method !== 'sync') {\n      return;\n      }\n      if (options.endPointKey && options.methodKey) {\n      var dataflow = self._dataflow,\n      key = options.endPointKey + ':' + options.methodKey;\n      dataflow[key] = dataflow[key] + 1;\n      }\n      }); */\n\n    let remover = mountSyncBeforeAdvice(function(method, model, options) {\n        options.methodKey = method;\n        options.endPointKey = model.endPointKey || (model.collection ? model.collection.endPointKey : null);\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (method === 'delete') {\n                if (cfgOptions.deleteUrl) {\n                    options.url = cfgOptions.deleteUrl;\n                }\n                if (cfgOptions.deleteContentType) {\n                    options.contentType = cfgOptions.deleteContentType;\n                }\n            } else if (method === 'update') {\n                if (cfgOptions.updateUrl) {\n                    options.url = cfgOptions.updateUrl;\n                }\n                if (cfgOptions.updateContentType) {\n                    options.contentType = cfgOptions.updateContentType;\n                }\n            } else if (method === 'create') {\n                if (cfgOptions.createUrl) {\n                    options.url = cfgOptions.createUrl;\n                }\n                if (cfgOptions.createContentType) {\n                    options.contentType = cfgOptions.createContentType;\n                }\n            } else if (method === 'patch') {\n                if (cfgOptions.patchUrl) {\n                    options.url = cfgOptions.patchUrl;\n                }\n                if (cfgOptions.patchContentType) {\n                    options.contentType = cfgOptions.patchContentType;\n                }\n            }\n        }\n    });\n\n    mountedFeatureRemovers.push(remover);\n    remover = mountAjaxBeforeAdvice(function(options) {\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            const policyDelegate = cfgOptions.securityDelegate;\n            const extraParams = cfgOptions.extraParams;\n            if (cfgOptions.contentType === 'application/x-www-form-urlencoded' &&\n                options.contentType === 'application/json') {\n                options.data = JSON.parse(options.data);\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                options.data = urlEncode(options.data);\n                options.contentType = cfgOptions.contentType;\n            } else {\n                if (extraParams) {\n                    _.extend(options.data, extraParams);\n                }\n                if (policyDelegate) {\n                    policyDelegate(options);\n                }\n                if (options.contentType === 'application/x-www-form-urlencoded') {\n                    options.data = urlEncode(options.data);\n                }\n            }\n        }\n    });\n    mountedFeatureRemovers.push(remover);\n\n    remover = mountSyncAroundAdvice(function(jointpoint: IJoinpoint) {\n        const options = jointpoint.args[2];\n        if (options.endPointKey) {\n            const cfg = globalConfigurationMapping[options.endPointKey];\n            const cfgOptions = cfg.options;\n            if (cfgOptions.syncDelegate) {\n                const syncDelegate = cfgOptions.syncDelegate;\n                // Return a promise\n                return syncDelegate(options.endPointKey, options, cfg, function() {\n                    return jointpoint.proceed();\n                });\n            }\n        }\n        return jointpoint.proceed();\n    });\n    mountedFeatureRemovers.push(remover);\n}\n\nconst defaultLivePeroid = 60 * 5;\n\nexport interface IGlobalProviderCtorOptions {\n    webhost?: string;\n}\n\nexport class GlobalProvider {\n\n    private _host: string;\n    private _dataflow: any;\n    private _cache: SlidingExpirationCache<any>;\n    private _myEndPointKeys: any[];\n    private _uniqueNamePrefix: string;\n\n    constructor(ctorOptions: IGlobalProviderCtorOptions) {\n        this._cache = new SlidingExpirationCache(defaultLivePeroid);\n        this._dataflow = new DataFlow();\n        this._myEndPointKeys = [];\n        this._host = ctorOptions.webhost || '';\n        this._uniqueNamePrefix = this._host ? (this._host.replace('.', '-') + '-') : '';\n\n        // Mount features\n        mountFeatures();\n    }\n\n    public get host(): string {\n        return this._host;\n    }\n\n    public get configurationMapping(): { [key: string]: any } {\n        return globalConfigurationMapping;\n    }\n\n    /**\n     * Defines an endpoint for a kind of service.\n     */\n    addEndPoint(name: string, tag: number, options: IBackboneOptions) {\n        const cfgMapping = this.configurationMapping;\n        const dataflow = this._dataflow;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (cfgMapping[uniqueName]) {\n            throw new Error('Redefined endpoint: ' + name);\n        }\n        cfgMapping[uniqueName] = {\n            options: _.extend(options, { endPointKey: uniqueName }),\n            tag: tag\n        };\n\n        this._myEndPointKeys.push(uniqueName);\n\n        // Set up data flow nodes (it is enough to use local names)\n        if (tag === endPointEnum.model) {\n            for (const k in syncMethodEnum) {\n                // skip loop if the property is from prototype\n                if (syncMethodEnum.hasOwnProperty(k)) {\n                    const value = syncMethodEnum[k];\n                    dataflow[name + ':' + value] = 1;\n                }\n            }\n        } else {\n            dataflow[name + ':' + syncMethodEnum.read] = 1;\n        }\n    }\n\n    /**\n     * Retrieves the endpoint by the given name.\n     */\n    getEndPoint(name: string, ignoreCache?: boolean) {\n        const cache = this._cache;\n        const uniqueName = this._uniqueNamePrefix + name;\n\n        if (ignoreCache !== true) {\n            const cachedValue = cache.get(uniqueName);\n            if (cachedValue) {\n                return cachedValue;\n            }\n        }\n\n        const cfgMapping = this.configurationMapping;\n\n        const cfg = cfgMapping[uniqueName];\n        if (!cfg) {\n            const error = new Error('No given endpoint is defined for: ' + name);\n            throw error;\n        }\n\n        let value = null;\n        if (cfg.tag === endPointEnum.model) {\n            value = backbone.Model.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.collection) {\n            value = backbone.Collection.extend(cfg.options);\n        } else if (cfg.tag === endPointEnum.pagedCollection) {\n            value = backbone.PageableCollection.extend(cfg.options);\n        } else {\n            throw new Error('Not implemented');\n        }\n\n        if (ignoreCache !== true) {\n            cache.set(uniqueName, value, defaultLivePeroid);\n        }\n        return value;\n    }\n\n    /**\n     * Get the underlying configuration for an endpoint.\n     */\n    getConfiguration(endPointKey: string) {\n        const uniqueName = this._uniqueNamePrefix + endPointKey;\n        const cfgMapping = this.configurationMapping;\n        return cfgMapping[uniqueName];\n    }\n\n    /**\n     * Provides the callback when some operations happen.\n     */\n    addWhenCallback(name: string[], callback: any) {\n        const dataflow = this._dataflow;\n        dataflow.when(name, callback);\n    }\n\n    /**\n     * Defines the dependency.\n     */\n    addDependency(src: string, dst: string) {\n        const dataflow = this._dataflow;\n        dataflow.on(src, function() {\n            dataflow[dst] = dataflow[dst] + 1;\n        });\n    }\n\n    /**\n     * Clean up all cached data provider\n     */\n    cleanupCache() {\n        // Remove what we have in cache\n        this._cache.reset();\n    }\n\n    cleanMountedFeatures() {\n        mountedFeatureRemovers.forEach(function(remover) {\n            remover.remove();\n        });\n        mountedFeatureRemovers.length = 0;\n    }\n\n    /**\n     * Destroy the provider to release resources\n     */\n    destroy() {\n        // Delete cache\n        this._myEndPointKeys.forEach(function(k) {\n            delete globalConfigurationMapping[k];\n        });\n\n        this._myEndPointKeys.length = 0;\n\n        this._cache.destroy();\n\n        // No destroy methods for the following two instances.\n        this._cache = null;\n        this._dataflow = null;\n        this._host = null;\n        this._uniqueNamePrefix = null;\n    }\n}\n\n\n\n","/**\n * @fileOverview\n * Provides type-safety operations of manipulating LocalStorage data.\n * @name LocalStorageUtil.js\n * @module hypercom/storage/LocalStorageUtil\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\nimport * as externalInterface from '@polpware/fe-dependencies';\n// as polyfill for localstorage\n// Do NOT use the LocalStorage as there is global variable which cannot be resolved\n// and which is defined only in TINYMCE.\n// import * as localStorage from 'polpware-tinymce-tailor/src/util/LocalStorage.js';\n\nconst globalLocalStorage = window.localStorage;\n\nimport {\n    defaultValue,\n    ITypeDef,\n    tyArray,\n    ok as isType\n} from '@polpware/fe-utilities';\n\nconst _ = externalInterface.underscore,\n    find = _.find,\n    findIndex = _.findIndex,\n    union = _.union;\n\nexport interface IEntity {\n    Id: any;\n}\n\n/**\n * Reads the value of an entity by its key.\n * @function getEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n * @returns {*} The entity value.\n */\n\nexport function getEntity(key: string, ty: ITypeDef): any {\n    let data = defaultValue(ty);\n    try {\n        let tmp = globalLocalStorage.getItem(key);\n        if (tmp && tmp !== 'undefined') {\n            tmp = JSON.parse(tmp);\n            if (isType(tmp, ty)) {\n                data = tmp;\n            }\n        }\n    } catch (ex) {\n        console.log(ex);\n    }\n    return data;\n}\n/**\n * Updates the value of an entity by its key.\n * @function updateEntity\n * @param {String} key The entity key.\n * @param {*} data The new value to be replaced with.\n * @param {*} ty The type of the entity value.\n */\nexport function updateEntity(key: string, data: any, ty: ITypeDef = null) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(data));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Cleans the value of an entity by its key.\n * @function cleanEntity\n * @param {String} key The entity key.\n * @param {*} ty The type of the entity value.\n */\nexport function cleanEntity(key: string, ty: ITypeDef) {\n    try {\n        globalLocalStorage.setItem(key, JSON.stringify(defaultValue(ty)));\n    } catch (ex) {\n        console.log(ex);\n    }\n}\n/**\n * Inserts the given data into the value of an entity of type array.\n * Note that the inserted data should be disjoint with the current data\n * stored in this entity. Otherwise, the behavior may be undefined.\n * @function insertEntities\n * @param {String} key The entity key.\n * @param {Array} data The value to be inserted.\n * @param {Number} upperBound The max number of elements allows for this entity value.\n */\nexport function insertEntities(key: string, data: Array<IEntity>, upperBound: number) {\n    let newData = [];\n    const currentData = getEntity(key, tyArray) as Array<IEntity>;\n    if (upperBound > 0 && currentData.length > upperBound) {\n        newData = data;\n    } else {\n        newData = union(currentData, data);\n    }\n    updateEntity(key, newData, tyArray);\n}\n/**\n * Finds one element of an entity of type array.\n * @function findEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value. An Id field is assumed for each element.\n * @returns {*} The value of the found element.\n */\nexport function findEntityById(key: string, id): IEntity {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    return find(data, { Id: id });\n}\n\n/**\n * Removes an element of an entity of type array.\n * @function removeEntityById\n * @param {String} key The entity key.\n * @param {Number} id The identifier value for the element to be removed.\n */\nexport function removeEntityById(key: string, id) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: id });\n    if (index === -1) {\n        return;\n    }\n    data.splice(index, 1);\n    updateEntity(key, data, tyArray);\n}\n/**\n * Inserts or udpates an element of an entity of type array.\n * @function insertOrUpdateEntity\n * @param {String} key The entity key.\n * @param {Array} entity The new value of the entity.\n */\nexport function insertOrUpdateEntity(key: string, entity: IEntity) {\n    const data = getEntity(key, tyArray) as Array<IEntity>;\n    const index = findIndex(data, { Id: entity.Id });\n    if (index !== -1) {\n        data[index] = entity;\n    } else {\n        data.push(entity);\n    }\n    updateEntity(key, data, tyArray);\n}\n/**\n * Removes a group of entities by a given prefix.\n * @function cleanEntityGroup\n * @param {String} prefix The prefix of the keys of the entities to be removed. We organize entities somewhat hirarchly.\n * @returns {Boolean}\n */\nexport function cleanEntityGroup(prefix: string): Array<string> {\n    const keys = [];\n    for (const p in globalLocalStorage) {\n        if (globalLocalStorage.hasOwnProperty(p) &&\n            p.indexOf(prefix) === 0) {\n            keys.push(p);\n        }\n    }\n    if (keys.length === 0) {\n        return keys;\n    }\n    keys.forEach(function(k) {\n        globalLocalStorage.removeItem(k);\n    });\n    return keys;\n}\n","/**\n * @fileOverview\n * Encapsulates the local storage service into one\n * providing prmoise-aware services.\n * @name LocalStorageTable.js\n * @module hypercom/storage/LocalStorageTable\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as polpwareUtil from '@polpware/fe-utilities';\n\nimport * as localStorageUtil from './localstorage-util';\n\n/**\n * @class LocalStorageTable\n */\nexport class LocalStorageTable {\n\n    /**\n     * Gets the value for the given key.\n     * @function getP\n     * @param {String} key The key to be searched for.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    getP(key: string): PromiseLike<object> {\n        const data = localStorageUtil.getEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(data, null);\n    }\n\n    /**\n     * Removes the key from the keychain.\n     * @function removeP\n     * @param {String} key The key to be removed.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    removeP(key: string): PromiseLike<boolean> {\n        localStorageUtil.cleanEntity(key, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n    /**\n     * Updates the value for the given key.\n     * @param {String} key The key to be searched for.\n     * @param {Object} value The new value.\n     * @returns {Promise}\n     * @throws {Error}\n     */\n    updateP(key: string, value: object): PromiseLike<boolean> {\n        localStorageUtil.updateEntity(key, value, polpwareUtil.tyObject);\n        return polpwareUtil.lift(true, null);\n    }\n\n}\n","/**\n * @fileOverview\n * Provides i18n service. This module is designed as\n * a delegate of the tinymce I18n service.\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\nimport * as dependencies from '@polpware/fe-dependencies';\n\nconst _i18n = dependencies.I18n;\n\nexport class I18n {\n\n    static getDictByCode(code: string) {\n        return _i18n.data[code];\n    }\n\n    /**\n     * Add a languge dictionary and set the current\n     * code as the current language.\n     */\n    static add(code: string, items: any) {\n        _i18n.add(code, items);\n    }\n\n    /**\n     * Trnsaltes a given text. If the given text\n     * is missing in the dictionary, use the given default value.\n     * @function translate\n     * @param {String} text A text to be translated.\n     * @param {String} defaultText The default value.\n     * @returns {String} The translation for the given text.\n     */\n    static translate(text: string, defaultText: string) {\n        const value = _i18n.translate(text);\n        if (value === text && defaultText) {\n            return defaultText;\n        }\n        return value;\n    }\n\n    /**\n     * Removes unused languages to release memory.\n     * @function recycleOthers\n     * @param {String} code The language code which should not released.\n     */\n    static recycleOthers(code: string) {\n        const data = _i18n.data;\n        const recycleList = [];\n        for (const key in data) {\n            // skip loop if the property is from prototype\n            if (data.hasOwnProperty(key) && key !== code) {\n                recycleList.push(key);\n            }\n        }\n        /*jslint plusplus: true */\n        for (let i = 0; i < recycleList.length; i++) {\n            const k = recycleList[i];\n            delete data[k];\n        }\n    }\n}\n","/**\n * @fileOverview\n * Defines a Resources class.\n * With this class, you may configure a bunch of resources\n * accessible from global URIs, such as URLs.\n * Once the requested resources are loaded, they may be\n * cached in the memory.\n * Note that the resources are expected to be organized in\n * a common namespace hierarchy.\n * E.g.,\n * x.y.z corresponds to a json resource like:\n *    {\n *       y: {\n *             z: 112\n *          }\n *    }\n * @author Xiaolong Tang <xxlongtang@gmail.com>\n * @license Copyright @me\n */\n\n\nimport * as externalInterface from '@polpware/fe-dependencies';\nimport { replace, lift, convert } from '@polpware/fe-utilities';\n\nimport { ISlidingExpireCache } from '../cache/sliding-expire-cache.interface';\n\nimport { loadJsonUriP } from '../net/curl';\n\n\nconst _ = externalInterface.underscore;\nconst isString = _.isString;\n\n\n/**\n * Retrieves a value from a variable by a given namespace nested structure.\n * @function getByNamespace\n * @param {Object} repo\n * @param {*} fullyQualifiedNamespace A string or an arry of string defining the namespace.\n * @param {Number}[] startLevel\n * @returns {*}\n */\nfunction getByNamespace<T>(repo: { [key: string]: T },\n    identifiers: Array<string>,\n    startLevel: number = 1): T {\n\n    const restIdentifiers = identifiers.slice(startLevel);\n    const restKey = restIdentifiers.join('.');\n    if (repo[restKey]) {\n        return repo[restKey];\n    }\n\n    let initRepo: any = repo;\n    for (let index = startLevel; index < identifiers.length; index++) {\n        if (!initRepo) {\n            break;\n        }\n        const key = identifiers[index];\n        initRepo = initRepo[key];\n    }\n    return initRepo;\n}\n\ninterface IConfigurationEntry {\n    uri: string;\n    liveSeconds: number;\n}\n\n/**\n * @class Resources\n */\nexport class ResourceLoader {\n\n    private _configuration: { [key: string]: IConfigurationEntry };\n\n    /**\n     * Constructor\n     * @function init\n     */\n    constructor(private _cache: ISlidingExpireCache<any> = null) {\n        this._configuration = {};\n    }\n\n    /**\n     * Configure a resource\n     * @function register\n     * @param {String} key The resource key.\n     * @param {String} uri The resource URI.\n     * @param {Number} liveSeconds The cache period.\n     * @throws {Error}\n     */\n    register(key: string, uri: string, liveSeconds: number = 60) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            throw new Error('Registering an existing resource key: ' + key);\n        }\n        configuration[key] = {\n            uri: uri,\n            liveSeconds: liveSeconds\n        };\n    }\n\n    /**\n     * Removes a registered item\n     * @function undoRegister\n     * @param {String} key The resource key to be removed.\n     */\n    undoRegister(key: string) {\n        const configuration = this._configuration;\n        if (configuration[key]) {\n            delete configuration[key];\n        }\n    }\n    /**\n     * Returns a promise for the resource key.\n     * @function getPromise\n     * @param {String} fullyQualifiedNamespace The resource key.\n     * @returns {*} The resource value.\n     * @throws {Error}\n     */\n    getPromise<T>(fullyQualifiedNamespace: string,\n        convertor: (any) => any): PromiseLike<T> {\n        const identifiers = fullyQualifiedNamespace.split('.');\n        const topIdentifier = identifiers[0];\n        const cache = this._cache;\n        if (cache) {\n            // Figure out the master key\n            const repo = cache.get(topIdentifier, 60);\n            if (repo) {\n                const value = getByNamespace<T>(repo, identifiers);\n                if (value) {\n                    // Return a promise\n                    return lift(value, null);\n                }\n            }\n        }\n\n        const entry = this._configuration[topIdentifier];\n        if (!entry) {\n            throw new Error('Get unregistered resource: ' + topIdentifier);\n        }\n\n        // Otherwise, load it\n        return loadJsonUriP(entry.uri).then((content) => {\n            content = convertor(content);\n            // Cache the new value\n            if (cache) {\n                cache.set(topIdentifier, content, entry.liveSeconds);\n            }\n            return getByNamespace(content, identifiers);\n        });\n    }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":["dependencies.backbone","dependencies.underscore","dependencies.constraintjs","backbone","dependencies.XHR","_","dependencies.Tools","dependencies.jquery","dependencies.EventDispatcher","dependencies.locache","dependencies.meld","$","fromCollection.reducer","ngrxStore.ActionsSubject","ngrxStore.ScannedActionsSubject","ngrxStore.combineReducers","ngrxStore.ReducerManager","reducerIndex.buildInitialState","reducerIndex.buildReducerMap","ngrxStore.State","ngrxStore.Store","dependencies.when","meld","dependencies['dataflow']","dependencies['backbone']","externalInterface.underscore","isType","localStorageUtil.getEntity","polpwareUtil.tyObject","polpwareUtil.lift","localStorageUtil.cleanEntity","localStorageUtil.updateEntity","dependencies.I18n"],"mappings":"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"}